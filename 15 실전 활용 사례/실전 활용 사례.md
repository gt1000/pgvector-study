# 온프레미스 RAG 시스템 기본 설계서

## 해경 수색구조 · 해양수산/양식 도메인 / Python 중심

---

## 문서 개요

| 항목 | 내용 |
|------|------|
| **문서 목적** | 온프레미스 RAG 시스템의 기본 설계 및 기술 스택 결정 |
| **문서 범위** | 아키텍처 설계, 기술 선정, 컴포넌트 역할 정의 |
| **문서 수준** | 기본 설계 (상세 설계/소스 레벨 아님) |
| **대상 독자** | 프로젝트 관리자, 아키텍트, 개발 리드 |

---

# 1. 최종 솔루션 결정

## 1.1 기술 스택 최종 선정

| 계층 | 선정 기술 | 선정 이유 |
|------|----------|----------|
| **LLM 서빙** | **Ollama** (초기) → vLLM (확장) | 설치 용이, OpenAI API 호환, 폐쇄망 구동 |
| **LLM 모델** | **Qwen2.5-7B-Instruct** | 한국어 성능 우수, Apache 2.0 라이선스, 16GB VRAM |
| **임베딩 모델** | **bge-m3** | 다국어 지원, Dense+Sparse 하이브리드, 검색 품질 최상 |
| **RAG 프레임워크** | **LlamaIndex** | 문서 인입/인덱싱/검색 특화, 하이브리드 검색 내장 |
| **워크플로우 엔진** | **LangGraph** | 상태 기반 흐름 제어, 조건 분기/재시도 구현 |
| **벡터 데이터베이스** | **pgvector** (PostgreSQL) | 기존 DB 인프라 활용, ACID 보장, 운영 도구 성숙 |
| **API 프레임워크** | **FastAPI** | 비동기 지원, 자동 문서화, Python 생태계 |
| **문서 파싱** | **PyMuPDF + pyhwp** | PDF/HWP 처리, OCR 폴백 지원 |

---

## 1.2 최종 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              사용자 계층                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │   Web Browser   │  │  Mobile App     │  │  API Client     │             │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘             │
└───────────┼─────────────────────┼─────────────────────┼─────────────────────┘
            │                     │                     │
            └─────────────────────┼─────────────────────┘
                                  │ HTTPS
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            API Gateway 계층                                  │
│                                                                             │
│                         ┌─────────────────┐                                 │
│                         │    FastAPI      │                                 │
│                         │  (rag-api)      │                                 │
│                         ├─────────────────┤                                 │
│                         │ • 인증/인가      │                                 │
│                         │ • 요청 검증      │                                 │
│                         │ • Rate Limiting │                                 │
│                         │ • 로깅/감사      │                                 │
│                         └────────┬────────┘                                 │
└──────────────────────────────────┼──────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           애플리케이션 계층                                   │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                      LangGraph 워크플로우 엔진                         │  │
│  │                                                                      │  │
│  │   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐         │  │
│  │   │ Query   │───▶│Retrieve │───▶│Evidence │───▶│Generate │         │  │
│  │   │ Router  │    │         │    │ Check   │    │ Answer  │         │  │
│  │   └─────────┘    └─────────┘    └────┬────┘    └─────────┘         │  │
│  │                                      │                              │  │
│  │                              부족 시 │ 재검색                        │  │
│  │                                      ▼                              │  │
│  │                               ┌─────────┐                           │  │
│  │                               │Re-search│                           │  │
│  │                               └─────────┘                           │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌────────────────────────┐         ┌────────────────────────┐            │
│  │      LlamaIndex        │         │    Ingest Worker       │            │
│  │    (검색/리트리버)       │         │    (문서 처리)          │            │
│  ├────────────────────────┤         ├────────────────────────┤            │
│  │ • 하이브리드 검색        │         │ • 문서 로드/파싱        │            │
│  │ • 벡터 + BM25          │         │ • 텍스트 추출/정제      │            │
│  │ • 재랭킹 (선택)         │         │ • 청킹/메타데이터       │            │
│  │ • 컨텍스트 구성         │         │ • 임베딩 생성          │            │
│  └───────────┬────────────┘         └───────────┬────────────┘            │
└──────────────┼──────────────────────────────────┼────────────────────────────┘
               │                                  │
               ▼                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             데이터 계층                                      │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         PostgreSQL + pgvector                        │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │   │
│  │  │  문서 청크       │  │  문서 메타데이터  │  │  질의 로그       │      │   │
│  │  │  (벡터 인덱스)   │  │                 │  │  (감사)         │      │   │
│  │  │  HNSW Index     │  │                 │  │                 │      │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            모델 서빙 계층                                    │
│                                                                             │
│  ┌─────────────────────────────┐    ┌─────────────────────────────┐        │
│  │         Ollama              │    │         Ollama              │        │
│  │      (LLM 서버)              │    │     (임베딩 서버)            │        │
│  ├─────────────────────────────┤    ├─────────────────────────────┤        │
│  │  Qwen2.5-7B-Instruct        │    │  bge-m3                     │        │
│  │  • OpenAI API 호환           │    │  • 1024 차원                │        │
│  │  • GPU: RTX 4090 (24GB)     │    │  • CPU/GPU 선택 가능         │        │
│  └─────────────────────────────┘    └─────────────────────────────┘        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 1.3 컴포넌트별 기술 매핑

```
┌────────────────────────────────────────────────────────────────────┐
│                        기술 스택 매핑                               │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  [사용자 요청]                                                      │
│       │                                                            │
│       ▼                                                            │
│  ┌─────────────────────────────────────────────────────────┐      │
│  │ FastAPI                                                  │      │
│  │ • 엔드포인트: /api/v1/chat, /api/v1/docs                 │      │
│  │ • 인증: JWT / API Key                                    │      │
│  └─────────────────────────────────────────────────────────┘      │
│       │                                                            │
│       ▼                                                            │
│  ┌─────────────────────────────────────────────────────────┐      │
│  │ LangGraph (워크플로우)                                    │      │
│  │ • 질문 분류 → 검색 → 근거 확인 → 답변 생성                  │      │
│  │ • 조건 분기: 근거 부족 시 재검색                            │      │
│  │ • 최대 재시도: 2회                                        │      │
│  └─────────────────────────────────────────────────────────┘      │
│       │                                                            │
│       ▼                                                            │
│  ┌─────────────────────────────────────────────────────────┐      │
│  │ LlamaIndex (검색)                                        │      │
│  │ • VectorStoreIndex + pgvector                           │      │
│  │ • 하이브리드: 벡터 검색 + BM25 키워드 검색                  │      │
│  │ • Top-K: 10개 청크 검색                                   │      │
│  └─────────────────────────────────────────────────────────┘      │
│       │                                                            │
│       ▼                                                            │
│  ┌─────────────────────────────────────────────────────────┐      │
│  │ Ollama (LLM 호출)                                        │      │
│  │ • 모델: Qwen2.5-7B-Instruct                              │      │
│  │ • API: http://localhost:11434/v1/chat/completions       │      │
│  │ • 스트리밍 응답 지원                                       │      │
│  └─────────────────────────────────────────────────────────┘      │
│       │                                                            │
│       ▼                                                            │
│  [응답 반환 + 출처]                                                 │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

---

## 1.4 배포 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           온프레미스 서버 구성                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        서버 1: 애플리케이션                           │   │
│  │                        (CPU 서버)                                    │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │   │
│  │  │  rag-api    │  │ ingest-     │  │ PostgreSQL  │                  │   │
│  │  │  (FastAPI)  │  │ worker      │  │ + pgvector  │                  │   │
│  │  │  Port:8000  │  │             │  │ Port:5432   │                  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                  │   │
│  │                                                                      │   │
│  │  • CPU: 16 Core 이상                                                 │   │
│  │  • RAM: 64GB 이상                                                    │   │
│  │  • Storage: SSD 1TB 이상                                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      │ 내부 네트워크                         │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        서버 2: 모델 서빙                              │   │
│  │                        (GPU 서버)                                    │   │
│  │  ┌─────────────────────────┐  ┌─────────────────────────┐           │   │
│  │  │      Ollama (LLM)       │  │   Ollama (Embedding)    │           │   │
│  │  │   Qwen2.5-7B-Instruct   │  │       bge-m3            │           │   │
│  │  │      Port:11434         │  │      Port:11435         │           │   │
│  │  └─────────────────────────┘  └─────────────────────────┘           │   │
│  │                                                                      │   │
│  │  • GPU: RTX 4090 24GB (또는 A100 40GB)                               │   │
│  │  • CPU: 8 Core 이상                                                  │   │
│  │  • RAM: 32GB 이상                                                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ※ 소규모 환경에서는 단일 서버에 통합 구성 가능                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 1.5 단일 서버 구성 (소규모)

소규모 환경에서는 GPU 서버 1대로 통합 가능:

```
┌─────────────────────────────────────────────────────────────────┐
│                    단일 서버 통합 구성                           │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                    Docker Compose                         │ │
│  │                                                           │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │ │
│  │  │rag-api  │ │ingest-  │ │postgres │ │ ollama  │        │ │
│  │  │ :8000   │ │worker   │ │ :5432   │ │ :11434  │        │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘        │ │
│  │                                                           │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  하드웨어 요구사항:                                              │
│  • GPU: RTX 4090 24GB                                          │
│  • CPU: 16 Core                                                │
│  • RAM: 64GB                                                   │
│  • Storage: SSD 1TB                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

# 2. 기술 선정 근거

## 2.1 LLM 서빙: Ollama 선정 이유

| 후보 | 장점 | 단점 | 평가 |
|------|------|------|------|
| **Ollama** | 설치 간편, OpenAI 호환, 모델 전환 쉬움 | 동시성 제한적 | ✅ **선정** |
| vLLM | 고성능, 높은 처리량 | 설치 복잡, GPU 필수 | 확장 시 고려 |
| TGI | HuggingFace 생태계 | 설정 복잡 | 대안 |
| LM Studio | GUI 편리 | headless 불가 | PoC용 |

**선정 결정**:
- 초기 구축은 **Ollama**로 빠르게 시작
- 사용자 10명 이상 확장 시 **vLLM** 마이그레이션 검토

---

## 2.2 RAG 프레임워크: LlamaIndex 선정 이유

| 후보 | 장점 | 단점 | 평가 |
|------|------|------|------|
| **LlamaIndex** | 인덱싱/검색 특화, 하이브리드 검색 내장 | 에이전트 기능 약함 | ✅ **선정** |
| LangChain | 범용성, 에이전트 강점 | 인덱싱 기능 수동 구성 | 부분 활용 |
| Haystack | 검색 특화 | 커뮤니티 작음 | 대안 |

**선정 결정**:
- 문서 인입/검색은 **LlamaIndex** 중심
- 툴/에이전트 필요 시 **LangChain** 부분 활용

---

## 2.3 워크플로우: LangGraph 선정 이유

| 요구사항 | LangGraph 지원 |
|----------|---------------|
| 질문 분류 후 조건 분기 | ✅ conditional_edges |
| 근거 부족 시 재검색 | ✅ 루프/재시도 |
| 최대 재시도 제한 | ✅ 상태 기반 카운터 |
| 근거 없으면 거절 응답 | ✅ 정책 노드 |

**선정 결정**: 환각 방지와 품질 향상을 위해 **LangGraph 필수**

---

## 2.4 벡터DB: pgvector 선정 이유

| 후보 | 장점 | 단점 | 평가 |
|------|------|------|------|
| **pgvector** | PostgreSQL 확장, ACID 보장, 운영 도구 성숙 | 대규모 확장성 제한 | ✅ **선정** |
| Milvus | 분산 확장성 | 운영 복잡 | 대규모 시 고려 |
| Qdrant | 고성능, 필터링 강력 | 별도 인프라 | 대안 |
| Chroma | 경량, 간편 | 프로덕션 부적합 | PoC용 |

**선정 결정**:
- 기존 PostgreSQL DBA 역량 활용
- 하이브리드 검색(벡터 + 메타데이터 필터) 용이

---

## 2.5 임베딩 모델: bge-m3 선정 이유

| 후보 | 차원 | 한국어 | 특징 | 평가 |
|------|------|--------|------|------|
| **bge-m3** | 1024 | ⭐⭐⭐⭐⭐ | Dense+Sparse 하이브리드 | ✅ **선정** |
| multilingual-e5-large | 1024 | ⭐⭐⭐⭐ | 다국어 강점 | 대안 |
| KoSimCSE | 768 | ⭐⭐⭐⭐ | 한국어 특화 | 대안 |

**선정 결정**:
- 한국어 법령/지침 문서 검색 품질 우수
- 하이브리드 검색 기본 지원

> ⚠️ **주의**: 임베딩 모델 변경 시 전체 재인덱싱 필요. 신중하게 선정.

---

## 2.6 LLM 모델: Qwen2.5-7B 선정 이유

| 후보 | 파라미터 | VRAM | 한국어 | 라이선스 | 평가 |
|------|---------|------|--------|---------|------|
| **Qwen2.5-7B-Instruct** | 7B | 16GB | ⭐⭐⭐⭐ | Apache 2.0 | ✅ **선정** |
| EXAONE-3.5-7.8B | 7.8B | 18GB | ⭐⭐⭐⭐⭐ | 상업 무료 | 대안 (한국어 최우선 시) |
| Llama-3.1-8B | 8B | 18GB | ⭐⭐⭐ | Llama License | 대안 |

**선정 결정**:
- 한국어 성능과 라이선스 균형
- RTX 4090 1장으로 구동 가능

---

# 3. 시스템 컴포넌트 정의

## 3.1 서비스 구성

| 서비스 | 역할 | 기술 스택 | 실행 방식 |
|--------|------|----------|----------|
| **rag-api** | 질의응답 API 서버 | FastAPI + LangGraph + LlamaIndex | 상시 실행 |
| **ingest-worker** | 문서 처리 배치 | Python + Celery (선택) | 배치/이벤트 |
| **postgres** | 데이터 저장 | PostgreSQL 16 + pgvector 0.7 | 상시 실행 |
| **ollama** | 모델 서빙 | Ollama 0.3+ | 상시 실행 |

---

## 3.2 rag-api 컴포넌트 구조

```
rag-api/
├── api/                 # HTTP 엔드포인트
│   ├── chat.py          # POST /api/v1/chat - 질의응답
│   ├── docs.py          # GET /api/v1/docs - 문서 조회
│   └── health.py        # GET /health - 상태 확인
│
├── rag/
│   ├── graph/           # LangGraph 워크플로우
│   │   ├── workflow.py  # 메인 그래프 정의
│   │   └── nodes/       # 각 단계 노드
│   │       ├── route_query.py      # 질문 분류
│   │       ├── retrieve.py         # 검색 실행
│   │       ├── evidence_check.py   # 근거 확인
│   │       ├── synthesize.py       # 답변 생성
│   │       └── format_citations.py # 출처 정리
│   │
│   ├── retrieval/       # 검색 모듈 (LlamaIndex)
│   │   ├── retriever.py    # 벡터 검색
│   │   ├── hybrid.py       # 하이브리드 검색
│   │   └── reranker.py     # 재랭킹 (선택)
│   │
│   └── prompts/         # 도메인별 프롬프트 템플릿
│       ├── sar.yaml
│       ├── law.yaml
│       └── aquaculture.yaml
│
├── llm/                 # 모델 클라이언트
│   ├── client.py        # Ollama LLM 호출
│   └── embeddings.py    # Ollama 임베딩 호출
│
├── store/               # 데이터 접근
│   └── pgvector_store.py
│
└── policy/              # 안전장치
    └── refusal.py       # 근거 없으면 거절
```

---

## 3.3 ingest-worker 컴포넌트 구조

```
ingest-worker/
├── pipeline/
│   ├── ingest_job.py    # 메인 파이프라인
│   └── steps/
│       ├── load_document.py     # 문서 로드
│       ├── extract_text.py      # 텍스트 추출
│       ├── clean_text.py        # 텍스트 정제
│       ├── chunk_text.py        # 청킹
│       ├── extract_metadata.py  # 메타데이터 추출
│       ├── embed_chunks.py      # 임베딩 생성
│       └── upsert_store.py      # DB 저장
│
├── parsers/             # 문서 포맷별 파서
│   ├── pdf.py           # PyMuPDF
│   ├── hwp.py           # pyhwp + LibreOffice 폴백
│   ├── docx.py          # python-docx
│   └── ocr.py           # Tesseract (스캔 문서)
│
└── chunking/
    └── policy.py        # 청킹 정책 (800자, 200자 오버랩)
```

---

## 3.4 데이터베이스 스키마 (개념)

```
┌─────────────────────────────────────────────────────────────────┐
│                         PostgreSQL                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  documents (문서 메타데이터)                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ id          │ UUID        │ PK                          │   │
│  │ filename    │ VARCHAR     │ 원본 파일명                  │   │
│  │ title       │ VARCHAR     │ 문서 제목                   │   │
│  │ category    │ VARCHAR     │ SAR/법령/양식/장비          │   │
│  │ created_at  │ TIMESTAMP   │ 등록일                      │   │
│  │ source_hash │ VARCHAR     │ 중복 체크용                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  chunks (문서 청크 + 벡터)                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ id          │ UUID        │ PK                          │   │
│  │ document_id │ UUID        │ FK → documents              │   │
│  │ content     │ TEXT        │ 청크 텍스트                  │   │
│  │ embedding   │ VECTOR(1024)│ bge-m3 임베딩               │   │
│  │ page_number │ INTEGER     │ 페이지 번호                  │   │
│  │ section     │ VARCHAR     │ 조항/섹션 번호               │   │
│  │ chunk_index │ INTEGER     │ 청크 순서                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  query_logs (질의 로그/감사)                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ id          │ UUID        │ PK                          │   │
│  │ question    │ TEXT        │ 사용자 질문                  │   │
│  │ answer      │ TEXT        │ 생성된 답변                  │   │
│  │ citations   │ JSONB       │ 참조 문서 목록               │   │
│  │ user_id     │ VARCHAR     │ 사용자 식별                  │   │
│  │ created_at  │ TIMESTAMP   │ 질의 시간                   │   │
│  │ latency_ms  │ INTEGER     │ 응답 시간                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  인덱스:                                                        │
│  • chunks.embedding → HNSW (벡터 검색)                          │
│  • chunks.content → GIN (전문 검색/BM25)                        │
│  • documents.category → BTREE (필터링)                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

# 4. 핵심 처리 흐름

## 4.1 질의응답 흐름 (Query Flow)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            질의응답 처리 흐름                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [1] 사용자 질문 수신                                                        │
│      "조난 신호 수신 시 초동 조치 절차는?"                                     │
│                          │                                                  │
│                          ▼                                                  │
│  [2] 질문 분류 (Query Router)                                               │
│      ┌─────────────────────────────────────────┐                           │
│      │ LLM이 질문 분석하여 카테고리 결정         │                           │
│      │ → "SAR" 카테고리로 분류                  │                           │
│      └─────────────────────────────────────────┘                           │
│                          │                                                  │
│                          ▼                                                  │
│  [3] 문서 검색 (Retrieve)                                                   │
│      ┌─────────────────────────────────────────┐                           │
│      │ 하이브리드 검색 실행                      │                           │
│      │ • 벡터 검색: 의미적 유사도                │                           │
│      │ • BM25: 키워드 매칭                      │                           │
│      │ • 카테고리 필터: category='SAR'          │                           │
│      │ → Top 10개 청크 반환                     │                           │
│      └─────────────────────────────────────────┘                           │
│                          │                                                  │
│                          ▼                                                  │
│  [4] 근거 확인 (Evidence Check)                                             │
│      ┌─────────────────────────────────────────┐                           │
│      │ 검색 결과 품질 평가                       │                           │
│      │ • 최고 유사도 점수 확인                   │                           │
│      │ • 관련 청크 개수 확인                     │                           │
│      │                                         │                           │
│      │ 기준: score > 0.7 AND count >= 3        │                           │
│      └─────────────────────────────────────────┘                           │
│                          │                                                  │
│              ┌───────────┴───────────┐                                     │
│              │                       │                                     │
│         충분함 ▼                  부족함 ▼                                   │
│                               ┌─────────────────────┐                      │
│                               │ [4-1] 재검색         │                      │
│                               │ • 질의 확장          │                      │
│                               │ • 다른 카테고리 검색  │                      │
│                               │ • 최대 2회 재시도    │                      │
│                               └──────────┬──────────┘                      │
│                                          │                                 │
│                                          ▼                                 │
│                               재시도 초과 시 → [6] 거절 응답                  │
│              │                                                              │
│              ▼                                                              │
│  [5] 답변 생성 (Generate Answer)                                            │
│      ┌─────────────────────────────────────────┐                           │
│      │ 프롬프트 구성                            │                           │
│      │ • 시스템: 도메인별 지침 (SAR 프롬프트)    │                           │
│      │ • 컨텍스트: 검색된 문서 청크              │                           │
│      │ • 질문: 사용자 원본 질문                  │                           │
│      │                                         │                           │
│      │ LLM 호출 → 답변 생성                     │                           │
│      └─────────────────────────────────────────┘                           │
│                          │                                                  │
│                          ▼                                                  │
│  [6] 출처 정리 (Format Citations)                                           │
│      ┌─────────────────────────────────────────┐                           │
│      │ 참조 문서 포맷팅                         │                           │
│      │ • 문서명: "수색구조 매뉴얼"              │                           │
│      │ • 페이지: p.45                          │                           │
│      │ • 조항: 제3조 2항                        │                           │
│      └─────────────────────────────────────────┘                           │
│                          │                                                  │
│                          ▼                                                  │
│  [7] 응답 반환                                                              │
│      {                                                                     │
│        "answer": "조난 신호 수신 시 초동 조치 절차는...",                    │
│        "citations": [                                                      │
│          {"doc": "수색구조 매뉴얼", "page": 45, "section": "3.2"}          │
│        ],                                                                  │
│        "confidence": 0.85                                                  │
│      }                                                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4.2 문서 인입 흐름 (Ingestion Flow)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            문서 인입 처리 흐름                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [1] 문서 업로드                                                             │
│      수색구조_매뉴얼.pdf                                                     │
│                          │                                                  │
│                          ▼                                                  │
│  [2] 중복 확인                                                              │
│      ┌─────────────────────────────────────────┐                           │
│      │ source_hash = SHA256(파일 내용)          │                           │
│      │ DB에서 동일 해시 존재 여부 확인            │                           │
│      │                                         │                           │
│      │ 중복 시 → 스킵 또는 업데이트 선택          │                           │
│      └─────────────────────────────────────────┘                           │
│                          │                                                  │
│                          ▼                                                  │
│  [3] 텍스트 추출                                                            │
│      ┌─────────────────────────────────────────┐                           │
│      │ 포맷별 파서 선택                         │                           │
│      │ • PDF → PyMuPDF                         │                           │
│      │ • HWP → pyhwp (실패 시 LibreOffice)     │                           │
│      │ • DOCX → python-docx                    │                           │
│      │ • 스캔 문서 → Tesseract OCR             │                           │
│      └─────────────────────────────────────────┘                           │
│                          │                                                  │
│                          ▼                                                  │
│  [4] 텍스트 정제                                                            │
│      ┌─────────────────────────────────────────┐                           │
│      │ • 헤더/푸터 제거                         │                           │
│      │ • 특수문자 정규화                        │                           │
│      │ • 불필요한 공백 제거                     │                           │
│      │ • 페이지 번호 추출                       │                           │
│      └─────────────────────────────────────────┘                           │
│                          │                                                  │
│                          ▼                                                  │
│  [5] 청킹                                                                   │
│      ┌─────────────────────────────────────────┐                           │
│      │ 청킹 정책:                               │                           │
│      │ • 청크 크기: 800자                       │                           │
│      │ • 오버랩: 200자                          │                           │
│      │ • 구분자: 문단, 조항 번호 우선            │                           │
│      │                                         │                           │
│      │ 예) 120페이지 문서 → 약 500개 청크       │                           │
│      └─────────────────────────────────────────┘                           │
│                          │                                                  │
│                          ▼                                                  │
│  [6] 메타데이터 추출                                                         │
│      ┌─────────────────────────────────────────┐                           │
│      │ 각 청크에 메타데이터 부착:                │                           │
│      │ • document_id                           │                           │
│      │ • page_number                           │                           │
│      │ • section (조항 번호)                    │                           │
│      │ • chunk_index                           │                           │
│      └─────────────────────────────────────────┘                           │
│                          │                                                  │
│                          ▼                                                  │
│  [7] 임베딩 생성                                                            │
│      ┌─────────────────────────────────────────┐                           │
│      │ Ollama 임베딩 API 호출                   │                           │
│      │ • 모델: bge-m3                          │                           │
│      │ • 출력: 1024차원 벡터                    │                           │
│      │                                         │                           │
│      │ 배치 처리: 100개씩 묶어서 호출            │                           │
│      └─────────────────────────────────────────┘                           │
│                          │                                                  │
│                          ▼                                                  │
│  [8] 벡터DB 저장                                                            │
│      ┌─────────────────────────────────────────┐                           │
│      │ pgvector에 upsert                       │                           │
│      │ • chunks 테이블에 저장                   │                           │
│      │ • HNSW 인덱스 자동 업데이트              │                           │
│      │                                         │                           │
│      │ 완료 로그 기록                           │                           │
│      └─────────────────────────────────────────┘                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

# 5. LangGraph 워크플로우 상세

## 5.1 상태 정의

```
┌─────────────────────────────────────────────────────────────────┐
│                      RAGState (상태 스키마)                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  question: str           # 사용자 원본 질문                      │
│  category: str           # 분류 결과 (SAR/법령/양식/장비/일반)    │
│  documents: List[Doc]    # 검색된 문서 청크 목록                  │
│  evidence_score: float   # 근거 품질 점수 (0.0 ~ 1.0)           │
│  evidence_enough: bool   # 근거 충분 여부                        │
│  retry_count: int        # 재검색 시도 횟수                      │
│  answer: str             # 생성된 답변                          │
│  citations: List[Dict]   # 출처 목록                            │
│  error: Optional[str]    # 에러 메시지                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5.2 워크플로우 그래프

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         LangGraph 워크플로우                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                              ┌─────────┐                                    │
│                              │  START  │                                    │
│                              └────┬────┘                                    │
│                                   │                                         │
│                                   ▼                                         │
│                           ┌──────────────┐                                  │
│                           │ route_query  │                                  │
│                           │ (질문 분류)   │                                  │
│                           └──────┬───────┘                                  │
│                                  │                                          │
│                                  ▼                                          │
│                           ┌──────────────┐                                  │
│                           │   retrieve   │                                  │
│                           │ (문서 검색)   │                                  │
│                           └──────┬───────┘                                  │
│                                  │                                          │
│                                  ▼                                          │
│                         ┌────────────────┐                                  │
│                         │ evidence_check │◄──────────────┐                  │
│                         │ (근거 확인)     │               │                  │
│                         └───────┬────────┘               │                  │
│                                 │                        │                  │
│                    ┌────────────┼────────────┐           │                  │
│                    │            │            │           │                  │
│               충분함│       부족함│       실패 │           │                  │
│                    │            │            │           │                  │
│                    ▼            ▼            ▼           │                  │
│             ┌───────────┐ ┌──────────┐ ┌──────────┐     │                  │
│             │synthesize │ │ re_search│ │  refuse  │     │                  │
│             │(답변 생성) │ │ (재검색)  │ │ (거절)   │     │                  │
│             └─────┬─────┘ └────┬─────┘ └────┬─────┘     │                  │
│                   │            │            │           │                  │
│                   │            │            │           │                  │
│                   │      retry < 2         retry >= 2   │                  │
│                   │            │            │           │                  │
│                   │            └────────────┼───────────┘                  │
│                   │                         │                               │
│                   ▼                         │                               │
│           ┌───────────────┐                 │                               │
│           │format_citation│                 │                               │
│           │ (출처 정리)    │                 │                               │
│           └───────┬───────┘                 │                               │
│                   │                         │                               │
│                   └────────────┬────────────┘                               │
│                                │                                            │
│                                ▼                                            │
│                           ┌─────────┐                                       │
│                           │   END   │                                       │
│                           └─────────┘                                       │
│                                                                             │
│  조건 분기 로직:                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ def route_after_evidence_check(state):                              │   │
│  │     if state["evidence_enough"]:                                    │   │
│  │         return "synthesize"                                         │   │
│  │     elif state["retry_count"] < 2:                                  │   │
│  │         return "re_search"                                          │   │
│  │     else:                                                           │   │
│  │         return "refuse"                                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5.3 각 노드 역할 정의

| 노드 | 입력 | 처리 | 출력 |
|------|------|------|------|
| **route_query** | question | LLM으로 질문 분류 | category |
| **retrieve** | question, category | 하이브리드 검색 실행 | documents |
| **evidence_check** | documents | 유사도 점수 평가 | evidence_enough, evidence_score |
| **re_search** | question | 질의 확장 후 재검색 | documents, retry_count++ |
| **synthesize** | question, documents | 프롬프트 구성 + LLM 호출 | answer |
| **format_citation** | documents | 출처 포맷팅 | citations |
| **refuse** | - | 거절 메시지 생성 | answer = "확인 불가" |

---

# 6. 인터페이스 정의

## 6.1 API 엔드포인트

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | `/api/v1/chat` | 질의응답 |
| GET | `/api/v1/docs` | 문서 목록 조회 |
| POST | `/api/v1/docs/upload` | 문서 업로드 |
| GET | `/api/v1/docs/{id}` | 문서 상세 조회 |
| GET | `/health` | 헬스체크 |

---

## 6.2 질의응답 API 명세

**Request:**
```
POST /api/v1/chat
Content-Type: application/json

{
  "question": "조난 신호 수신 시 초동 조치 절차는?",
  "user_id": "user123",           // 선택
  "category_hint": "SAR"          // 선택, 카테고리 힌트
}
```

**Response:**
```
{
  "answer": "조난 신호 수신 시 초동 조치 절차는 다음과 같습니다...",
  "citations": [
    {
      "document": "수색구조 매뉴얼",
      "page": 45,
      "section": "3.2",
      "relevance_score": 0.89
    }
  ],
  "metadata": {
    "category": "SAR",
    "confidence": 0.85,
    "latency_ms": 2340,
    "model": "qwen2.5-7b-instruct"
  }
}
```

---

## 6.3 Ollama API 연동 규격

**LLM 호출:**
```
POST http://localhost:11434/v1/chat/completions
Content-Type: application/json

{
  "model": "qwen2.5:7b-instruct",
  "messages": [
    {"role": "system", "content": "당신은 해경 수색구조 전문가입니다..."},
    {"role": "user", "content": "조난 신호 수신 시 초동 조치 절차는?"}
  ],
  "temperature": 0.3,
  "max_tokens": 2048
}
```

**임베딩 호출:**
```
POST http://localhost:11434/api/embeddings
Content-Type: application/json

{
  "model": "bge-m3",
  "prompt": "조난 신호 수신 절차"
}
```

---

# 7. 운영 설계

## 7.1 하드웨어 요구사항

| 구성 | 최소 사양 | 권장 사양 |
|------|----------|----------|
| **GPU** | RTX 3090 24GB | RTX 4090 24GB 또는 A100 40GB |
| **CPU** | 8 Core | 16 Core 이상 |
| **RAM** | 32GB | 64GB 이상 |
| **Storage** | SSD 500GB | SSD 1TB 이상 |
| **Network** | 1Gbps | 10Gbps (내부망) |

---

## 7.2 성능 목표

| 지표 | 목표값 | 측정 방법 |
|------|--------|----------|
| **p50 응답시간** | ≤ 3초 | API 응답 시간 |
| **p95 응답시간** | ≤ 8초 | API 응답 시간 |
| **처리량** | ≥ 5 QPS | 동시 요청 테스트 |
| **검색 정확도 (Recall@10)** | ≥ 0.90 | 평가 데이터셋 |
| **답변 충실도 (Faithfulness)** | ≥ 0.85 | 수동 평가 |
| **가용성** | 99.5% | 업타임 모니터링 |

---

## 7.3 모니터링 항목

| 구분 | 항목 | 도구 |
|------|------|------|
| **시스템** | CPU, RAM, GPU 사용률 | Prometheus + Grafana |
| **애플리케이션** | 요청 수, 응답 시간, 에러율 | FastAPI 미들웨어 |
| **모델** | 토큰 사용량, 추론 시간 | Ollama 로그 |
| **검색** | 검색 품질 점수, 히트율 | 커스텀 로깅 |
| **비즈니스** | 일일 질의 수, 카테고리별 분포 | PostgreSQL 집계 |

---

## 7.4 백업 및 복구

| 대상 | 주기 | 보관 기간 | 방법 |
|------|------|----------|------|
| PostgreSQL 전체 | 일 1회 | 30일 | pg_dump |
| 벡터 인덱스 | 주 1회 | 12주 | 테이블 덤프 |
| 설정 파일 | 변경 시 | 영구 | Git |
| 모델 파일 | 변경 시 | 이전 버전 1개 | 파일 복사 |

---

# 8. 품질 평가 계획

## 8.1 평가 데이터셋 구성

| 도메인 | 질문 수 | 예시 |
|--------|--------|------|
| SAR 절차 | 30개 | "조난 신호 수신 시 초동 조치는?" |
| 장비 운용 | 25개 | "수색정 레이더 운용 거리는?" |
| 법령/지침 | 30개 | "해양경비법 제12조 내용은?" |
| 양식/수산 | 25개 | "적조 발생 시 대응 지침은?" |
| 일반 | 10개 | "해경 조직 구조는?" |
| **총계** | **120개** | |

---

## 8.2 평가 지표

**검색 품질:**
| 지표 | 설명 | 목표 |
|------|------|------|
| Recall@5 | Top-5 내 정답 포함 비율 | ≥ 0.85 |
| Recall@10 | Top-10 내 정답 포함 비율 | ≥ 0.92 |
| MRR | 정답 순위 역수 평균 | ≥ 0.70 |

**생성 품질:**
| 지표 | 설명 | 목표 |
|------|------|------|
| Faithfulness | 근거에 충실한 답변 비율 | ≥ 0.90 |
| Relevance | 질문에 적절한 답변 비율 | ≥ 0.85 |
| Citation Coverage | 출처 포함 비율 | ≥ 0.95 |

---

# 9. 폐쇄망 설치 가이드

## 9.1 사전 준비물 (외부망에서 다운로드)

```
준비물 체크리스트:
□ Python 패키지 (.whl 파일)
  - langchain, langchain-core, langchain-community
  - langgraph
  - llama-index, llama-index-core
  - fastapi, uvicorn
  - psycopg2-binary, pgvector
  - sentence-transformers

□ LLM 모델 파일
  - qwen2.5-7b-instruct-q4_k_m.gguf (약 4.5GB)
  
□ 임베딩 모델 파일
  - bge-m3 (약 2.2GB)

□ Ollama 바이너리
  - ollama-linux-amd64 (약 150MB)

□ Docker 이미지 (선택)
  - postgres:16
  - 자체 빌드 이미지
```

---

## 9.2 설치 순서

```
1. PostgreSQL + pgvector 설치
   └─ 데이터베이스 생성, 스키마 적용

2. Ollama 설치
   └─ 바이너리 복사, 서비스 등록
   └─ 모델 파일 임포트

3. Python 환경 구성
   └─ 가상환경 생성
   └─ 오프라인 패키지 설치

4. 애플리케이션 배포
   └─ rag-api 배포
   └─ ingest-worker 배포

5. 초기 데이터 구성
   └─ 문서 업로드 및 인덱싱

6. 테스트
   └─ 헬스체크 확인
   └─ 샘플 질의 테스트
```

---

# 10. 용어 정리

| 용어 | 설명 |
|------|------|
| **RAG** | Retrieval-Augmented Generation. 검색 결과를 활용한 답변 생성 |
| **LLM** | Large Language Model. 대규모 언어 모델 |
| **임베딩** | 텍스트를 벡터(숫자 배열)로 변환한 것 |
| **청킹** | 문서를 작은 단위(청크)로 분할하는 것 |
| **벡터 검색** | 임베딩 간 유사도를 계산하여 검색 |
| **하이브리드 검색** | 벡터 검색 + 키워드 검색 조합 |
| **재랭킹** | 검색 결과를 다시 정렬하여 품질 향상 |
| **환각(Hallucination)** | LLM이 사실이 아닌 내용을 생성하는 현상 |
| **HNSW** | 벡터 인덱스 알고리즘 (Hierarchical Navigable Small World) |
| **Faithfulness** | 답변이 근거 문서에 충실한 정도 |

---

# 부록 A: LangChain vs LangGraph 역할 비교

## A.1 핵심 차이

| 구분 | LangChain | LangGraph |
|------|-----------|-----------|
| **역할** | 부품 창고 (레고 블럭) | 조립 설명서 (흐름 제어) |
| **하는 일** | LLM 호출, 검색, 도구 연결 | 순서 제어, 조건 분기, 재시도 |
| **비유** | 요리 재료 | 레시피 |

---

## A.2 함께 사용하는 방식

```
┌─────────────────────────────────────────────────────────────────┐
│                    LangGraph (흐름 제어)                         │
│                                                                 │
│   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    │
│   │ 1.질문   │───▶│ 2.검색  │───▶│ 3.근거  │───▶│ 4.답변   │    │
│   │ 분류     │    │ 실행    │    │ 확인    │    │ 생성     │    │
│   └─────────┘    └─────────┘    └────┬────┘    └─────────┘    │
│        │              │              │              │          │
│   LangChain      LlamaIndex      부족하면       LangChain      │
│   LLM 호출       검색 실행       재검색 루프     LLM 호출       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**LangChain 담당:**
- LLM 호출 (chat/completions)
- 임베딩 생성
- 프롬프트 템플릿

**LangGraph 담당:**
- 전체 흐름 제어
- 조건 분기 (근거 충분/부족)
- 재시도 로직
- 상태 관리

---

## A.3 왜 LangGraph가 필요한가?

**LangChain만 사용 시 (단순 RAG):**
```
검색 → 답변 생성 → 끝
```
- 검색 결과가 부족해도 그냥 답변 → **환각 발생**
- 에러 나면 그냥 실패 → **재시도 없음**

**LangGraph 추가 시 (고급 RAG):**
```
검색 → 근거 확인 → 부족하면 재검색 → 충분하면 답변 → 출처 정리
```
- 근거 부족 시 재검색 → **환각 감소**
- 최대 재시도 제한 → **무한 루프 방지**
- 근거 없으면 거절 → **신뢰성 향상**

---

# 부록 B: 기술 스택 버전

| 기술 | 권장 버전 |
|------|----------|
| Python | 3.11+ |
| LlamaIndex | 0.11+ |
| LangGraph | 0.2+ |
| LangChain | 0.3+ |
| FastAPI | 0.110+ |
| PostgreSQL | 16+ |
| pgvector | 0.7+ |
| Ollama | 0.3+ |

---

# 부록 C: HWP 문서 처리

한국 공공기관 문서 특성상 HWP 파일 처리가 필수.

**처리 방법:**

| 방법 | 장점 | 단점 |
|------|------|------|
| pyhwp | 외부 의존성 없음 | 복잡한 HWP 실패 가능 |
| LibreOffice 변환 | 안정적 | 설치 필요, 느림 |
| hwp5txt | 빠름 | 서식 손실 |

**권장: pyhwp 시도 → 실패 시 LibreOffice 폴백**

---

*문서 버전: 2.0*
*최종 수정: 2025년 1월*
*문서 수준: 기본 설계*