# ğŸ“˜ 12. ì„œë¸Œë²¡í„° (Subvectors)

ì„œë¸Œë²¡í„°(Subvector)ëŠ” ì „ì²´ ë²¡í„° ì¤‘ **ì¼ë¶€ ì°¨ì›ë§Œ ì„ íƒ**í•˜ì—¬ ê²€ìƒ‰í•˜ê±°ë‚˜ ì¸ë±ì‹±í•˜ëŠ” ê¸°ë²•ì…ë‹ˆë‹¤.  
ë©”ëª¨ë¦¬ ì ˆì•½, ê²€ìƒ‰ ì†ë„ í–¥ìƒ, íŠ¹ì • ì˜ë¯¸ ì˜ì—­ì— ì§‘ì¤‘í•œ ê²€ìƒ‰ ë“± ë‹¤ì–‘í•œ ìš©ë„ë¡œ í™œìš©ë©ë‹ˆë‹¤.

> ğŸ” **í•µì‹¬ ê°œë…:**  
> - **ì „ì²´ ë²¡í„°**: 768ì°¨ì› ëª¨ë‘ ì‚¬ìš© â†’ ì •í™•í•˜ì§€ë§Œ ëŠë¦¬ê³  ë©”ëª¨ë¦¬ ë§ì´ ì‚¬ìš©  
> - **ì„œë¸Œë²¡í„°**: ì²˜ìŒ 384ì°¨ì›ë§Œ ì‚¬ìš© â†’ ë¹ ë¥´ê³  ë©”ëª¨ë¦¬ ì ˆì•½, ì •í™•ë„ëŠ” ì•½ê°„ ê°ì†Œ  
> - **í™œìš©**: 1ì°¨ í•„í„°ë§ í›„ ì „ì²´ ë²¡í„°ë¡œ ì¬ë­í‚¹, íŠ¹ì • ì˜ë¯¸ ì°¨ì›ë§Œ ê²€ìƒ‰

---

## 1) ì„œë¸Œë²¡í„°ë€?

### ê°œë…

ì„œë¸Œë²¡í„°ëŠ” ì›ë³¸ ë²¡í„°ì˜ **ì¼ë¶€ ì°¨ì›ë§Œ ì¶”ì¶œ**í•œ ê²ƒì…ë‹ˆë‹¤.

```python
# ì›ë³¸ ë²¡í„° (768ì°¨ì›)
full_vector = [0.5, 0.3, 0.8, 0.1, ..., 0.6]  # 768ê°œ

# ì„œë¸Œë²¡í„° (ì²˜ìŒ 384ì°¨ì›ë§Œ)
sub_vector = [0.5, 0.3, 0.8, 0.1, ..., 0.2]   # 384ê°œ
```

### ì™œ ì„œë¸Œë²¡í„°ë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?

| í•­ëª© | ì „ì²´ ë²¡í„° (768ì°¨ì›) | ì„œë¸Œë²¡í„° (384ì°¨ì›) | íš¨ê³¼ |
|------|-------------------|------------------|------|
| **ë©”ëª¨ë¦¬** | 3,072 bytes | 1,536 bytes | 50% ì ˆê° |
| **ê²€ìƒ‰ ì†ë„** | ê¸°ì¤€ | ì•½ 2ë°° ë¹ ë¦„ | ê±°ë¦¬ ê³„ì‚° ì ˆë°˜ |
| **ì¸ë±ìŠ¤ í¬ê¸°** | ê¸°ì¤€ | ì•½ 50% ì‘ìŒ | ë””ìŠ¤í¬ ì ˆì•½ |
| **ì •í™•ë„** | 100% | 90~95% | ë¯¸ë¯¸í•œ ì†ì‹¤ |

### ì •í™•ë„ê°€ í¬ê²Œ ë–¨ì–´ì§€ì§€ ì•ŠëŠ” ì´ìœ 

ì„ë² ë”© ëª¨ë¸ì€ **ì¤‘ìš”í•œ ì •ë³´ë¥¼ ì•ìª½ ì°¨ì›ì— ì§‘ì¤‘**ì‹œí‚¤ëŠ” ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤.

```python
# ì‹¤í—˜: ì°¨ì›ë³„ ì •ë³´ëŸ‰ ë¶„ì‚°
import numpy as np

embedding = model.encode("sample text")

# ê° êµ¬ê°„ë³„ ë¶„ì‚° ê³„ì‚°
variance_1_256 = np.var(embedding[0:256])      # 0.082
variance_257_512 = np.var(embedding[256:512])  # 0.061
variance_513_768 = np.var(embedding[512:768])  # 0.045

# ì•ìª½ ì°¨ì›ì¼ìˆ˜ë¡ ë¶„ì‚°ì´ í¬ë‹¤ = ì •ë³´ëŸ‰ì´ ë§ë‹¤
```

---

## 2) PostgreSQLì—ì„œ ì„œë¸Œë²¡í„° ì‚¬ìš©

### ê¸°ë³¸ ë¬¸ë²•

pgvectorëŠ” **ë°°ì—´ ìŠ¬ë¼ì´ì‹± ë¬¸ë²•**ì„ ì§€ì›í•©ë‹ˆë‹¤.

```sql
-- ë²¡í„°ì˜ ì¼ë¶€ ì¶”ì¶œ
SELECT embedding[1:384] FROM vector.embeddings WHERE id = 1;

-- ì„œë¸Œë²¡í„°ë¡œ ê²€ìƒ‰
SELECT id, content
FROM vector.embeddings
ORDER BY (embedding[1:384]) <-> '[0.5, 0.3, ...]'::vector(384)
LIMIT 10;
```

> âš ï¸ **ì£¼ì˜:** PostgreSQL ë°°ì—´ì€ **1-based index**ì…ë‹ˆë‹¤ (0ì´ ì•„ë‹˜!)

### ì¸ë±ìŠ¤ ë²”ìœ„

| í‘œí˜„ | ì˜ë¯¸ | ì˜ˆì‹œ (768ì°¨ì›) |
|------|------|--------------|
| `[1:384]` | 1ë²ˆì§¸ë¶€í„° 384ë²ˆì§¸ê¹Œì§€ | ì•ìª½ ì ˆë°˜ |
| `[385:768]` | 385ë²ˆì§¸ë¶€í„° 768ë²ˆì§¸ê¹Œì§€ | ë’¤ìª½ ì ˆë°˜ |
| `[1:256]` | 1ë²ˆì§¸ë¶€í„° 256ë²ˆì§¸ê¹Œì§€ | ì•ìª½ 1/3 |
| `[257:512]` | 257ë²ˆì§¸ë¶€í„° 512ë²ˆì§¸ê¹Œì§€ | ì¤‘ê°„ 1/3 |

---

## 3) Subvector Index (ì„œë¸Œë²¡í„° ì¸ë±ì‹±)

### ê°œë…

ì „ì²´ ë²¡í„°ê°€ ì•„ë‹Œ **ì¼ë¶€ ì°¨ì›ë§Œ ì¸ë±ì‹±**í•˜ì—¬ ì¸ë±ìŠ¤ í¬ê¸°ì™€ ë¹Œë“œ ì‹œê°„ì„ ì¤„ì…ë‹ˆë‹¤.

### Expression Index ìƒì„±

PostgreSQLì˜ **Expression Index** ê¸°ëŠ¥ì„ í™œìš©í•˜ì—¬ ì„œë¸Œë²¡í„°ì— ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

```sql
-- ê¸°ë³¸ í…Œì´ë¸”
CREATE TABLE vector.embeddings (
    id BIGSERIAL PRIMARY KEY,
    content TEXT,
    embedding VECTOR(768)
);

-- ì„œë¸Œë²¡í„° ì¸ë±ìŠ¤ ìƒì„± (ì²˜ìŒ 384ì°¨ì›ë§Œ)
CREATE INDEX idx_embedding_sub384 ON vector.embeddings
USING hnsw ((embedding[1:384]) vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- ì¸ë±ìŠ¤ í†µê³„ í™•ì¸
SELECT 
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE indexname = 'idx_embedding_sub384';
```

### ì¸ë±ìŠ¤ í¬ê¸° ë¹„êµ

```sql
-- ì „ì²´ ë²¡í„° ì¸ë±ìŠ¤ (768ì°¨ì›)
CREATE INDEX idx_embedding_full ON vector.embeddings
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- ì„œë¸Œë²¡í„° ì¸ë±ìŠ¤ (384ì°¨ì›)
CREATE INDEX idx_embedding_sub ON vector.embeddings
USING hnsw ((embedding[1:384]) vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- í¬ê¸° ë¹„êµ
SELECT 
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS size
FROM pg_stat_user_indexes
WHERE tablename = 'embeddings'
ORDER BY indexname;

-- ê²°ê³¼ ì˜ˆì‹œ:
-- idx_embedding_full | 1.2 GB
-- idx_embedding_sub  | 640 MB  (ì•½ 50% ì ˆê°)
```

---

## 4) Subvector Query (ì„œë¸Œë²¡í„° ê²€ìƒ‰)

### ê¸°ë³¸ ê²€ìƒ‰

```sql
-- ì¿¼ë¦¬ ì¤€ë¹„ (384ì°¨ì› ì„œë¸Œë²¡í„°)
-- Pythonì—ì„œ: query_sub = query_embedding[:384]

SELECT 
    id,
    content,
    (embedding[1:384]) <=> '[0.5, 0.3, ...]'::vector(384) AS distance
FROM vector.embeddings
ORDER BY distance
LIMIT 10;
```

### ì¸ë±ìŠ¤ í™œìš© í™•ì¸

```sql
-- EXPLAINìœ¼ë¡œ ì¸ë±ìŠ¤ ì‚¬ìš© í™•ì¸
EXPLAIN (ANALYZE, BUFFERS)
SELECT id, content
FROM vector.embeddings
ORDER BY (embedding[1:384]) <=> '[...]'::vector(384)
LIMIT 10;

-- ì¶œë ¥ ì˜ˆì‹œ:
-- Index Scan using idx_embedding_sub384 on embeddings
-- (cost=0.00..123.45 rows=10 ...)
```

### Python ì˜ˆì œ

```python
from sentence_transformers import SentenceTransformer
import psycopg2

model = SentenceTransformer("nomic-ai/nomic-embed-text-v1.5")

def subvector_search(query_text, sub_dim=384, top_k=10):
    """
    ì„œë¸Œë²¡í„° ê²€ìƒ‰
    
    Args:
        query_text: ê²€ìƒ‰ ì¿¼ë¦¬
        sub_dim: ì„œë¸Œë²¡í„° ì°¨ì› ìˆ˜ (384, 512 ë“±)
        top_k: ë°˜í™˜ ê²°ê³¼ ìˆ˜
    """
    # 1) ì „ì²´ ì„ë² ë”© ìƒì„±
    full_embedding = model.encode(query_text)
    
    # 2) ì„œë¸Œë²¡í„° ì¶”ì¶œ
    sub_embedding = full_embedding[:sub_dim].tolist()
    
    conn = psycopg2.connect(...)
    cur = conn.cursor()
    
    # 3) ì„œë¸Œë²¡í„° ê²€ìƒ‰
    cur.execute(f"""
        SELECT 
            id,
            content,
            (embedding[1:{sub_dim}]) <=> %s::vector({sub_dim}) AS distance
        FROM vector.embeddings
        ORDER BY distance
        LIMIT %s
    """, (sub_embedding, top_k))
    
    results = cur.fetchall()
    cur.close()
    conn.close()
    
    return results

# ì‚¬ìš©
results = subvector_search("PostgreSQL vector search", sub_dim=384)
for rank, (doc_id, content, distance) in enumerate(results, 1):
    print(f"{rank}. [{distance:.4f}] {content[:60]}...")
```

---

## 5) 2ë‹¨ê³„ ê²€ìƒ‰: Coarse-to-Fine

ì„œë¸Œë²¡í„°ì˜ ê°€ì¥ íš¨ê³¼ì ì¸ í™œìš©ë²•ì€ **1ì°¨ í•„í„°ë§ í›„ ì „ì²´ ë²¡í„°ë¡œ ì¬ë­í‚¹**í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

### ê²€ìƒ‰ íŒŒì´í”„ë¼ì¸

```
[1ë‹¨ê³„: Coarse Search - ì„œë¸Œë²¡í„°]
  100ë§Œ ê°œ â†’ ì„œë¸Œë²¡í„°(384ì°¨ì›) ê²€ìƒ‰
  â†“ ìƒìœ„ 100ê°œ í›„ë³´ ì¶”ì¶œ (0.02ì´ˆ, ì¸ë±ìŠ¤ ì‚¬ìš©)

[2ë‹¨ê³„: Fine Search - ì „ì²´ ë²¡í„°]
  100ê°œ í›„ë³´ â†’ ì „ì²´ ë²¡í„°(768ì°¨ì›) ì¬ê³„ì‚°
  â†“ ìµœì¢… 10ê°œ ì„ íƒ (0.01ì´ˆ, ìˆœì°¨ ìŠ¤ìº”)

ì´ ê²€ìƒ‰ ì‹œê°„: 0.03ì´ˆ
ì •í™•ë„: ì „ì²´ ë²¡í„° ì§ì ‘ ê²€ìƒ‰ê³¼ ê±°ì˜ ë™ì¼ (98%+)
ë©”ëª¨ë¦¬/ë””ìŠ¤í¬: 50% ì ˆê°
```

### SQL êµ¬í˜„

```sql
-- 2ë‹¨ê³„ ê²€ìƒ‰
WITH candidates AS (
    -- 1ë‹¨ê³„: ì„œë¸Œë²¡í„°ë¡œ í›„ë³´ 100ê°œ ì¶”ì¶œ
    SELECT id, embedding
    FROM vector.embeddings
    ORDER BY (embedding[1:384]) <=> :sub_query_vec::vector(384)
    LIMIT 100
)
-- 2ë‹¨ê³„: ì „ì²´ ë²¡í„°ë¡œ ì¬ë­í‚¹
SELECT 
    c.id,
    e.content,
    c.embedding <=> :full_query_vec::vector(768) AS distance
FROM candidates c
JOIN vector.embeddings e ON c.id = e.id
ORDER BY distance
LIMIT 10;
```

### Python êµ¬í˜„

```python
def coarse_to_fine_search(query_text, candidate_size=100, top_k=10):
    """
    2ë‹¨ê³„ ì„œë¸Œë²¡í„° ê²€ìƒ‰
    
    1ë‹¨ê³„: ì„œë¸Œë²¡í„°ë¡œ ë¹ ë¥¸ í›„ë³´ ì¶”ì¶œ
    2ë‹¨ê³„: ì „ì²´ ë²¡í„°ë¡œ ì •ë°€ ì¬ë­í‚¹
    """
    # ì„ë² ë”© ìƒì„±
    full_embedding = model.encode(query_text)
    sub_embedding = full_embedding[:384].tolist()
    full_embedding = full_embedding.tolist()
    
    conn = psycopg2.connect(...)
    cur = conn.cursor()
    
    # 1ë‹¨ê³„: ì„œë¸Œë²¡í„° ê²€ìƒ‰
    cur.execute("""
        WITH candidates AS (
            SELECT id, embedding
            FROM vector.embeddings
            ORDER BY (embedding[1:384]) <=> %s::vector(384)
            LIMIT %s
        )
        -- 2ë‹¨ê³„: ì „ì²´ ë²¡í„° ì¬ë­í‚¹
        SELECT 
            c.id,
            e.content,
            c.embedding <=> %s::vector(768) AS distance
        FROM candidates c
        JOIN vector.embeddings e ON c.id = e.id
        ORDER BY distance
        LIMIT %s
    """, (sub_embedding, candidate_size, full_embedding, top_k))
    
    results = cur.fetchall()
    cur.close()
    conn.close()
    
    return results

# ì‚¬ìš©
results = coarse_to_fine_search("vector database optimization")
```

---

## 6) Expression Indexing í™œìš©

### íŠ¹ì • ë³€í™˜ ì—°ì‚°ì— ì¸ë±ìŠ¤ ìƒì„±

Expression IndexëŠ” **ë²¡í„°ì— íŠ¹ì • ì—°ì‚°ì„ ì ìš©í•œ ê²°ê³¼**ì— ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```sql
-- ì˜ˆì œ 1: ì •ê·œí™”ëœ ë²¡í„°ì— ì¸ë±ìŠ¤
CREATE INDEX idx_normalized ON vector.embeddings
USING hnsw ((embedding / vector_norm(embedding)) vector_cosine_ops);

-- ì˜ˆì œ 2: íŠ¹ì • êµ¬ê°„ í‰ê· 
CREATE INDEX idx_avg_sub ON vector.embeddings
USING hnsw (((embedding[1:256] + embedding[257:512]) / 2) vector_cosine_ops);
```

### ì‹¤ì „ ì˜ˆì œ: ë©€í‹° ìŠ¤ì¼€ì¼ ê²€ìƒ‰

ì—¬ëŸ¬ í•´ìƒë„ì˜ ì„œë¸Œë²¡í„°ë¥¼ ê²°í•©í•˜ì—¬ ê²€ìƒ‰í•©ë‹ˆë‹¤.

```sql
-- 3ê°œ ìŠ¤ì¼€ì¼ ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_sub_256 ON vector.embeddings
USING hnsw ((embedding[1:256]) vector_cosine_ops);

CREATE INDEX idx_sub_512 ON vector.embeddings
USING hnsw ((embedding[1:512]) vector_cosine_ops);

CREATE INDEX idx_full_768 ON vector.embeddings
USING hnsw (embedding vector_cosine_ops);

-- ë©€í‹° ìŠ¤ì¼€ì¼ ê²€ìƒ‰
WITH sub256_results AS (
    SELECT id, ROW_NUMBER() OVER (ORDER BY (embedding[1:256]) <=> :q256) AS rank
    FROM vector.embeddings LIMIT 100
),
sub512_results AS (
    SELECT id, ROW_NUMBER() OVER (ORDER BY (embedding[1:512]) <=> :q512) AS rank
    FROM vector.embeddings LIMIT 100
),
full_results AS (
    SELECT id, ROW_NUMBER() OVER (ORDER BY embedding <=> :q768) AS rank
    FROM vector.embeddings LIMIT 100
)
SELECT 
    COALESCE(a.id, b.id, c.id) AS id,
    (1.0 / (60 + COALESCE(a.rank, 200))) +
    (1.0 / (60 + COALESCE(b.rank, 200))) +
    (1.0 / (60 + COALESCE(c.rank, 200))) AS score
FROM sub256_results a
FULL OUTER JOIN sub512_results b ON a.id = b.id
FULL OUTER JOIN full_results c ON a.id = c.id
ORDER BY score DESC
LIMIT 10;
```

---

## 7) ì„œë¸Œë²¡í„° ì°¨ì› ì„ íƒ ê°€ì´ë“œ

### ì°¨ì›ë³„ ì„±ëŠ¥ vs ì •í™•ë„

| ì„œë¸Œë²¡í„° ì°¨ì› | ë©”ëª¨ë¦¬ ì ˆê° | ì†ë„ í–¥ìƒ | ì •í™•ë„ ìœ ì§€ | ê¶Œì¥ ìš©ë„ |
|--------------|-----------|----------|-----------|----------|
| **128ì°¨ì›** | 83% | 6ë°° | 75% | ë§¤ìš° ë¹ ë¥¸ 1ì°¨ í•„í„°ë§ |
| **256ì°¨ì›** | 67% | 3ë°° | 85% | ë¹ ë¥¸ í›„ë³´ ì¶”ì¶œ |
| **384ì°¨ì›** | 50% | 2ë°° | 90~95% | **ê· í˜•ì¡íŒ ì„ íƒ** â­ |
| **512ì°¨ì›** | 33% | 1.5ë°° | 95~98% | ê³ ì •ë°€ í•„í„°ë§ |

### ì‹¤í—˜ìœ¼ë¡œ ìµœì  ì°¨ì› ì°¾ê¸°

```python
import time
import numpy as np

def benchmark_subvector_dims(query_text, test_dims=[128, 256, 384, 512, 768]):
    """
    ë‹¤ì–‘í•œ ì„œë¸Œë²¡í„° ì°¨ì›ì—ì„œ ì„±ëŠ¥/ì •í™•ë„ ì¸¡ì •
    """
    full_embedding = model.encode(query_text)
    
    # ê¸°ì¤€: ì „ì²´ ë²¡í„° ê²€ìƒ‰
    start = time.time()
    baseline_results = vector_search(full_embedding, top_k=10)
    baseline_time = time.time() - start
    baseline_ids = [r[0] for r in baseline_results]
    
    print(f"Baseline (768ì°¨ì›): {baseline_time:.3f}s")
    print("\nì°¨ì› | ì‹œê°„ | ì†ë„í–¥ìƒ | Recall@10")
    print("-" * 45)
    
    for dim in test_dims:
        if dim >= 768:
            continue
        
        sub_embedding = full_embedding[:dim]
        
        start = time.time()
        results = subvector_search(query_text, sub_dim=dim, top_k=10)
        search_time = time.time() - start
        
        # Recall ê³„ì‚° (ìƒìœ„ 10ê°œ ì¤‘ ëª‡ ê°œê°€ ê¸°ì¤€ê³¼ ì¼ì¹˜?)
        result_ids = [r[0] for r in results]
        recall = len(set(result_ids) & set(baseline_ids)) / 10
        
        speedup = baseline_time / search_time
        
        print(f"{dim:4d} | {search_time:.3f}s | {speedup:.1f}x | {recall:.1%}")

# ì‹¤í–‰
benchmark_subvector_dims("PostgreSQL vector search optimization")

# ì¶œë ¥ ì˜ˆì‹œ:
# Baseline (768ì°¨ì›): 0.045s
#
# ì°¨ì› | ì‹œê°„ | ì†ë„í–¥ìƒ | Recall@10
# ---------------------------------------------
#  128 | 0.008s | 5.6x | 70.0%
#  256 | 0.015s | 3.0x | 85.0%
#  384 | 0.022s | 2.0x | 95.0%  â† ìµœì  ê· í˜•
#  512 | 0.032s | 1.4x | 98.0%
```

---

## 8) ì‹¤ì „ í™œìš© ì‚¬ë¡€

### ì‚¬ë¡€ 1: ëŒ€ê·œëª¨ ì´ë¯¸ì§€ ê²€ìƒ‰

```python
# ì‹œë‚˜ë¦¬ì˜¤: 1ì–µ ê°œ ì´ë¯¸ì§€ ê²€ìƒ‰
# CLIP ì„ë² ë”© 768ì°¨ì›

# 1) ì„œë¸Œë²¡í„° ì¸ë±ìŠ¤ ìƒì„± (384ì°¨ì›)
CREATE INDEX idx_image_sub384 ON images
USING hnsw ((embedding[1:384]) vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

# 2) 2ë‹¨ê³„ ê²€ìƒ‰
def image_search(query_image_path):
    # ì´ë¯¸ì§€ ì„ë² ë”© ìƒì„±
    full_emb = clip_model.encode_image(query_image_path)
    sub_emb = full_emb[:384]
    
    # 1ë‹¨ê³„: ì„œë¸Œë²¡í„°ë¡œ 1000ê°œ í›„ë³´
    candidates = subvector_search(sub_emb, top_k=1000)
    
    # 2ë‹¨ê³„: ì „ì²´ ë²¡í„°ë¡œ ì¬ë­í‚¹
    final_results = rerank_with_full_vector(candidates, full_emb, top_k=20)
    
    return final_results

# ì„±ëŠ¥:
# - 1ì–µ ê°œ â†’ 20ê°œ ì¶”ì¶œ: 0.1ì´ˆ
# - ë©”ëª¨ë¦¬: 30GB (ì „ì²´ ë²¡í„° ì‚¬ìš© ì‹œ 60GB)
```

### ì‚¬ë¡€ 2: ë©€í‹°ëª¨ë‹¬ ê²€ìƒ‰

```python
# í…ìŠ¤íŠ¸ + ì´ë¯¸ì§€ ì„ë² ë”© ê²°í•©
# í…ìŠ¤íŠ¸: 768ì°¨ì›, ì´ë¯¸ì§€: 512ì°¨ì› â†’ ì´ 1280ì°¨ì›

CREATE TABLE multimodal_docs (
    id BIGSERIAL PRIMARY KEY,
    content TEXT,
    embedding VECTOR(1280)  -- [text(768) | image(512)]
);

# í…ìŠ¤íŠ¸ë§Œ ê²€ìƒ‰ (ì•ìª½ 768ì°¨ì›)
SELECT id, content
FROM multimodal_docs
ORDER BY (embedding[1:768]) <=> :text_query::vector(768)
LIMIT 10;

# ì´ë¯¸ì§€ë§Œ ê²€ìƒ‰ (ë’¤ìª½ 512ì°¨ì›)
SELECT id, content
FROM multimodal_docs
ORDER BY (embedding[769:1280]) <=> :image_query::vector(512)
LIMIT 10;

# í•˜ì´ë¸Œë¦¬ë“œ: í…ìŠ¤íŠ¸ + ì´ë¯¸ì§€
WITH text_results AS (
    SELECT id, ROW_NUMBER() OVER (ORDER BY (embedding[1:768]) <=> :tq) AS rank
    FROM multimodal_docs LIMIT 100
),
image_results AS (
    SELECT id, ROW_NUMBER() OVER (ORDER BY (embedding[769:1280]) <=> :iq) AS rank
    FROM multimodal_docs LIMIT 100
)
SELECT 
    COALESCE(t.id, i.id) AS id,
    1.0 / (60 + COALESCE(t.rank, 200)) +
    1.0 / (60 + COALESCE(i.rank, 200)) AS score
FROM text_results t
FULL OUTER JOIN image_results i ON t.id = i.id
ORDER BY score DESC
LIMIT 10;
```

---

## 9) ì£¼ì˜ì‚¬í•­

### âš ï¸ ì¸ë±ìŠ¤ ìƒì„± ì‹œ ê´„í˜¸ í•„ìˆ˜

```sql
-- âŒ ì—ëŸ¬
CREATE INDEX idx_sub ON embeddings
USING hnsw (embedding[1:384] vector_cosine_ops);

-- âœ… ì •í™•
CREATE INDEX idx_sub ON embeddings
USING hnsw ((embedding[1:384]) vector_cosine_ops);
--           â†‘ ê´„í˜¸ í•„ìˆ˜ â†‘
```

### âš ï¸ 1-based ì¸ë±ìŠ¤

```sql
-- âŒ ì˜ëª»ëœ ë²”ìœ„ (0ë¶€í„° ì‹œì‘)
embedding[0:383]

-- âœ… ì •í™•í•œ ë²”ìœ„ (1ë¶€í„° ì‹œì‘)
embedding[1:384]
```

### âš ï¸ ì¿¼ë¦¬ ë²¡í„° ì°¨ì› ì¼ì¹˜

```python
# âŒ ì°¨ì› ë¶ˆì¼ì¹˜
sub_embedding = full_embedding[:384]  # 384ì°¨ì›
cur.execute("""
    SELECT * FROM embeddings
    ORDER BY (embedding[1:512]) <=> %s::vector(512)
    --                 512ì°¨ì› â†‘    â†‘ 384ì°¨ì›
""", (sub_embedding,))

# âœ… ì°¨ì› ì¼ì¹˜
sub_embedding = full_embedding[:384]  # 384ì°¨ì›
cur.execute("""
    SELECT * FROM embeddings
    ORDER BY (embedding[1:384]) <=> %s::vector(384)
    --                 384ì°¨ì› â†‘    â†‘ 384ì°¨ì›
""", (sub_embedding,))
```

---

## 10) ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬

### í™˜ê²½
- ë°ì´í„°: 100ë§Œ ê°œ ë¬¸ì„œ
- ì°¨ì›: 768ì°¨ì› (nomic-embed-text-v1.5)
- í•˜ë“œì›¨ì–´: 16GB RAM, SSD

### ê²°ê³¼

| ë°©ì‹ | ì¸ë±ìŠ¤ í¬ê¸° | ë¹Œë“œ ì‹œê°„ | ê²€ìƒ‰ ì‹œê°„ | Recall@10 |
|------|------------|----------|----------|-----------|
| **ì „ì²´ ë²¡í„° (768)** | 2.4 GB | 45ë¶„ | 0.045s | 100% |
| **ì„œë¸Œë²¡í„° (512)** | 1.6 GB | 30ë¶„ | 0.032s | 98% |
| **ì„œë¸Œë²¡í„° (384)** | 1.2 GB | 22ë¶„ | 0.022s | 95% |
| **ì„œë¸Œë²¡í„° (256)** | 800 MB | 15ë¶„ | 0.015s | 85% |
| **2ë‹¨ê³„ (384â†’768)** | 1.2 GB | 22ë¶„ | 0.028s | 99% |

### ê¶Œì¥ ì„¤ì •

```python
# ì¼ë°˜ ê²€ìƒ‰ (ì†ë„ ì¤‘ì‹œ)
sub_dim = 384
candidate_size = 100

# ê³ ì •ë°€ ê²€ìƒ‰ (ì •í™•ë„ ì¤‘ì‹œ)
sub_dim = 512
candidate_size = 200

# ì´ˆê³ ì† 1ì°¨ í•„í„°ë§
sub_dim = 256
candidate_size = 500
```

---

## 11) ìš”ì•½

### í•µì‹¬ í¬ì¸íŠ¸

1. **ì„œë¸Œë²¡í„° = ë²¡í„° ì¼ë¶€ ì°¨ì›ë§Œ ì‚¬ìš©**  
   ë©”ëª¨ë¦¬ 50% ì ˆê°, ì†ë„ 2ë°° í–¥ìƒ, ì •í™•ë„ 90~95% ìœ ì§€

2. **Expression Index**  
   `CREATE INDEX ... USING hnsw ((embedding[1:384]) ...)`

3. **2ë‹¨ê³„ ê²€ìƒ‰ íŒŒì´í”„ë¼ì¸**  
   1ì°¨: ì„œë¸Œë²¡í„°(ë¹ ë¦„) â†’ 2ì°¨: ì „ì²´ë²¡í„°(ì •í™•í•¨)

4. **ìµœì  ì°¨ì› ì„ íƒ**
    - 384ì°¨ì›: ê· í˜•ì¡íŒ ì„ íƒ (ì†ë„ 2ë°°, ì •í™•ë„ 95%)
    - 256ì°¨ì›: ë¹ ë¥¸ í•„í„°ë§ (ì†ë„ 3ë°°, ì •í™•ë„ 85%)
    - 512ì°¨ì›: ê³ ì •ë°€ (ì†ë„ 1.5ë°°, ì •í™•ë„ 98%)

5. **ì‹¤ì „ í™œìš©**
    - ëŒ€ê·œëª¨ ê²€ìƒ‰: ë©”ëª¨ë¦¬/ë””ìŠ¤í¬ ì ˆê°
    - ë©€í‹°ëª¨ë‹¬: í…ìŠ¤íŠ¸/ì´ë¯¸ì§€ ë¶„ë¦¬ ê²€ìƒ‰
    - ë©€í‹°ìŠ¤ì¼€ì¼: ì—¬ëŸ¬ í•´ìƒë„ ê²°í•©

---
