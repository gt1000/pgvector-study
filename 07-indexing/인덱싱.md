# ğŸ“˜ 07. ì¸ë±ì‹± (Indexing)

pgvectorì˜ ë²¡í„° ê²€ìƒ‰ ì„±ëŠ¥ì„ ìµœì í™”í•˜ëŠ” ì¸ë±ìŠ¤ ìƒì„± ë° ê´€ë¦¬ ë°©ë²•ì„ ë‹¤ë£¹ë‹ˆë‹¤.

## ğŸ“š í•„ë… ì°¸ê³  ìë£Œ
<blockquote>
âš ï¸ <b>ì¤‘ìš”:</b> ì¸ë±ì‹± ì „ëµ ìˆ˜ë¦½ ì „ ë°˜ë“œì‹œ ì•„ë˜ ë¬¸ì„œë“¤ì„ ì½ì–´ë³´ì„¸ìš”

<b>HNSW vs IVFFlat ìƒì„¸ ì„¤ëª…</b>
- [í•œê¸€ ë²ˆì—­ë³¸](./reference/hnsw,%20ivfflat%20ì¸ë±ì‹±%20ìƒì„¸.md)
  ([PGVector: HNSW vs IVFFlat â€” A Comprehensive Study](https://medium.com/@bavalpreetsinghh/pgvector-hnsw-vs-ivfflat-a-comprehensive-study-21ce0aaab931))
- ê°œìš”, ì‘ë™ ë°©ì‹, ë¹„êµ, ì‚¬ë¡€ ë“±

<b>pgvectorì˜ í•œê³„ì™€ ëŒ€ì•ˆ</b>
- [The Case Against pgvector](https://alex-jacobs.com/posts/the-case-against-pgvector/)
- pgvectorì˜ ì„±ëŠ¥ í•œê³„, ëŒ€ì•ˆ ì†”ë£¨ì…˜, ì‹¤ë¬´ ê³ ë ¤ì‚¬í•­

</blockquote>

---

## ì¸ë±ìŠ¤ íƒ€ì… ë¹„êµí‘œ

| í•­ëª© | HNSW | IVFFlat | DiskANN |
|------|------|---------|---------|
| **ì œê³µ** | pgvector | pgvector | **pgvectorscale** |
| **ì•Œê³ ë¦¬ì¦˜** | ê·¸ë˜í”„ ê¸°ë°˜ | í´ëŸ¬ìŠ¤í„° ê¸°ë°˜ | ê·¸ë˜í”„ + ë””ìŠ¤í¬ ê¸°ë°˜ |
| **ê²€ìƒ‰ ì†ë„** | ë§¤ìš° ë¹ ë¦„ (5~10ms) | ë¹ ë¦„ (10~20ms) | ë§¤ìš° ë¹ ë¦„ (5~15ms) |
| **ì •í™•ë„** | ë§¤ìš° ë†’ìŒ (99%+) | ì¤‘ê°„ (95%+) | ë§¤ìš° ë†’ìŒ (98%+) |
| **ë©”ëª¨ë¦¬ ì‚¬ìš©** | ë†’ìŒ (ì „ë¶€ RAM) | ì¤‘ê°„ | **ë‚®ìŒ (ë””ìŠ¤í¬ í™œìš©)** â­ |
| **ì¸ë±ìŠ¤ í¬ê¸°** | í¼ | ì‘ìŒ | ì¤‘ê°„ |
| **ë¹Œë“œ ì‹œê°„** | ëŠë¦¼ (30ë¶„~1ì‹œê°„) | ë¹ ë¦„ (10~20ë¶„) | ì¤‘ê°„ (20~40ë¶„) |
| **ìµœì  ë°ì´í„°** | 10ë§Œ~100ë§Œ ê±´ | 100ë§Œ~1ì²œë§Œ ê±´ | **100ë§Œ~10ì–µ ê±´** â­ |
| **í•„í„°ë§ ì„±ëŠ¥** | ì œí•œì  | ì œí•œì  | **ìš°ìˆ˜** â­ |
| **ì¶”ê°€ ì„¤ì¹˜** | ë¶ˆí•„ìš” | ë¶ˆí•„ìš” | **pgvectorscale í•„ìš”** |

---

## 1) HNSW ì¸ë±ìŠ¤ (ê¶Œì¥)

### ê°œìš”

**HNSW (Hierarchical Navigable Small World)**ëŠ” pgvectorì—ì„œ ê°€ì¥ ë§ì´ ì‚¬ìš©ë˜ëŠ” ì¸ë±ìŠ¤ ë°©ì‹ì…ë‹ˆë‹¤.

**íŠ¹ì§•:**
- ë¹ ë¥¸ ê²€ìƒ‰ ì†ë„ (10ms ì´í•˜)
- ë†’ì€ ì •í™•ë„ (99%+)
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë§ìŒ
- **10ë§Œ ê±´ ì´í•˜ ë°ì´í„°ì— ìµœì **

---

### ê¸°ë³¸ êµ¬ì¡° ì´í•´
```sql
CREATE INDEX ì¸ë±ìŠ¤_ì´ë¦„
ON í…Œì´ë¸”_ì´ë¦„
USING hnsw (ì»¬ëŸ¼ëª… operator_class)
WITH (íŒŒë¼ë¯¸í„°);
```

**ê° ë¶€ë¶„ ì„¤ëª…:**

| ë¶€ë¶„ | ì—­í•  | ì˜ˆì‹œ |
|------|------|------|
| `ì¸ë±ìŠ¤_ì´ë¦„` | ì¸ë±ìŠ¤ ì‹ë³„ì | `idx_paper_chunks_embedding` |
| `í…Œì´ë¸”_ì´ë¦„` | ëŒ€ìƒ í…Œì´ë¸” | `paper_chunks` |
| `hnsw` | ì¸ë±ìŠ¤ ì•Œê³ ë¦¬ì¦˜ (ê³ ì •) | pgvectorì˜ HNSW ë°©ì‹ |
| `ì»¬ëŸ¼ëª…` | ì¸ë±ì‹±í•  ë²¡í„° ì»¬ëŸ¼ | `embedding` |
| `operator_class` | ìµœì í™”í•  ê±°ë¦¬ í•¨ìˆ˜ | `vector_cosine_ops` |
| `íŒŒë¼ë¯¸í„°` | ì„±ëŠ¥ íŠœë‹ ì˜µì…˜ | `m = 16, ef_construction = 64` |

---

### Operator Classë€?

**ì •ì˜:**  
PostgreSQLì—ê²Œ **"ì´ ì¸ë±ìŠ¤ê°€ ì–´ë–¤ ê±°ë¦¬ í•¨ìˆ˜(ì—°ì‚°ì)ë¥¼ ë¹ ë¥´ê²Œ ì²˜ë¦¬í•  ê²ƒì¸ì§€"** ì•Œë ¤ì£¼ëŠ” **pgvector í™•ì¥ì´ ì œê³µí•˜ëŠ” ì‚¬ì „ ì •ì˜ëœ ì´ë¦„**ì…ë‹ˆë‹¤.

**ì¶œì²˜:**  
pgvector í™•ì¥ì„ ì„¤ì¹˜í•˜ë©´ PostgreSQLì— ìë™ìœ¼ë¡œ ë“±ë¡ë˜ëŠ” **ì˜ˆì•½ëœ ì´ë¦„ ì„¸íŠ¸**ì…ë‹ˆë‹¤.
```sql
-- pgvector ì„¤ì¹˜ ì‹œ ìë™ìœ¼ë¡œ ë“±ë¡ë˜ëŠ” Operator Classes
-- (ì‚¬ìš©ìê°€ ë§Œë“œëŠ” ê²ƒì´ ì•„ë‹˜, pgvectorê°€ ì œê³µ)

vector_l2_ops       -- L2 Distance (<->) ì „ìš©
vector_cosine_ops   -- Cosine Distance (<=>) ì „ìš©
vector_ip_ops       -- Inner Product (<#>) ì „ìš©
vector_l1_ops       -- L1 Distance (<+>) ì „ìš©
```

**í™•ì¸ ë°©ë²•:**
```sql
-- PostgreSQLì— ë“±ë¡ëœ operator class ëª©ë¡ í™•ì¸
SELECT
    c.opcname,          -- ì—°ì‚°ì í´ë˜ìŠ¤ ì´ë¦„ (ì˜ˆ: vector_l2_ops, vector_cosine_ops)
    c.opcmethod,        -- ìˆ«ì OID (ì§€ê¸ˆ ë³´ê³  ìˆëŠ” ê°’)
    a.amname            -- ì ‘ê·¼ ë©”ì„œë“œ ì´ë¦„ (btree, ivfflat, hnsw ë“±)
FROM pg_opclass c
         JOIN pg_am a
              ON a.oid = c.opcmethod
WHERE c.opcname LIKE 'vector%';

-- ê²°ê³¼:
-- opcname             | opcmethod, amname
-- --------------------|----------
-- vector_l2_ops       | 19887   |  hnsw
-- vector_cosine_ops   | 19887   |  hnsw
-- vector_ip_ops       | 19887   |  hnsw
-- vector_l1_ops       | 19887   |  hnsw
```

---

### Operator Classì™€ ê±°ë¦¬ í•¨ìˆ˜ ë§¤í•‘

**í•µì‹¬ ì›ì¹™:**  
ì¸ë±ìŠ¤ ìƒì„± ì‹œ ì‚¬ìš©í•œ operator classì™€ ê²€ìƒ‰ ì‹œ ì‚¬ìš©í•˜ëŠ” ì—°ì‚°ìê°€ **ë°˜ë“œì‹œ ì¼ì¹˜**í•´ì•¼ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

| ê²€ìƒ‰ ì‹œ ì‚¬ìš©í•  ì—°ì‚°ì | ì¸ë±ìŠ¤ ìƒì„± ì‹œ Operator Class | ìš©ë„ |
|---------------------|----------------------------|------|
| `<=>` (Cosine Distance) | `vector_cosine_ops` | **í…ìŠ¤íŠ¸ ê²€ìƒ‰** â­ |
| `<->` (L2 Distance) | `vector_l2_ops` | ì´ë¯¸ì§€ ê²€ìƒ‰ |
| `<#>` (Inner Product) | `vector_ip_ops` | ì¶”ì²œ ì‹œìŠ¤í…œ |
| `<+>` (L1 Distance) | `vector_l1_ops` | í¬ì†Œ ë²¡í„° |

**ì™œ ë§¤ì¹­ì´ ì¤‘ìš”í•œê°€?**
```sql
-- âŒ ì˜ëª»ëœ ì˜ˆ: operator classì™€ ê²€ìƒ‰ ì—°ì‚°ì ë¶ˆì¼ì¹˜
CREATE INDEX idx_wrong 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops);  -- Cosineìš© ì¸ë±ìŠ¤

SELECT * FROM paper_chunks
ORDER BY embedding <-> '[...]'  -- L2 ì—°ì‚°ì ì‚¬ìš©
LIMIT 10;
-- ê²°ê³¼: ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì§€ ëª»í•¨! (Seq Scan = ëŠë¦¼)

-- âœ… ì˜¬ë°”ë¥¸ ì˜ˆ: operator classì™€ ê²€ìƒ‰ ì—°ì‚°ì ì¼ì¹˜
CREATE INDEX idx_correct 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops);  -- Cosineìš© ì¸ë±ìŠ¤

SELECT * FROM paper_chunks
ORDER BY embedding <=> '[...]'  -- Cosine ì—°ì‚°ì ì‚¬ìš© (ì¼ì¹˜!)
LIMIT 10;
-- ê²°ê³¼: ì¸ë±ìŠ¤ ì‚¬ìš©! (Index Scan = ë¹ ë¦„)
```

---

### ê¸°ë³¸ ìƒì„± (í…ìŠ¤íŠ¸ ê²€ìƒ‰)

**ê°€ì¥ ë§ì´ ì‚¬ìš©í•˜ëŠ” íŒ¨í„´: Cosine Distance**
```sql
-- Step 1: êµ¬ì¡° ì´í•´
CREATE INDEX idx_paper_chunks_embedding    -- ì¸ë±ìŠ¤ ì´ë¦„ (ììœ ë¡­ê²Œ ì§€ì •)
ON paper_chunks                            -- í…Œì´ë¸” ì´ë¦„
USING hnsw (                               -- HNSW ì•Œê³ ë¦¬ì¦˜ ì‚¬ìš©
    embedding                              -- ë²¡í„° ì»¬ëŸ¼ ì´ë¦„
    vector_cosine_ops                      -- Cosine Distance ì „ìš© (pgvector ì œê³µ)
);

-- Step 2: ì‹¤ì œ ì‚¬ìš© (ë…¼ë¬¸ ì²­í¬ í…Œì´ë¸”)
CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops);

-- Step 3: ê²€ìƒ‰ (ë°˜ë“œì‹œ <=> ì‚¬ìš©)
SELECT 
    chunk_text,
    embedding <=> '[0.1, 0.2, ...]'::vector(768) AS distance
FROM paper_chunks
WHERE paper_id = 'kim_phd_2024'
ORDER BY distance
LIMIT 10;

-- EXPLAINìœ¼ë¡œ ì¸ë±ìŠ¤ ì‚¬ìš© í™•ì¸
EXPLAIN ANALYZE
SELECT chunk_text, embedding <=> '[...]'::vector(768) AS distance
FROM paper_chunks
ORDER BY distance
LIMIT 10;
-- ê²°ê³¼ì— "Index Scan using idx_paper_chunks_embedding" í‘œì‹œë˜ë©´ ì„±ê³µ
```

---

### ë‹¤ë¥¸ ê±°ë¦¬ í•¨ìˆ˜ìš© ì¸ë±ìŠ¤

#### L2 Distance (ì´ë¯¸ì§€ ê²€ìƒ‰)
```sql
-- ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_images_embedding 
ON images 
USING hnsw (embedding vector_l2_ops);  -- L2 ì „ìš©
                              â†‘
                    pgvectorê°€ ì œê³µí•˜ëŠ” ì˜ˆì•½ ì´ë¦„

-- ê²€ìƒ‰ (ë°˜ë“œì‹œ <-> ì‚¬ìš©)
SELECT filename, embedding <-> '[...]'::vector(512) AS distance
FROM images
ORDER BY distance
LIMIT 10;
```

#### Inner Product (ì¶”ì²œ ì‹œìŠ¤í…œ)
```sql
-- ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_recommendations_embedding 
ON recommendations 
USING hnsw (embedding vector_ip_ops);  -- Inner Product ì „ìš©
                              â†‘
                    pgvectorê°€ ì œê³µí•˜ëŠ” ì˜ˆì•½ ì´ë¦„

-- ê²€ìƒ‰ (ë°˜ë“œì‹œ <#> ì‚¬ìš©, DESC ì£¼ì˜!)
SELECT item_name, embedding <#> '[...]'::vector(768) AS score
FROM recommendations
ORDER BY score DESC  -- DESC í•„ìˆ˜ (ìŒìˆ˜ ë°˜í™˜)
LIMIT 10;
```

---

### ì „ì²´ Operator Class ëª©ë¡

pgvectorê°€ ì œê³µí•˜ëŠ” ëª¨ë“  operator class:
```sql
-- vector íƒ€ì… (float32, 4 bytes per dimension)
vector_l2_ops       -- <-> (L2 Distance, Euclidean)
vector_cosine_ops   -- <=> (Cosine Distance) â­ ê°€ì¥ ë§ì´ ì‚¬ìš©
vector_ip_ops       -- <#> (Inner Product, ìŒìˆ˜ ë°˜í™˜)
vector_l1_ops       -- <+> (L1 Distance, Manhattan)

-- halfvec íƒ€ì… (float16, 2 bytes per dimension)
halfvec_l2_ops      -- <-> (L2 Distance)
halfvec_cosine_ops  -- <=> (Cosine Distance)
halfvec_ip_ops      -- <#> (Inner Product)

-- bit íƒ€ì… (binary vectors)
bit_hamming_ops     -- <~> (Hamming Distance)
bit_jaccard_ops     -- <%> (Jaccard Distance)
```

**í™•ì¸:**
```sql
-- ì„¤ì¹˜ëœ operator class ëª©ë¡ ì¡°íšŒ
\dAo+ vector_cosine_ops

-- ë˜ëŠ” SQLë¡œ
SELECT 
    opcname AS operator_class,
    amname AS index_method
FROM pg_opclass opc
JOIN pg_am am ON opc.opcmethod = am.oid
WHERE opcname LIKE 'vector%'
ORDER BY opcname;
```

---

### íŒŒë¼ë¯¸í„° íŠœë‹

#### WITH ì ˆ íŒŒë¼ë¯¸í„°
```sql
CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (
    m = 16,                -- ì—°ê²° ìˆ˜ (ê¸°ë³¸ê°’)
    ef_construction = 64   -- êµ¬ì¶• ì‹œ íƒìƒ‰ ìˆ˜ (ê¸°ë³¸ê°’)
);
```

### íŒŒë¼ë¯¸í„° íŠœë‹ â€“ ì§ê´€ì  ì´í•´ (ë„ì‹œ ì§€ë„ ë¹„ìœ )

HNSW ì¸ë±ìŠ¤ëŠ” ê·¸ë˜í”„ í˜•íƒœë¡œ ë²¡í„°ë“¤ì„ ì„œë¡œ ì—°ê²°í•´ ë‘ê³ ,  
ê²€ìƒ‰í•  ë•Œ ì´ ê·¸ë˜í”„ë¥¼ ë¹ ë¥´ê²Œ íƒìƒ‰í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.

ì´ë¥¼ **ë„ì‹œì˜ ë„ë¡œë§**ì„ ë§Œë“ ë‹¤ê³  ê°€ì •í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì´í•´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ğŸ›£ï¸ m = 16
**ê° ë²¡í„°(ë…¸ë“œ)ê°€ ì—°ê²°í•  "ì´ì›ƒ ê¸¸"ì˜ ê°œìˆ˜**

- mì€ ê° ë…¸ë“œê°€ ëª‡ ê°œì˜ ì´ì›ƒê³¼ ì—°ê²°ë ì§€ ê²°ì •í•©ë‹ˆë‹¤.
- ë„ì‹œì—ì„œ ìƒˆë¡œìš´ ê±´ë¬¼ì„ ì§€ì„ ë•Œ **ëª‡ ê°œì˜ ë„ë¡œë¥¼ ì—°ê²°í• ì§€** ì •í•˜ëŠ” ê²ƒê³¼ ê°™ìŒ.

ì˜ˆë¥¼ ë“¤ì–´:

- m = 16 â†’ ê° ë…¸ë“œê°€ ìµœëŒ€ 16ê°œì˜ ì´ì›ƒ ë…¸ë“œì™€ ì—°ê²°ë¨
- m ì‘ê²Œ â†’ ë„ë¡œê°€ ì ì–´ íƒìƒ‰ì€ ë¹ ë¥´ì§€ë§Œ ì •í™•ë„â†“
- m í¬ê²Œ â†’ ë„ë¡œê°€ ë§ì•„ íƒìƒ‰ ì •í™•ë„â†‘, í•˜ì§€ë§Œ ë©”ëª¨ë¦¬/ì¸ë±ìŠ¤ í¬ê¸° ì¦ê°€

**ì¦‰, mì€ "ë„ë¡œë§ì˜ ë°€ë„"ë¥¼ ê²°ì •**í•˜ëŠ” ê°’ì…ë‹ˆë‹¤.

## ğŸ” ef_construction = 64
**ì¸ë±ìŠ¤ë¥¼ ë§Œë“¤ ë•Œ ê³ ë ¤í•  "í›„ë³´ ë„ë¡œ ìˆ˜"**

- ef_constructionì€ ê·¸ë˜í”„ë¥¼ êµ¬ì¶•í•˜ë©´ì„œ  
  **ì¢‹ì€ ì´ì›ƒì„ ì„ íƒí•˜ê¸° ìœ„í•´ íƒìƒ‰í•˜ëŠ” í›„ë³´ ìˆ˜**ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.

ë„ì‹œ ë¹„ìœ ë¡œ ë³´ë©´:

- ìƒˆ ë„ë¡œë¥¼ ì—°ê²°í•˜ê¸° ìœ„í•´ ì£¼ë³€ì„ ë‘˜ëŸ¬ë³¼ ë•Œ  
  **ì–¼ë§ˆë‚˜ ë©€ë¦¬(ì–¼ë§ˆë‚˜ ë§ì€ í›„ë³´ ë„ë¡œë¥¼) íƒìƒ‰í•˜ê³  ì—°ê²°í• ì§€**ë¥¼ ê²°ì •í•˜ëŠ” ê°’.

ì˜ˆ)

- ef_construction = 64  
  â†’ ë„ë¡œ í›„ë³´ 64ê°œ ì¤‘ì—ì„œ ê°€ì¥ ì¢‹ì€ 16ê°œ(m=16)ë¥¼ ì„ íƒí•´ ì—°ê²°
- ef_constructionì´ í´ìˆ˜ë¡  
  â†’ ë” ë©€ë¦¬ íƒìƒ‰í•´ì„œ **ìµœì ì˜ ë„ë¡œë§** í˜•ì„±  
  â†’ ê²€ìƒ‰ ì •í™•ë„ëŠ” ë†’ì•„ì§€ì§€ë§Œ ì¸ë±ìŠ¤ ìƒì„± ì‹œê°„ì´ ëŠ˜ì–´ë‚¨

```
m ê°’ì´ í´ìˆ˜ë¡:
- ì¸ë±ìŠ¤ í¬ê¸° ì¦ê°€
- ë¹Œë“œ ì‹œê°„ ì¦ê°€
- ê²€ìƒ‰ ì •í™•ë„ ì¦ê°€
- ê²€ìƒ‰ ì†ë„ ì•½ê°„ ê°ì†Œ
```

**ê¶Œì¥ ì„¤ì •:**

| ë°ì´í„° ê·œëª¨ | m ê°’ | ë¹Œë“œ ì‹œê°„ (10ë§Œ ê±´ ê¸°ì¤€) |
|-----------|------|----------------------|
| < 10,000ê±´ | 8 ~ 16 | ~3ë¶„ |
| 10,000 ~ 100,000ê±´ | 16 | ~15ë¶„ |
| > 100,000ê±´ | 16 ~ 24 | ~30ë¶„ |
| ê³ ì •í™•ë„ í•„ìš” | 32 | ~1ì‹œê°„ |

**ì˜ˆì‹œ:**
```sql
-- ì‘ì€ ë°ì´í„° (ë¹ ë¥¸ ë¹Œë“œ)
CREATE INDEX idx_small 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 8, ef_construction = 64);

-- ì¼ë°˜ì ì¸ ê²½ìš° (ê¶Œì¥)
CREATE INDEX idx_normal 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- ê³ ì •í™•ë„
CREATE INDEX idx_high_accuracy 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 32, ef_construction = 200);
```

```
ef_construction ê°’ì´ í´ìˆ˜ë¡:
- ë¹Œë“œ ì‹œê°„ ì¦ê°€
- ì¸ë±ìŠ¤ í’ˆì§ˆ ì¦ê°€ (ê²€ìƒ‰ ì •í™•ë„ í–¥ìƒ)
- ì¸ë±ìŠ¤ í¬ê¸°ëŠ” ë³€í™” ì—†ìŒ
```

**ê¶Œì¥ ì„¤ì •:**

| ëª©ì  | ef_construction | ë¹Œë“œ ì‹œê°„ ë°°ìˆ˜ |
|------|-----------------|--------------|
| ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ | 32 | 1x |
| ì¼ë°˜ (ê¸°ë³¸ê°’) | 64 | 2x |
| í”„ë¡œë•ì…˜ | 128 | 4x |
| ìµœê³  í’ˆì§ˆ | 200 | 6x |

**ì˜ˆì‹œ:**
```sql
-- ê°œë°œ/í…ŒìŠ¤íŠ¸ (ë¹ ë¥¸ ë¹Œë“œ)
CREATE INDEX idx_dev 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 32);

-- í”„ë¡œë•ì…˜ (ê· í˜•)
CREATE INDEX idx_prod 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- ê³ í’ˆì§ˆ (ëŠë¦° ë¹Œë“œ, ë†’ì€ ì •í™•ë„)
CREATE INDEX idx_quality 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 24, ef_construction = 200);
```

---

### ê²€ìƒ‰ ì‹œ ì •í™•ë„ ì¡°ì •

ì¸ë±ìŠ¤ ìƒì„± í›„ì—ë„ ê²€ìƒ‰ ì •í™•ë„ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### ef_search íŒŒë¼ë¯¸í„°
- ë‚´ê°€ ì–´ë–¤ ëª©ì ì§€(ê°€ì¥ ë¹„ìŠ·í•œ ë²¡í„°)ë¥¼ ì°¾ìœ¼ë ¤ê³  í•  ë•Œ,
  ì´ ë„ì‹œì—ì„œ ëª‡ ê°œì˜ ê²½ë¡œ í›„ë³´ë¥¼ ë”°ë¼ê°€ ë³´ë©´ì„œ ì°¾ì„ ê±´ì§€
- ef_construction vs ef_search

| íŒŒë¼ë¯¸í„° | ì‹œì  | ì—­í•  |
|---------|------|------|
| `ef_construction` | **ì¸ë±ìŠ¤ ìƒì„± ì‹œ** | ë„ë¡œë§ í’ˆì§ˆ ê²°ì • (ê³ ì •, ë³€ê²½ ë¶ˆê°€) |
| `ef_search` | **ê²€ìƒ‰ ì‹¤í–‰ ì‹œ** | ê²€ìƒ‰ ì •í™•ë„ ì¡°ì • (ë™ì  ë³€ê²½ ê°€ëŠ¥) |

**ë¹„ìœ :**
```
ef_construction = ë„ë¡œë¥¼ ì–¼ë§ˆë‚˜ ì´˜ì´˜í•˜ê²Œ ë§Œë“¤ê¹Œ? (ê±´ì„¤ ë‹¨ê³„, 1íšŒ)
ef_search = ëª©ì ì§€ê¹Œì§€ ëª‡ ê°œ ê¸¸ì„ ì‹œë„í•´ë³¼ê¹Œ? (ìš´ì „ ì‹œ, ë§¤ë²ˆ ë³€ê²½ ê°€ëŠ¥)
```

```sql
-- ê²€ìƒ‰ ì „ ì„¤ì • (ì„¸ì…˜ë³„)
SET hnsw.ef_search = 40;  -- ê¸°ë³¸ê°’

-- ë¹ ë¥¸ ê²€ìƒ‰ (ì •í™•ë„ ë‚®ìŒ)
SET hnsw.ef_search = 20;
SELECT * FROM paper_chunks
ORDER BY embedding <=> '[...]'::vector(768)
LIMIT 10;

-- ì •ë°€ ê²€ìƒ‰ (ì •í™•ë„ ë†’ìŒ)
SET hnsw.ef_search = 200;
SELECT * FROM paper_chunks
ORDER BY embedding <=> '[...]'::vector(768)
LIMIT 10;
```

```
ef_search ê°’ì´ í´ìˆ˜ë¡:
- ê²€ìƒ‰ ì •í™•ë„ ì¦ê°€ (Recall í–¥ìƒ)
- ê²€ìƒ‰ ì‹œê°„ ì¦ê°€ (ëŠë ¤ì§)
- ì¸ë±ìŠ¤ë‚˜ ë°ì´í„°ëŠ” ë³€í™” ì—†ìŒ (ê²€ìƒ‰ ì‹œì—ë§Œ ì˜í–¥)
```

**ê¶Œì¥ ì„¤ì •:**

| ëª©ì  | ef_search | ê²€ìƒ‰ ì‹œê°„ | Recall |
|------|-----------|----------|--------|
| ë¹ ë¥¸ ì‘ë‹µ | 20 ~ 40 | 5ms | 90% |
| ê· í˜• (ê¸°ë³¸ê°’) | 40 ~ 100 | 10ms | 95% |
| ê³ ì •í™•ë„ | 100 ~ 200 | 20ms | 99% |
| ìµœê³  í’ˆì§ˆ | 200+ | 40ms | 99.9% |

**ì˜ˆì‹œ:**
```sql
-- ì›¹ ì„œë¹„ìŠ¤ (ë¹ ë¥¸ ì‘ë‹µ)
SET hnsw.ef_search = 40;

-- ë°ì´í„° ë¶„ì„ (ì •í™•ë„ ì¤‘ìš”)
SET hnsw.ef_search = 200;

-- ì‹¤ì‹œê°„ ì¶”ì²œ (ì†ë„ ìµœìš°ì„ )
SET hnsw.ef_search = 20;
```

---

## 2) IVFFlat ì¸ë±ìŠ¤

### ê°œìš”

**IVFFlat (Inverted File with Flat compression)**ì€ ëŒ€ìš©ëŸ‰ ë°ì´í„°ì— ì í•©í•œ ì¸ë±ìŠ¤ ë°©ì‹ì…ë‹ˆë‹¤.

**íŠ¹ì§•:**
- ë¹ ë¥¸ ì¸ë±ìŠ¤ ë¹Œë“œ
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì ìŒ
- ê²€ìƒ‰ ì •í™•ë„ ì¤‘ê°„ (95%+)
- **100ë§Œ ê±´ ì´ìƒ ë°ì´í„°ì— ì í•©**

---

### ì‘ë™ ì›ë¦¬

```
1. í›ˆë ¨ (Training): ë²¡í„°ë¥¼ Nê°œ í´ëŸ¬ìŠ¤í„°ë¡œ ê·¸ë£¹í™”
2. ì¸ë±ì‹± (Indexing): ê° ë²¡í„°ë¥¼ ê°€ì¥ ê°€ê¹Œìš´ í´ëŸ¬ìŠ¤í„°ì— í• ë‹¹
3. ê²€ìƒ‰ (Search): ì¿¼ë¦¬ì™€ ê°€ê¹Œìš´ Mê°œ í´ëŸ¬ìŠ¤í„°ë§Œ íƒìƒ‰
```

**ì‹œê°í™”:**
```
ì „ì²´ ë²¡í„° ê³µê°„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â—  â—  â—  â—  â—      â”‚  â† í´ëŸ¬ìŠ¤í„° 1 (centroid: â˜…)
â”‚    â˜…                â”‚
â”‚                     â”‚
â”‚           â—  â—      â”‚  â† í´ëŸ¬ìŠ¤í„° 2 (centroid: â˜…)
â”‚           â˜…  â—      â”‚
â”‚                     â”‚
â”‚  â—  â—               â”‚  â† í´ëŸ¬ìŠ¤í„° 3 (centroid: â˜…)
â”‚  â˜…  â—               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì¿¼ë¦¬ Q â†’ ê°€ì¥ ê°€ê¹Œìš´ 2ê°œ í´ëŸ¬ìŠ¤í„° (1, 3)ë§Œ ê²€ìƒ‰
```

---

### ê¸°ë³¸ ìƒì„±

```sql
-- Step 1: êµ¬ì¡° ì´í•´
CREATE INDEX idx_paper_chunks_embedding
ON paper_chunks
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);  -- í´ëŸ¬ìŠ¤í„° ìˆ˜

-- Step 2: ì‹¤ì œ ì‚¬ìš©
CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- Step 3: ê²€ìƒ‰ ì„¤ì •
SET ivfflat.probes = 10;  -- íƒìƒ‰í•  í´ëŸ¬ìŠ¤í„° ìˆ˜

-- Step 4: ê²€ìƒ‰
SELECT chunk_text, embedding <=> '[...]'::vector(768) AS distance
FROM paper_chunks
ORDER BY distance
LIMIT 10;
```

---

### íŒŒë¼ë¯¸í„° íŠœë‹

#### lists (í´ëŸ¬ìŠ¤í„° ìˆ˜)

**ê¶Œì¥ ê³µì‹:**  
`lists = sqrt(í–‰ ìˆ˜)`

| ë°ì´í„° ê·œëª¨ | lists ê¶Œì¥ê°’ | ê³„ì‚° |
|-----------|------------|------|
| 10,000ê±´ | 100 | sqrt(10,000) = 100 |
| 100,000ê±´ | 316 | sqrt(100,000) â‰ˆ 316 |
| 1,000,000ê±´ | 1,000 | sqrt(1,000,000) = 1,000 |
| 10,000,000ê±´ | 3,162 | sqrt(10,000,000) â‰ˆ 3,162 |

```sql
-- 10ë§Œ ê±´
CREATE INDEX idx_100k 
ON paper_chunks 
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 316);

-- 100ë§Œ ê±´
CREATE INDEX idx_1m 
ON paper_chunks 
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 1000);
```

---

#### probes (íƒìƒ‰ í´ëŸ¬ìŠ¤í„° ìˆ˜)

ê²€ìƒ‰ ì‹œ íƒìƒ‰í•  í´ëŸ¬ìŠ¤í„° ìˆ˜ë¥¼ ë™ì ìœ¼ë¡œ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ê¶Œì¥:**  
`probes = listsì˜ 1% ~ 10%`

```sql
-- ë¹ ë¥¸ ê²€ìƒ‰ (ì •í™•ë„ ë‚®ìŒ)
SET ivfflat.probes = 1;  -- lists = 100ì´ë©´ 1%

-- ê· í˜• (ê¸°ë³¸ê°’)
SET ivfflat.probes = 10;  -- lists = 100ì´ë©´ 10%

-- ì •ë°€ ê²€ìƒ‰ (ì •í™•ë„ ë†’ìŒ)
SET ivfflat.probes = 20;  -- lists = 100ì´ë©´ 20%
```

| probes | ê²€ìƒ‰ ì‹œê°„ | Recall |
|--------|----------|--------|
| 1 | 5ms | 85% |
| 10 | 15ms | 95% |
| 20 | 25ms | 98% |

---

### ì¸ë±ìŠ¤ ë¹Œë“œ í”„ë¡œì„¸ìŠ¤

#### ì˜¤í”„ë¼ì¸ ë‹¨ê³„ (ì¸ë±ìŠ¤ ìƒì„± ì‹œ)

```sql
-- 1ë‹¨ê³„: Training (í´ëŸ¬ìŠ¤í„° ì¤‘ì‹¬ì  ê³„ì‚°)
-- lists = 100ì´ë©´ 100ê°œì˜ ì¤‘ì‹¬ì (centroid) ìƒì„±
CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- ë‚´ë¶€ ë™ì‘:
-- â‘  ì „ì²´ ë²¡í„°ë¥¼ ìƒ˜í”Œë§
-- â‘¡ k-means ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ 100ê°œ í´ëŸ¬ìŠ¤í„° ìƒì„±
-- â‘¢ ê° ë²¡í„°ë¥¼ ê°€ì¥ ê°€ê¹Œìš´ í´ëŸ¬ìŠ¤í„°ì— í• ë‹¹
-- â‘£ ì—­ ì¸ë±ìŠ¤ êµ¬ì¡° ìƒì„±
```

**ì‹œê°ì  ì„¤ëª…:**
```
í›ˆë ¨ ë‹¨ê³„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â—  â—  â—                â”‚
â”‚    â˜…  â† centroid 1     â”‚
â”‚  â—  â—                   â”‚
â”‚                         â”‚
â”‚           â—  â—  â—       â”‚
â”‚           â˜…  â† centroid 2
â”‚           â—  â—          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ê° ë²¡í„°ë¥¼ ê°€ì¥ ê°€ê¹Œìš´ centroidì— í• ë‹¹:
centroid 1: [vec1, vec2, vec3, vec4, vec5]
centroid 2: [vec6, vec7, vec8, vec9]
```

---

#### ì˜¨ë¼ì¸ ë‹¨ê³„ (ê²€ìƒ‰ ì‹œ)

```sql
-- ê²€ìƒ‰ í”„ë¡œì„¸ìŠ¤
SET ivfflat.probes = 10;  -- 10ê°œ í´ëŸ¬ìŠ¤í„° íƒìƒ‰

SELECT * FROM paper_chunks
ORDER BY embedding <=> '[...]'::vector(768)
LIMIT 10;
```

**ê²€ìƒ‰ í”„ë¡œì„¸ìŠ¤ (ì˜¨ë¼ì¸ ë‹¨ê³„):**

- ì¿¼ë¦¬ ë²¡í„°ê°€ ì£¼ì–´ì§€ë©´ ì²« ë²ˆì§¸ ë‹¨ê³„ëŠ” ì¿¼ë¦¬ ë²¡í„°ì— ê°€ì¥ ê°€ê¹Œìš´ centroid(í´ëŸ¬ìŠ¤í„°)ë¥¼ ì‹ë³„í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ëŠ” ì¿¼ë¦¬ë¥¼ centroid ë²¡í„°ì™€ ë¹„êµí•˜ì—¬ ìˆ˜í–‰ë©ë‹ˆë‹¤.  
  ![ì´ë¯¸ì§€ ì„¤ëª…](./search-process1.png)

- ê°€ì¥ ê°€ê¹Œìš´ centroidê°€ ì‹ë³„ë˜ë©´(ì¼ë°˜ì ìœ¼ë¡œ ë‘˜ ì´ìƒ), í•´ë‹¹ centroidì˜ í•´ë‹¹ ì—­ ì¸ë±ìŠ¤(ë²„í‚·)ì— ì €ì¥ëœ ë²¡í„°ë¡œ ê²€ìƒ‰ì´ ì œí•œë©ë‹ˆë‹¤.
    - **ë‘˜ ì´ìƒì„ ì„ íƒí•˜ëŠ” ì´ìœ :** ë‹¨ì¼ centroidë§Œ ì„ íƒí•  ê²½ìš°, ì¿¼ë¦¬ ë²¡í„°ê°€ í´ëŸ¬ìŠ¤í„° ê²½ê³„ ê·¼ì²˜ì— ìˆì„ ë•Œ ì‹¤ì œ ìµœê·¼ì ‘ ì´ì›ƒì„ ë†“ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ëŸ¬ centroidë¥¼ íƒìƒ‰í•¨ìœ¼ë¡œì¨ ê²€ìƒ‰ ì •í™•ë„ë¥¼ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      ![ì´ë¯¸ì§€ ì„¤ëª…](./search-process2.png)

- ì„ íƒëœ í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œì˜ ê²€ìƒ‰ì€ brute-force ê²€ìƒ‰ì„ ì‚¬ìš©í•˜ì—¬ í•´ë‹¹ í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ìµœê·¼ì ‘ ì´ì›ƒì„ ì°¾ëŠ” ë°©ì‹ìœ¼ë¡œ ìˆ˜í–‰ë˜ë©°, ì´ëŠ” ì „ì²´ ë°ì´í„°ì…‹ì„ ê²€ìƒ‰í•˜ëŠ” ê²ƒë³´ë‹¤ ê³„ì‚°ì ìœ¼ë¡œ ë” íš¨ìœ¨ì ì…ë‹ˆë‹¤.

---

### HNSW vs IVFFlat ì„ íƒ ê°€ì´ë“œ

| ê¸°ì¤€ | HNSW | IVFFlat |
|------|------|---------|
| **ë°ì´í„° ê·œëª¨** | < 100ë§Œ ê±´ | > 100ë§Œ ê±´ |
| **ë©”ëª¨ë¦¬** | ì¶©ë¶„í•¨ (4GB+) | ì œí•œì  (< 4GB) |
| **ê²€ìƒ‰ ì†ë„** | ìµœìš°ì„  | ì¤‘ìš”í•˜ì§€ ì•ŠìŒ |
| **ì •í™•ë„** | 99%+ í•„ìš” | 95% ì¶©ë¶„ |
| **ë¹Œë“œ ì‹œê°„** | ëŠë ¤ë„ ë¨ | ë¹¨ë¼ì•¼ í•¨ |

---

## 3) DiskANN ì¸ë±ìŠ¤ (pgvectorscale)

### ê°œìš”

**DiskANN**ì€ Microsoft Researchì—ì„œ ê°œë°œí•œ ë””ìŠ¤í¬ ê¸°ë°˜ ê·¸ë˜í”„ ì¸ë±ìŠ¤ë¡œ, **pgvectorscale í™•ì¥**ì„ í†µí•´ ì œê³µë©ë‹ˆë‹¤.

**íŠ¹ì§•:**
- ë©”ëª¨ë¦¬ íš¨ìœ¨ì  (ë””ìŠ¤í¬ í™œìš©)
- ë†’ì€ ì •í™•ë„ (98%+)
- ìš°ìˆ˜í•œ í•„í„°ë§ ì„±ëŠ¥
- **100ë§Œ~10ì–µ ê±´ ë°ì´í„°ì— ìµœì **

**í•µì‹¬ ì°¨ì´:**
- HNSW: ì „ì²´ ì¸ë±ìŠ¤ë¥¼ **ë©”ëª¨ë¦¬(RAM)ì—** ì €ì¥
- DiskANN: ì¸ë±ìŠ¤ì˜ ëŒ€ë¶€ë¶„ì„ **ë””ìŠ¤í¬(SSD)ì—** ì €ì¥, í•„ìš”í•œ ë¶€ë¶„ë§Œ ë©”ëª¨ë¦¬ì— ë¡œë“œ

---

### âš ï¸ ì‚¬ì „ ìš”êµ¬ì‚¬í•­

DiskANNì„ ì‚¬ìš©í•˜ë ¤ë©´ **pgvectorscale í™•ì¥ì„ ë³„ë„ë¡œ ì„¤ì¹˜**í•´ì•¼ í•©ë‹ˆë‹¤.

#### ì„¤ì¹˜ ë°©ë²•

**Docker Compose ì˜ˆì‹œ:**
```yaml
services:
  postgres:
    image: postgis/postgis:18-3.6
    # ... ê¸°ì¡´ ì„¤ì • ...

# Dockerfileì— ì¶”ê°€:
RUN apt-get update && \
    apt-get install -y wget gnupg && \
    echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list && \
    wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add - && \
    apt-get update && \
    apt-get install -y postgresql-18-pgvectorscale
```

**í™•ì¥ í™œì„±í™”:**
```sql
-- pgvectorëŠ” ìë™ìœ¼ë¡œ ì˜ì¡´ì„± ì„¤ì¹˜ë¨
CREATE EXTENSION IF NOT EXISTS vectorscale CASCADE;

-- í™•ì¸
SELECT * FROM pg_extension WHERE extname IN ('vector', 'vectorscale');
```

---

### ê¸°ë³¸ ìƒì„±

```sql
-- Step 1: êµ¬ì¡° ì´í•´
CREATE INDEX idx_paper_chunks_embedding
ON paper_chunks
USING diskann (embedding vector_cosine_ops)
WITH (storage_layout = 'memory_optimized');  -- ì„ íƒì 

-- Step 2: ì‹¤ì œ ì‚¬ìš© (ê¸°ë³¸ ì„¤ì •)
CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING diskann (embedding vector_cosine_ops);

-- Step 3: ê²€ìƒ‰ (pgvectorì™€ ë™ì¼í•œ ë¬¸ë²•)
SELECT chunk_text, embedding <=> '[...]'::vector(768) AS distance
FROM paper_chunks
ORDER BY distance
LIMIT 10;
```

---

### íŒŒë¼ë¯¸í„° íŠœë‹

#### storage_layout (ì €ì¥ ë ˆì´ì•„ì›ƒ)

DiskANNì˜ ê°€ì¥ ì¤‘ìš”í•œ ì„¤ì •ì…ë‹ˆë‹¤.

| ì˜µì…˜ | ì„¤ëª… | ë©”ëª¨ë¦¬ ì‚¬ìš© | ì†ë„ | ìš©ë„ |
|------|------|------------|------|------|
| `memory_optimized` | SBQ ì••ì¶• ì‚¬ìš©, ë©”ëª¨ë¦¬ ìµœì í™” | ë‚®ìŒ | ë§¤ìš° ë¹ ë¦„ | **ê¶Œì¥** â­ |
| `disk_optimized` | ë””ìŠ¤í¬ ì¤‘ì‹¬ ì €ì¥ | ë§¤ìš° ë‚®ìŒ | ë¹ ë¦„ | ì´ˆëŒ€ê·œëª¨ (1ì–µ+) |
| (ê¸°ë³¸ê°’) | í˜¼í•© ëª¨ë“œ | ì¤‘ê°„ | ë¹ ë¦„ | ì¼ë°˜ ì‚¬ìš© |

```sql
-- ë©”ëª¨ë¦¬ ìµœì í™” (ê¶Œì¥)
CREATE INDEX idx_memory_opt 
ON paper_chunks 
USING diskann (embedding vector_cosine_ops)
WITH (storage_layout = 'memory_optimized');

-- ë””ìŠ¤í¬ ìµœì í™” (ì´ˆëŒ€ê·œëª¨)
CREATE INDEX idx_disk_opt 
ON paper_chunks 
USING diskann (embedding vector_cosine_ops)
WITH (storage_layout = 'disk_optimized');

-- ê¸°ë³¸ê°’ (í˜¼í•© ëª¨ë“œ)
CREATE INDEX idx_default 
ON paper_chunks 
USING diskann (embedding vector_cosine_ops);
```

---

#### ê¸°íƒ€ íŒŒë¼ë¯¸í„°

```sql
CREATE INDEX idx_diskann_full 
ON paper_chunks 
USING diskann (embedding vector_cosine_ops)
WITH (
    storage_layout = 'memory_optimized',  -- ì €ì¥ ë ˆì´ì•„ì›ƒ
    num_neighbors = 50,                   -- ê·¸ë˜í”„ ì—°ê²° ìˆ˜ (ê¸°ë³¸ê°’: 50)
    search_list_size = 100,               -- ê²€ìƒ‰ ë¦¬ìŠ¤íŠ¸ í¬ê¸° (ê¸°ë³¸ê°’: 100)
    max_alpha = 1.2                       -- íƒìƒ‰ ë²”ìœ„ í™•ì¥ (ê¸°ë³¸ê°’: 1.2)
);
```

| íŒŒë¼ë¯¸í„° | ê¸°ë³¸ê°’ | ë²”ìœ„ | ì˜í–¥ |
|---------|--------|------|------|
| `num_neighbors` | 50 | 20~100 | HNSWì˜ mê³¼ ìœ ì‚¬, ì—°ê²° ìˆ˜ |
| `search_list_size` | 100 | 50~200 | ê²€ìƒ‰ í›„ë³´ í¬ê¸° |
| `max_alpha` | 1.2 | 1.0~2.0 | íƒìƒ‰ ë²”ìœ„ ì¡°ì • |

---

### Statistical Binary Quantization (SBQ)

DiskANNì˜ í•µì‹¬ ê¸°ëŠ¥ ì¤‘ í•˜ë‚˜ëŠ” **SBQ ì••ì¶•**ì…ë‹ˆë‹¤.

**SBQë€?**
- ë²¡í„°ë¥¼ ì´ì§„(0/1)ìœ¼ë¡œ ì••ì¶•í•˜ë˜, í†µê³„ì  íŠ¹ì„±ì„ ê³ ë ¤
- ë©”ëª¨ë¦¬ 1/32 ì ˆì•½ (float32 â†’ 1bit)
- ì •í™•ë„ ì†ì‹¤ ìµœì†Œí™” (Recall 92~95%)

```sql
-- SBQëŠ” memory_optimized ëª¨ë“œì—ì„œ ìë™ í™œìš©
CREATE INDEX idx_diskann_sbq 
ON paper_chunks 
USING diskann (embedding vector_cosine_ops)
WITH (storage_layout = 'memory_optimized');  -- SBQ ìë™ ì ìš©
```

**ë©”ëª¨ë¦¬ ë¹„êµ:**

| í•­ëª© | HNSW | DiskANN (SBQ) | ì ˆê°ë¥  |
|------|------|--------------|--------|
| 100ë§Œ ê±´ Ã— 768ì°¨ì› | 20GB | 640MB | **97%** |
| 1ì²œë§Œ ê±´ Ã— 768ì°¨ì› | 200GB | 6.4GB | **97%** |

---

### í•„í„°ë§ ì„±ëŠ¥

DiskANNì˜ ê°€ì¥ í° ì¥ì ì€ **í•„í„° ê¸°ë°˜ ê²€ìƒ‰ ì„±ëŠ¥**ì…ë‹ˆë‹¤.

#### Label-based Filtering

```sql
-- 1) ì¸ë±ìŠ¤ ìƒì„± ì‹œ ë ˆì´ë¸” ì»¬ëŸ¼ í¬í•¨
CREATE INDEX idx_diskann_labels 
ON paper_chunks 
USING diskann (embedding vector_cosine_ops, category_id);
--                                          â†‘ í•„í„° ì»¬ëŸ¼ ì¶”ê°€

-- 2) ê²€ìƒ‰ ì‹œ í•„í„° ì‚¬ìš©
SELECT chunk_text, embedding <=> '[...]'::vector(768) AS distance
FROM paper_chunks
WHERE category_id = 5  -- í•„í„°ë§
ORDER BY distance
LIMIT 10;
```

**ì„±ëŠ¥ ë¹„êµ (100ë§Œ ê±´, í•„í„° ì¡°ê±´ 1% ì„ íƒ):**

| ì¸ë±ìŠ¤ | ê²€ìƒ‰ ì‹œê°„ | Recall@10 |
|--------|----------|-----------|
| **HNSW** | 150ms | 75% (ë¶€ì •í™•) |
| **IVFFlat** | 180ms | 70% (ë¶€ì •í™•) |
| **DiskANN** | 25ms | 98% (ì •í™•) â­ |

---

### ê²€ìƒ‰ ì˜ˆì‹œ

```sql
-- ê¸°ë³¸ ê²€ìƒ‰
SELECT chunk_text, embedding <=> '[...]'::vector(768) AS distance
FROM paper_chunks
ORDER BY distance
LIMIT 10;

-- í•„í„°ë§ ê²€ìƒ‰
SELECT chunk_text, embedding <=> '[...]'::vector(768) AS distance
FROM paper_chunks
WHERE metadata->>'language' = 'ko'  -- JSON í•„í„°
  AND created_at > '2024-01-01'     -- ë‚ ì§œ í•„í„°
ORDER BY distance
LIMIT 10;

-- ë³µì¡í•œ ì¡°ê±´
SELECT 
    p.title,
    pc.chunk_text,
    pc.embedding <=> '[...]'::vector(768) AS distance
FROM paper_chunks pc
JOIN papers p ON pc.paper_id = p.id
WHERE p.category = 'AI'
  AND p.published_year >= 2023
ORDER BY distance
LIMIT 10;
```

---

### ì¸ë±ìŠ¤ íƒ€ì… ì „ì²´ ë¹„êµ

| í•­ëª© | HNSW | IVFFlat | **DiskANN** |
|------|------|---------|-------------|
| **ì œê³µ** | pgvector | pgvector | **pgvectorscale** |
| **ì¶”ê°€ ì„¤ì¹˜** | ë¶ˆí•„ìš” | ë¶ˆí•„ìš” | **í•„ìš”** |
| **ê²€ìƒ‰ ì†ë„** | 5~10ms | 10~20ms | 5~15ms |
| **ì •í™•ë„** | 99%+ | 95%+ | 98%+ |
| **ë©”ëª¨ë¦¬ (100ë§Œ ê±´)** | 20GB | 5GB | **640MB** â­ |
| **ë¹Œë“œ ì‹œê°„ (100ë§Œ ê±´)** | 1ì‹œê°„ | 20ë¶„ | 40ë¶„ |
| **í•„í„°ë§ ì„±ëŠ¥** | ì œí•œì  | ì œí•œì  | **ìš°ìˆ˜** â­ |
| **ìµœì  ë°ì´í„°** | 10ë§Œ~100ë§Œ | 100ë§Œ~1ì²œë§Œ | **100ë§Œ~10ì–µ** â­ |
| **SBQ ì••ì¶•** | âŒ | âŒ | **âœ…** |

---

### ì‹¤ì „ ì‚¬ìš© ì˜ˆì‹œ

#### ì‹œë‚˜ë¦¬ì˜¤ 1: 500ë§Œ ê°œ ë…¼ë¬¸ ê²€ìƒ‰

```sql
-- 1) í…Œì´ë¸” ìƒì„±
CREATE TABLE research_papers (
    id BIGSERIAL PRIMARY KEY,
    title TEXT,
    abstract TEXT,
    category_id SMALLINT,
    embedding VECTOR(768)
);

-- 2) DiskANN ì¸ë±ìŠ¤ ìƒì„± (ì¹´í…Œê³ ë¦¬ í•„í„° í¬í•¨)
CREATE INDEX idx_papers_diskann 
ON research_papers 
USING diskann (embedding vector_cosine_ops, category_id)
WITH (storage_layout = 'memory_optimized');

-- 3) ì¹´í…Œê³ ë¦¬ë³„ ê²€ìƒ‰
SELECT title, abstract, embedding <=> '[...]'::vector(768) AS distance
FROM research_papers
WHERE category_id = 3  -- AI ì¹´í…Œê³ ë¦¬
ORDER BY distance
LIMIT 20;
```

**ê²°ê³¼:**
- ë©”ëª¨ë¦¬: 3.2GB (HNSW ëŒ€ë¹„ 94% ì ˆê°)
- ê²€ìƒ‰ ì‹œê°„: 18ms (í•„í„°ë§ í¬í•¨)
- Recall@20: 97%

---

#### ì‹œë‚˜ë¦¬ì˜¤ 2: 1ì–µ ê°œ ì´ë¯¸ì§€ ê²€ìƒ‰

```sql
-- 1) í…Œì´ë¸” ìƒì„±
CREATE TABLE images (
    id BIGSERIAL PRIMARY KEY,
    filename TEXT,
    user_id BIGINT,
    tags TEXT[],
    embedding VECTOR(512)
);

-- 2) DiskANN ì¸ë±ìŠ¤ (ë””ìŠ¤í¬ ìµœì í™”)
CREATE INDEX idx_images_diskann 
ON images 
USING diskann (embedding vector_cosine_ops)
WITH (storage_layout = 'disk_optimized');

-- 3) ê²€ìƒ‰
SELECT filename, embedding <=> '[...]'::vector(512) AS distance
FROM images
WHERE user_id = 12345
ORDER BY distance
LIMIT 50;
```

**ê²°ê³¼:**
- ë©”ëª¨ë¦¬: 8GB (1ì–µ ê±´ì¸ë°ë„ ë‚®ìŒ!)
- ê²€ìƒ‰ ì‹œê°„: 35ms
- Recall@50: 96%

---

### ì£¼ì˜ì‚¬í•­

#### 1. pgvectorscale ì˜ì¡´ì„±

```sql
-- âŒ ì—ëŸ¬: pgvectorscale ë¯¸ì„¤ì¹˜
CREATE INDEX idx_diskann ON embeddings
USING diskann (embedding vector_cosine_ops);
-- ERROR: access method "diskann" does not exist

-- âœ… í•´ê²°: pgvectorscale ì„¤ì¹˜
CREATE EXTENSION IF NOT EXISTS vectorscale CASCADE;
```

---

#### 2. ë””ìŠ¤í¬ I/O ì„±ëŠ¥

DiskANNì€ ë””ìŠ¤í¬ë¥¼ í™œìš©í•˜ë¯€ë¡œ **SSD ê¶Œì¥**ì…ë‹ˆë‹¤.

| ìŠ¤í† ë¦¬ì§€ | ê²€ìƒ‰ ì‹œê°„ | ë¹„ê³  |
|---------|----------|------|
| **NVMe SSD** | 10~15ms | ê¶Œì¥ â­ |
| **SATA SSD** | 20~30ms | ì‚¬ìš© ê°€ëŠ¥ |
| **HDD** | 100~200ms | ê¶Œì¥í•˜ì§€ ì•ŠìŒ |

---

#### 3. UNLOGGED í…Œì´ë¸” ë¯¸ì§€ì›

```sql
-- âŒ ì—ëŸ¬
CREATE UNLOGGED TABLE embeddings (...);
CREATE INDEX ON embeddings USING diskann (embedding vector_cosine_ops);
-- ERROR: DiskANN does not support UNLOGGED tables

-- âœ… ì¼ë°˜ í…Œì´ë¸” ì‚¬ìš©
CREATE TABLE embeddings (...);
```

---

#### 4. Relaxed Ordering (ì•½ê°„ì˜ ìˆœì„œ ë³€ë™)

DiskANNì€ ê²€ìƒ‰ ê²°ê³¼ê°€ **ì•½ê°„ ìˆœì„œê°€ ë°”ë€” ìˆ˜ ìˆìŠµë‹ˆë‹¤** (ê±°ë¦¬ ê°’ì€ ì •í™•í•˜ì§€ë§Œ ìˆœìœ„ê°€ ë¯¸ì„¸í•˜ê²Œ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ).

ì—„ê²©í•œ ìˆœì„œê°€ í•„ìš”í•˜ë©´:

```sql
-- Materialized CTEë¡œ ì—„ê²©í•œ ìˆœì„œ ë³´ì¥
WITH relaxed_results AS MATERIALIZED (
    SELECT id, embedding <=> '[...]'::vector(768) AS distance
    FROM embeddings
    ORDER BY distance
    LIMIT 100
)
SELECT * FROM relaxed_results
ORDER BY distance  -- ì¬ì •ë ¬
LIMIT 10;
```

---

### ì–¸ì œ DiskANNì„ ì‚¬ìš©í• ê¹Œ?

#### âœ… DiskANN ì¶”ì²œ

1. **ëŒ€ê·œëª¨ ë°ì´í„°** (100ë§Œ~10ì–µ ê±´)
2. **ë©”ëª¨ë¦¬ ì œì•½** (ì„œë²„ RAMì´ ë¶€ì¡±í•œ ê²½ìš°)
3. **í•„í„°ë§ì´ ë§ì€ ê²€ìƒ‰** (ì¹´í…Œê³ ë¦¬, ë‚ ì§œ, ì‚¬ìš©ìë³„)
4. **ë¹„ìš© ì ˆê°** (í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ ë©”ëª¨ë¦¬ ë¹„ìš© ê°ì†Œ)

#### âŒ DiskANN ë¶ˆí•„ìš”

1. **ì†Œê·œëª¨ ë°ì´í„°** (10ë§Œ ê±´ ì´í•˜) â†’ HNSW ì‚¬ìš©
2. **ë©”ëª¨ë¦¬ ì¶©ë¶„** â†’ HNSWê°€ ë” ê°„ë‹¨
3. **ìµœê³  ì†ë„** (5ms ì´í•˜) â†’ HNSW
4. **ì„¤ì¹˜ ë³µì¡ë„ íšŒí”¼** â†’ pgvectorë§Œ ì‚¬ìš©

---

### DiskANN ì„¤ì¹˜ ë° ì‚¬ìš© ìš”ì•½

```sql
-- 1) pgvectorscale ì„¤ì¹˜ (Dockerfile ë˜ëŠ” íŒ¨í‚¤ì§€ ê´€ë¦¬ì)
-- apt install postgresql-18-pgvectorscale

-- 2) í™•ì¥ í™œì„±í™”
CREATE EXTENSION IF NOT EXISTS vectorscale CASCADE;

-- 3) ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_diskann 
ON embeddings 
USING diskann (embedding vector_cosine_ops)
WITH (storage_layout = 'memory_optimized');

-- 4) ê²€ìƒ‰ (pgvectorì™€ ë™ì¼)
SELECT * FROM embeddings
ORDER BY embedding <=> '[...]'::vector(768)
LIMIT 10;
```

**í•µì‹¬ ì¥ì :**
- ğŸ’¾ ë©”ëª¨ë¦¬ 97% ì ˆê°
- âš¡ HNSWì™€ ìœ ì‚¬í•œ ì†ë„
- ğŸ¯ í•„í„°ë§ ê²€ìƒ‰ ì„±ëŠ¥ ìš°ìˆ˜
- ğŸ“ˆ 10ì–µ ê±´ê¹Œì§€ í™•ì¥ ê°€ëŠ¥

---

## 4) Partial Index (ë¶€ë¶„ ì¸ë±ìŠ¤)

### ê°œë…

íŠ¹ì • ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” í–‰ë“¤ë§Œ ì¸ë±ì‹±í•©ë‹ˆë‹¤.

**ëª©ì :**
- ì¸ë±ìŠ¤ í¬ê¸° ê°ì†Œ
- ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•
- ë©”ëª¨ë¦¬ ì ˆì•½

---

### ìƒì„± ë°©ë²•

```sql
-- í•œêµ­ì–´ ë…¼ë¬¸ë§Œ ì¸ë±ì‹±
CREATE INDEX idx_korean_papers 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WHERE metadata->>'language' = 'ko';

-- ìµœê·¼ 1ë…„ ë°ì´í„°ë§Œ
CREATE INDEX idx_recent_papers 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WHERE created_at > NOW() - INTERVAL '1 year';

-- íŠ¹ì • ì¹´í…Œê³ ë¦¬ë§Œ
CREATE INDEX idx_ai_papers 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WHERE metadata->>'category' = 'AI';
```

---

### ê²€ìƒ‰ ì‹œ ì£¼ì˜ì‚¬í•­

**Partial IndexëŠ” WHERE ì¡°ê±´ì´ ì¼ì¹˜í•´ì•¼ ì‚¬ìš©ë©ë‹ˆë‹¤.**

```sql
-- âœ… ì¸ë±ìŠ¤ ì‚¬ìš© (WHERE ì¡°ê±´ ì¼ì¹˜)
SELECT * FROM paper_chunks
WHERE metadata->>'language' = 'ko'
ORDER BY embedding <=> '[...]'::vector(768)
LIMIT 10;

-- âŒ ì¸ë±ìŠ¤ ë¯¸ì‚¬ìš© (WHERE ì¡°ê±´ ì—†ìŒ)
SELECT * FROM paper_chunks
ORDER BY embedding <=> '[...]'::vector(768)
LIMIT 10;

-- âŒ ì¸ë±ìŠ¤ ë¯¸ì‚¬ìš© (ë‹¤ë¥¸ ì¡°ê±´)
SELECT * FROM paper_chunks
WHERE metadata->>'language' = 'en'
ORDER BY embedding <=> '[...]'::vector(768)
LIMIT 10;
```

---

### ë‹¤ì¤‘ Partial Index

```sql
-- ì–¸ì–´ë³„ ì¸ë±ìŠ¤ ë¶„ë¦¬
CREATE INDEX idx_korean 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WHERE metadata->>'language' = 'ko';

CREATE INDEX idx_english 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WHERE metadata->>'language' = 'en';

-- ê²€ìƒ‰
SELECT chunk_text, embedding <=> '[...]'::vector(768) AS distance
FROM paper_chunks
WHERE metadata->>'language' = 'ko'
ORDER BY distance
LIMIT 10;
```

---

### íš¨ê³¼

| í•­ëª© | ì „ì²´ ì¸ë±ìŠ¤ | Partial Index |
|------|-----------|---------------|
| ì¸ë±ìŠ¤ í¬ê¸° | 100% | 10% ~ 50% |
| ë¹Œë“œ ì‹œê°„ | 10ë¶„ | 1ë¶„ ~ 5ë¶„ |
| ê²€ìƒ‰ ì†ë„ | 10ms | 8ms (ì•½ê°„ ë¹ ë¦„) |
| ë©”ëª¨ë¦¬ ì‚¬ìš© | 2GB | 200MB ~ 1GB |

---

## 5) Partitioning (íŒŒí‹°ì…”ë‹)

### ê°œìš”

í…Œì´ë¸”ì„ ì—¬ëŸ¬ ë¬¼ë¦¬ì  íŒŒí‹°ì…˜ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ê´€ë¦¬í•©ë‹ˆë‹¤.

**ëª©ì :**
- ëŒ€ìš©ëŸ‰ í…Œì´ë¸” ì„±ëŠ¥ í–¥ìƒ
- ì˜¤ë˜ëœ ë°ì´í„° ì‚­ì œ ìš©ì´
- ë°±ì—…/ë³µêµ¬ íš¨ìœ¨í™”

---

### Range Partitioning (ë‚ ì§œ ê¸°ë°˜)

```sql
-- íŒŒí‹°ì…˜ ë¶€ëª¨ í…Œì´ë¸”
CREATE TABLE paper_chunks (
    id BIGSERIAL,
    paper_id TEXT NOT NULL,
    chunk_index INT NOT NULL,
    chunk_text TEXT NOT NULL,
    embedding vector(768) NOT NULL,
    created_at DATE NOT NULL,
    PRIMARY KEY (id, created_at)
) PARTITION BY RANGE (created_at);

-- ì›”ë³„ íŒŒí‹°ì…˜ ìƒì„±
CREATE TABLE paper_chunks_2024_01 PARTITION OF paper_chunks
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE paper_chunks_2024_02 PARTITION OF paper_chunks
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

CREATE TABLE paper_chunks_2024_03 PARTITION OF paper_chunks
    FOR VALUES FROM ('2024-03-01') TO ('2024-04-01');

-- ê° íŒŒí‹°ì…˜ì— ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_chunks_2024_01_embedding 
ON paper_chunks_2024_01 
USING hnsw (embedding vector_cosine_ops);

CREATE INDEX idx_chunks_2024_02_embedding 
ON paper_chunks_2024_02 
USING hnsw (embedding vector_cosine_ops);

CREATE INDEX idx_chunks_2024_03_embedding 
ON paper_chunks_2024_03 
USING hnsw (embedding vector_cosine_ops);
```

---

### List Partitioning (ë…¼ë¬¸ë³„)

```sql
-- ë…¼ë¬¸ë³„ íŒŒí‹°ì…˜
CREATE TABLE paper_chunks (
    id BIGSERIAL,
    paper_id TEXT NOT NULL,
    chunk_index INT NOT NULL,
    chunk_text TEXT NOT NULL,
    embedding vector(768) NOT NULL,
    PRIMARY KEY (id, paper_id)
) PARTITION BY LIST (paper_id);

-- ë…¼ë¬¸ë³„ íŒŒí‹°ì…˜ ìƒì„±
CREATE TABLE paper_chunks_kim PARTITION OF paper_chunks
    FOR VALUES IN ('kim_phd_2024');

CREATE TABLE paper_chunks_lee PARTITION OF paper_chunks
    FOR VALUES IN ('lee_phd_2024');

-- ê° íŒŒí‹°ì…˜ì— ì¸ë±ìŠ¤
CREATE INDEX idx_kim_embedding 
ON paper_chunks_kim 
USING hnsw (embedding vector_cosine_ops);

CREATE INDEX idx_lee_embedding 
ON paper_chunks_lee 
USING hnsw (embedding vector_cosine_ops);
```

---

### ì¥ì 

```
âœ… íŠ¹ì • íŒŒí‹°ì…˜ë§Œ ê²€ìƒ‰ (ë¹ ë¦„)
âœ… ì˜¤ë˜ëœ íŒŒí‹°ì…˜ ì‚­ì œ ìš©ì´
âœ… íŒŒí‹°ì…˜ë³„ ë…ë¦½ì  ì¸ë±ìŠ¤ ê´€ë¦¬
âœ… ë°±ì—…/ë³µêµ¬ ë‹¨ìœ„ ì¶•ì†Œ
```

### ë‹¨ì 

```
âŒ ê´€ë¦¬ ë³µì¡ë„ ì¦ê°€
âŒ íŒŒí‹°ì…˜ ê°„ ì¿¼ë¦¬ ëŠë¦¼
âŒ íŒŒí‹°ì…˜ í‚¤ ë³€ê²½ ë¶ˆê°€
```

### ê¶Œì¥

```
ë°ì´í„° 100ë§Œ ê±´ ì´ìƒ + ì‹œê³„ì—´/ë…¼ë¬¸ë³„ ë¶„ë¦¬ í•„ìš” ì‹œ
â†’ Partitioning ê³ ë ¤
```

---

## 6) ì¸ë±ìŠ¤ ë¹Œë“œ ì„±ëŠ¥ ìµœì í™”

### ëŒ€ëŸ‰ INSERT ì‹œ ì „ëµ

```sql
-- âŒ ë‚˜ìœ ë°©ë²•: ì¸ë±ìŠ¤ ë¨¼ì € ìƒì„±
CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops);

INSERT INTO paper_chunks ...;  -- ë§¤ìš° ëŠë¦¼!

-- âœ… ì¢‹ì€ ë°©ë²•: ë°ì´í„° ë¨¼ì € ì‚½ì…
INSERT INTO paper_chunks ...;  -- ë¹ ë¦„

CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops);  -- í•œ ë²ˆì— ë¹Œë“œ
```

**ì´ìœ :**  
ì¸ë±ìŠ¤ê°€ ìˆìœ¼ë©´ INSERTë§ˆë‹¤ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸ â†’ ëŠë¦¼

---

### ë©”ëª¨ë¦¬ ì„¤ì •

```sql
-- ì¸ë±ìŠ¤ ë¹Œë“œ ì „ ë©”ëª¨ë¦¬ ì¦ê°€
SET maintenance_work_mem = '2GB';  -- ê¸°ë³¸ê°’: 64MB

CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 24, ef_construction = 128);

-- ì›ë˜ëŒ€ë¡œ ë³µêµ¬
RESET maintenance_work_mem;
```

**ê¶Œì¥:**

| ë°ì´í„° ê·œëª¨ | maintenance_work_mem |
|-----------|---------------------|
| < 10,000ê±´ | 256MB |
| 10,000 ~ 100,000ê±´ | 512MB ~ 1GB |
| > 100,000ê±´ | 1GB ~ 4GB |

---

### ë³‘ë ¬ ë¹Œë“œ (PostgreSQL 11+)

```sql
-- ë³‘ë ¬ ì›Œì»¤ ì„¤ì •
SET max_parallel_maintenance_workers = 4;  -- ê¸°ë³¸ê°’: 2

CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops);

-- ì›ë˜ëŒ€ë¡œ ë³µêµ¬
RESET max_parallel_maintenance_workers;
```

**íš¨ê³¼:**  
ë¹Œë“œ ì‹œê°„ 20% ~ 50% ë‹¨ì¶• (CPU ì½”ì–´ ìˆ˜ì— ë”°ë¼ ë‹¤ë¦„)

---

### ì¸ë±ìŠ¤ ë¹Œë“œ ëª¨ë‹ˆí„°ë§
- ì™„ë£Œ ëœ index ì— ëŒ€í•œ ë¡œê·¸ëŠ” ë”°ë¡œ ë‚¨ê¸°ì§€ ì•Šì•„ì„œ, ì„¤ì •ì„ ë”°ë¡œ on í•´ì•¼ í•˜ê³  ì§„í–‰ì¤‘ì¸ ê²ƒë§Œ í™•ì¸ ê°€ëŠ¥

```sql
-- ì§„í–‰ë¥  í™•ì¸ (PostgreSQL 12+)
SELECT 
    phase,
    round(100.0 * blocks_done / nullif(blocks_total, 0), 1) AS "% complete",
    blocks_done,
    blocks_total
FROM pg_stat_progress_create_index;
```

---

## 7) ì¸ë±ìŠ¤ ê´€ë¦¬

### ì¸ë±ìŠ¤ ëª©ë¡ í™•ì¸

```sql
-- í…Œì´ë¸”ì˜ ëª¨ë“  ì¸ë±ìŠ¤ ì¡°íšŒ
SELECT 
    indexname,
    indexdef
FROM pg_indexes
WHERE tablename = 'paper_chunks';
```

---

### ì¸ë±ìŠ¤ í¬ê¸° í™•ì¸

```sql
-- ì¸ë±ìŠ¤ í¬ê¸° ì¡°íšŒ
SELECT 
    indexname,
    pg_size_pretty(pg_relation_size(indexname::regclass)) AS index_size
FROM pg_indexes
WHERE tablename = 'paper_chunks';
```

**ì˜ˆìƒ í¬ê¸°:**

| ë°ì´í„° ê·œëª¨ | HNSW | IVFFlat | DiskANN (SBQ) |
|-----------|------|---------|---------------|
| 10,000ê±´ Ã— 768ì°¨ì› | ~200MB | ~100MB | ~6MB |
| 100,000ê±´ Ã— 768ì°¨ì› | ~2GB | ~1GB | ~64MB |
| 1,000,000ê±´ Ã— 768ì°¨ì› | ~20GB | ~10GB | ~640MB |

---

### ì¸ë±ìŠ¤ ì¬êµ¬ì¶•

```sql
-- ëŒ€ëŸ‰ INSERT/UPDATE/DELETE í›„ ì„±ëŠ¥ ì €í•˜ ì‹œ
REINDEX INDEX idx_paper_chunks_embedding;

-- í…Œì´ë¸” ì „ì²´ ì¸ë±ìŠ¤ ì¬êµ¬ì¶•
REINDEX TABLE paper_chunks;
```

---

### ì¸ë±ìŠ¤ ì‚­ì œ

```sql
-- ì¸ë±ìŠ¤ ì‚­ì œ (ê²€ìƒ‰ ëŠë ¤ì§)
DROP INDEX idx_paper_chunks_embedding;

-- IF EXISTS ì‚¬ìš© (ì•ˆì „)
DROP INDEX IF EXISTS idx_paper_chunks_embedding;
```

---

### ì¸ë±ìŠ¤ ì‚¬ìš© ì—¬ë¶€ í™•ì¸

```sql
-- ì¿¼ë¦¬ ì‹¤í–‰ ê³„íš í™•ì¸
EXPLAIN ANALYZE
SELECT chunk_text, embedding <=> '[...]'::vector(768) AS distance
FROM paper_chunks
ORDER BY distance
LIMIT 10;

-- ì¸ë±ìŠ¤ ì‚¬ìš©: "Index Scan using idx_paper_chunks_embedding"
-- ì¸ë±ìŠ¤ ë¯¸ì‚¬ìš©: "Seq Scan on paper_chunks"
```

---

## 8) ì‹¤ì „ ê¶Œì¥ì‚¬í•­

### ë…¼ë¬¸ RAG ì‹œìŠ¤í…œ

```sql
-- ë…¼ë¬¸ ìˆ˜ < 10ê°œ (ì²­í¬ < 100ê°œ):
â†’ ì¸ë±ìŠ¤ ë¶ˆí•„ìš”

-- ë…¼ë¬¸ ìˆ˜ 10 ~ 100ê°œ (ì²­í¬ 100 ~ 1,000ê°œ):
â†’ ì¸ë±ìŠ¤ ë¶ˆí•„ìš” (ë˜ëŠ” ê°„ë‹¨í•œ HNSW)

-- ë…¼ë¬¸ ìˆ˜ 100 ~ 1,000ê°œ (ì²­í¬ 1,000 ~ 10,000ê°œ):
â†’ HNSW ì¸ë±ìŠ¤ ìƒì„± âœ…
CREATE INDEX ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- ë…¼ë¬¸ ìˆ˜ > 1,000ê°œ (ì²­í¬ > 10,000ê±´):
â†’ HNSW ì¸ë±ìŠ¤ (íŒŒë¼ë¯¸í„° ì¡°ì •) âœ…
CREATE INDEX ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 24, ef_construction = 128);

-- ë…¼ë¬¸ ìˆ˜ > 10,000ê°œ (ì²­í¬ > 100,000ê±´):
â†’ IVFFlat ë˜ëŠ” DiskANN ê³ ë ¤

-- ë…¼ë¬¸ ìˆ˜ > 100,000ê°œ (ì²­í¬ > 1,000,000ê±´):
â†’ DiskANN (pgvectorscale) ê¶Œì¥ âœ…
CREATE INDEX ON paper_chunks 
USING diskann (embedding vector_cosine_ops)
WITH (storage_layout = 'memory_optimized');
```

---

### ì¼ë°˜ ì›ì¹™

| ë°ì´í„° ê·œëª¨ | ì¸ë±ìŠ¤ ì „ëµ | ë¹„ê³  |
|-----------|-----------|------|
| < 1,000ê±´ | ì¸ë±ìŠ¤ ë¶ˆí•„ìš” | ìˆœì°¨ ìŠ¤ìº”ì´ ë” ë¹ ë¦„ |
| 1,000 ~ 10,000ê±´ | HNSW (ê¸°ë³¸ ì„¤ì •) | m=16, ef_construction=64 |
| 10,000 ~ 100,000ê±´ | HNSW (íŒŒë¼ë¯¸í„° ì¡°ì •) | m=24, ef_construction=128 |
| 100,000 ~ 1,000,000ê±´ | HNSW ë˜ëŠ” IVFFlat | ë©”ëª¨ë¦¬ ì—¬ìœ ì— ë”°ë¼ |
| 1,000,000 ~ 10,000,000ê±´ | IVFFlat ë˜ëŠ” DiskANN | DiskANN ê¶Œì¥ |
| > 10,000,000ê±´ | **DiskANN** | pgvectorscale í•„ìˆ˜ |

---

### ì²´í¬ë¦¬ìŠ¤íŠ¸

```
âœ… ë°ì´í„° INSERT ì™„ë£Œ í›„ ì¸ë±ìŠ¤ ìƒì„±
âœ… ê²€ìƒ‰ ì‹œ ì‚¬ìš©í•  ê±°ë¦¬ í•¨ìˆ˜ì— ë§ëŠ” ops ì„ íƒ
âœ… maintenance_work_mem ì¶©ë¶„íˆ í• ë‹¹
âœ… EXPLAIN ANALYZEë¡œ ì¸ë±ìŠ¤ ì‚¬ìš© í™•ì¸
âœ… ì •ê¸°ì ìœ¼ë¡œ ì¸ë±ìŠ¤ í¬ê¸° ëª¨ë‹ˆí„°ë§
âœ… ì„±ëŠ¥ ì €í•˜ ì‹œ REINDEX ì‹¤í–‰
âœ… ëŒ€ê·œëª¨ ë°ì´í„°(100ë§Œ+)ëŠ” DiskANN ê³ ë ¤
âœ… í•„í„°ë§ ë§ì€ ê²€ìƒ‰ì€ DiskANN ê¶Œì¥
```

---

## 9) ìš”ì•½

### ì¸ë±ìŠ¤ íƒ€ì…ë³„ ì„ íƒ ê°€ì´ë“œ

| ìƒí™© | ì¸ë±ìŠ¤ ì „ëµ | ì„¤ì • |
|------|-----------|------|
| **ì†Œê·œëª¨ RAG** | ì¸ë±ìŠ¤ ë¶ˆí•„ìš” | - |
| **ì¼ë°˜ RAG** | HNSW | m=16, ef_construction=64 |
| **ê³ ì •í™•ë„ RAG** | HNSW | m=24, ef_construction=128 |
| **ëŒ€ìš©ëŸ‰ ì‹œìŠ¤í…œ** | IVFFlat | lists=âˆš(í–‰ ìˆ˜) |
| **ì´ˆëŒ€ìš©ëŸ‰ + ë©”ëª¨ë¦¬ ì œì•½** | **DiskANN** | storage_layout='memory_optimized' |
| **íŠ¹ì • ì¡°ê±´ë§Œ** | Partial Index | WHERE ì ˆ ì¶”ê°€ |
| **ì‹œê³„ì—´ ë°ì´í„°** | Partitioning | RANGE íŒŒí‹°ì…˜ |

---

### ë°ì´í„° ê·œëª¨ë³„ ìµœì  ì¸ë±ìŠ¤

| ë°ì´í„° ê·œëª¨ | 1ìˆœìœ„ | 2ìˆœìœ„ | 3ìˆœìœ„ |
|-----------|------|------|------|
| **< 10ë§Œ** | HNSW | - | - |
| **10ë§Œ~100ë§Œ** | HNSW | IVFFlat | - |
| **100ë§Œ~1ì²œë§Œ** | DiskANN | IVFFlat | HNSW |
| **1ì²œë§Œ~1ì–µ** | DiskANN | IVFFlat | - |
| **1ì–µ+** | DiskANN | - | - |

---

### í…ìŠ¤íŠ¸ ê²€ìƒ‰ ê¸°ë³¸ í…œí”Œë¦¿

**HNSW (ì†Œ~ì¤‘ê·œëª¨):**
```sql
-- ë°ì´í„° INSERT
INSERT INTO paper_chunks ...;

-- HNSW ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- ê²€ìƒ‰
SELECT chunk_text, embedding <=> %s AS distance
FROM paper_chunks
WHERE paper_id = %s
ORDER BY distance
LIMIT 10;
```

**DiskANN (ëŒ€ê·œëª¨):**
```sql
-- 1) pgvectorscale ì„¤ì¹˜ ë° í™œì„±í™”
CREATE EXTENSION IF NOT EXISTS vectorscale CASCADE;

-- 2) ë°ì´í„° INSERT
INSERT INTO paper_chunks ...;

-- 3) DiskANN ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING diskann (embedding vector_cosine_ops)
WITH (storage_layout = 'memory_optimized');

-- 4) ê²€ìƒ‰ (ë™ì¼í•œ ë¬¸ë²•)
SELECT chunk_text, embedding <=> %s AS distance
FROM paper_chunks
WHERE paper_id = %s
ORDER BY distance
LIMIT 10;
```

---

### í•µì‹¬ í¬ì¸íŠ¸

1. **HNSW**: 10ë§Œ~100ë§Œ ê±´, ë†’ì€ ì •í™•ë„, ë©”ëª¨ë¦¬ ë§ì´ ì‚¬ìš©
2. **IVFFlat**: 100ë§Œ~1ì²œë§Œ ê±´, ë¹ ë¥¸ ë¹Œë“œ, ì¤‘ê°„ ì •í™•ë„
3. **DiskANN**: 100ë§Œ~10ì–µ ê±´, ë©”ëª¨ë¦¬ íš¨ìœ¨, í•„í„°ë§ ìš°ìˆ˜ (pgvectorscale í•„ìš”)
4. ë°ì´í„° ë¨¼ì € ì‚½ì… â†’ ì¸ë±ìŠ¤ ìƒì„±
5. ê²€ìƒ‰ ì‹œ operator classì™€ ì—°ì‚°ì ì¼ì¹˜ í•„ìˆ˜
6. ëŒ€ê·œëª¨ ë°ì´í„°ëŠ” DiskANN ì ê·¹ ê³ ë ¤

---