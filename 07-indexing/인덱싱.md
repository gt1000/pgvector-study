# ğŸ“˜ 07. ì¸ë±ì‹± (Indexing)

pgvectorì˜ ë²¡í„° ê²€ìƒ‰ ì„±ëŠ¥ì„ ìµœì í™”í•˜ëŠ” ì¸ë±ìŠ¤ ìƒì„± ë° ê´€ë¦¬ ë°©ë²•ì„ ë‹¤ë£¹ë‹ˆë‹¤.

> ğŸ¯ **ì´ ë¬¸ì„œì˜ ëª©í‘œ:**  
> ëŒ€ëŸ‰ì˜ ë…¼ë¬¸ ë°ì´í„°ì—ì„œ ë¹ ë¥¸ ë²¡í„° ê²€ìƒ‰ì„ ìœ„í•œ ì¸ë±ìŠ¤ ì „ëµ ìˆ˜ë¦½  
> ë°˜ë“œì‹œ ì•„ë˜ ë§í¬ë¥¼ í•„ë…  
> https://alex-jacobs.com/posts/the-case-against-pgvector/

---

## 1) HNSW ì¸ë±ìŠ¤ (ê¶Œì¥)

### ê°œìš”

**HNSW (Hierarchical Navigable Small World)**ëŠ” pgvectorì—ì„œ ê°€ì¥ ë§ì´ ì‚¬ìš©ë˜ëŠ” ì¸ë±ìŠ¤ ë°©ì‹ì…ë‹ˆë‹¤.

**íŠ¹ì§•:**
- ë¹ ë¥¸ ê²€ìƒ‰ ì†ë„ (10ms ì´í•˜)
- ë†’ì€ ì •í™•ë„ (99%+)
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë§ìŒ
- **10ë§Œ ê±´ ì´í•˜ ë°ì´í„°ì— ìµœì **

---

### ê¸°ë³¸ êµ¬ì¡° ì´í•´
```sql
CREATE INDEX ì¸ë±ìŠ¤_ì´ë¦„
ON í…Œì´ë¸”_ì´ë¦„
USING hnsw (ì»¬ëŸ¼ëª… operator_class)
WITH (íŒŒë¼ë¯¸í„°);
```

**ê° ë¶€ë¶„ ì„¤ëª…:**

| ë¶€ë¶„ | ì—­í•  | ì˜ˆì‹œ |
|------|------|------|
| `ì¸ë±ìŠ¤_ì´ë¦„` | ì¸ë±ìŠ¤ ì‹ë³„ì | `idx_paper_chunks_embedding` |
| `í…Œì´ë¸”_ì´ë¦„` | ëŒ€ìƒ í…Œì´ë¸” | `paper_chunks` |
| `hnsw` | ì¸ë±ìŠ¤ ì•Œê³ ë¦¬ì¦˜ (ê³ ì •) | pgvectorì˜ HNSW ë°©ì‹ |
| `ì»¬ëŸ¼ëª…` | ì¸ë±ì‹±í•  ë²¡í„° ì»¬ëŸ¼ | `embedding` |
| `operator_class` | ìµœì í™”í•  ê±°ë¦¬ í•¨ìˆ˜ | `vector_cosine_ops` |
| `íŒŒë¼ë¯¸í„°` | ì„±ëŠ¥ íŠœë‹ ì˜µì…˜ | `m = 16, ef_construction = 64` |

---

### Operator Classë€?

**ì •ì˜:**  
PostgreSQLì—ê²Œ **"ì´ ì¸ë±ìŠ¤ê°€ ì–´ë–¤ ê±°ë¦¬ í•¨ìˆ˜(ì—°ì‚°ì)ë¥¼ ë¹ ë¥´ê²Œ ì²˜ë¦¬í•  ê²ƒì¸ì§€"** ì•Œë ¤ì£¼ëŠ” **pgvector í™•ì¥ì´ ì œê³µí•˜ëŠ” ì‚¬ì „ ì •ì˜ëœ ì´ë¦„**ì…ë‹ˆë‹¤.

**ì¶œì²˜:**  
pgvector í™•ì¥ì„ ì„¤ì¹˜í•˜ë©´ PostgreSQLì— ìë™ìœ¼ë¡œ ë“±ë¡ë˜ëŠ” **ì˜ˆì•½ëœ ì´ë¦„ ì„¸íŠ¸**ì…ë‹ˆë‹¤.
```sql
-- pgvector ì„¤ì¹˜ ì‹œ ìë™ìœ¼ë¡œ ë“±ë¡ë˜ëŠ” Operator Classes
-- (ì‚¬ìš©ìê°€ ë§Œë“œëŠ” ê²ƒì´ ì•„ë‹˜, pgvectorê°€ ì œê³µ)

vector_l2_ops       -- L2 Distance (<->) ì „ìš©
vector_cosine_ops   -- Cosine Distance (<=>) ì „ìš©
vector_ip_ops       -- Inner Product (<#>) ì „ìš©
vector_l1_ops       -- L1 Distance (<+>) ì „ìš©
```

**í™•ì¸ ë°©ë²•:**
```sql
-- PostgreSQLì— ë“±ë¡ëœ operator class ëª©ë¡ í™•ì¸
SELECT opcname, opcmethod 
FROM pg_opclass 
WHERE opcname LIKE 'vector%';

-- ê²°ê³¼:
-- opcname             | opcmethod
-- --------------------|----------
-- vector_l2_ops       | hnsw
-- vector_cosine_ops   | hnsw
-- vector_ip_ops       | hnsw
-- vector_l1_ops       | hnsw
```

---

### Operator Classì™€ ê±°ë¦¬ í•¨ìˆ˜ ë§¤í•‘

**í•µì‹¬ ì›ì¹™:**  
ì¸ë±ìŠ¤ ìƒì„± ì‹œ ì‚¬ìš©í•œ operator classì™€ ê²€ìƒ‰ ì‹œ ì‚¬ìš©í•˜ëŠ” ì—°ì‚°ìê°€ **ë°˜ë“œì‹œ ì¼ì¹˜**í•´ì•¼ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

| ê²€ìƒ‰ ì‹œ ì‚¬ìš©í•  ì—°ì‚°ì | ì¸ë±ìŠ¤ ìƒì„± ì‹œ Operator Class | ìš©ë„ |
|---------------------|----------------------------|------|
| `<=>` (Cosine Distance) | `vector_cosine_ops` | **í…ìŠ¤íŠ¸ ê²€ìƒ‰** â­ |
| `<->` (L2 Distance) | `vector_l2_ops` | ì´ë¯¸ì§€ ê²€ìƒ‰ |
| `<#>` (Inner Product) | `vector_ip_ops` | ì¶”ì²œ ì‹œìŠ¤í…œ |
| `<+>` (L1 Distance) | `vector_l1_ops` | í¬ì†Œ ë²¡í„° |

**ì™œ ë§¤ì¹­ì´ ì¤‘ìš”í•œê°€?**
```sql
-- âŒ ì˜ëª»ëœ ì˜ˆ: operator classì™€ ê²€ìƒ‰ ì—°ì‚°ì ë¶ˆì¼ì¹˜
CREATE INDEX idx_wrong 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops);  -- Cosineìš© ì¸ë±ìŠ¤

SELECT * FROM paper_chunks
ORDER BY embedding <-> '[...]'  -- L2 ì—°ì‚°ì ì‚¬ìš©
LIMIT 10;
-- ê²°ê³¼: ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì§€ ëª»í•¨! (Seq Scan = ëŠë¦¼)

-- âœ… ì˜¬ë°”ë¥¸ ì˜ˆ: operator classì™€ ê²€ìƒ‰ ì—°ì‚°ì ì¼ì¹˜
CREATE INDEX idx_correct 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops);  -- Cosineìš© ì¸ë±ìŠ¤

SELECT * FROM paper_chunks
ORDER BY embedding <=> '[...]'  -- Cosine ì—°ì‚°ì ì‚¬ìš© (ì¼ì¹˜!)
LIMIT 10;
-- ê²°ê³¼: ì¸ë±ìŠ¤ ì‚¬ìš©! (Index Scan = ë¹ ë¦„)
```

---

### ê¸°ë³¸ ìƒì„± (í…ìŠ¤íŠ¸ ê²€ìƒ‰)

**ê°€ì¥ ë§ì´ ì‚¬ìš©í•˜ëŠ” íŒ¨í„´: Cosine Distance**
```sql
-- Step 1: êµ¬ì¡° ì´í•´
CREATE INDEX idx_paper_chunks_embedding    -- ì¸ë±ìŠ¤ ì´ë¦„ (ììœ ë¡­ê²Œ ì§€ì •)
ON paper_chunks                            -- í…Œì´ë¸” ì´ë¦„
USING hnsw (                               -- HNSW ì•Œê³ ë¦¬ì¦˜ ì‚¬ìš©
    embedding                              -- ë²¡í„° ì»¬ëŸ¼ ì´ë¦„
    vector_cosine_ops                      -- Cosine Distance ì „ìš© (pgvector ì œê³µ)
);

-- Step 2: ì‹¤ì œ ì‚¬ìš© (ë…¼ë¬¸ ì²­í¬ í…Œì´ë¸”)
CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops);

-- Step 3: ê²€ìƒ‰ (ë°˜ë“œì‹œ <=> ì‚¬ìš©)
SELECT 
    chunk_text,
    embedding <=> '[0.1, 0.2, ...]'::vector(768) AS distance
FROM paper_chunks
WHERE paper_id = 'kim_phd_2024'
ORDER BY distance
LIMIT 10;

-- EXPLAINìœ¼ë¡œ ì¸ë±ìŠ¤ ì‚¬ìš© í™•ì¸
EXPLAIN ANALYZE
SELECT chunk_text, embedding <=> '[...]'::vector(768) AS distance
FROM paper_chunks
ORDER BY distance
LIMIT 10;
-- ê²°ê³¼ì— "Index Scan using idx_paper_chunks_embedding" í‘œì‹œë˜ë©´ ì„±ê³µ
```

---

### ë‹¤ë¥¸ ê±°ë¦¬ í•¨ìˆ˜ìš© ì¸ë±ìŠ¤

#### L2 Distance (ì´ë¯¸ì§€ ê²€ìƒ‰)
```sql
-- ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_images_embedding 
ON images 
USING hnsw (embedding vector_l2_ops);  -- L2 ì „ìš©
                              â†‘
                    pgvectorê°€ ì œê³µí•˜ëŠ” ì˜ˆì•½ ì´ë¦„

-- ê²€ìƒ‰ (ë°˜ë“œì‹œ <-> ì‚¬ìš©)
SELECT filename, embedding <-> '[...]'::vector(512) AS distance
FROM images
ORDER BY distance
LIMIT 10;
```

#### Inner Product (ì¶”ì²œ ì‹œìŠ¤í…œ)
```sql
-- ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_recommendations_embedding 
ON recommendations 
USING hnsw (embedding vector_ip_ops);  -- Inner Product ì „ìš©
                              â†‘
                    pgvectorê°€ ì œê³µí•˜ëŠ” ì˜ˆì•½ ì´ë¦„

-- ê²€ìƒ‰ (ë°˜ë“œì‹œ <#> ì‚¬ìš©, DESC ì£¼ì˜!)
SELECT item_name, embedding <#> '[...]'::vector(768) AS score
FROM recommendations
ORDER BY score DESC  -- DESC í•„ìˆ˜ (ìŒìˆ˜ ë°˜í™˜)
LIMIT 10;
```

---

### ì „ì²´ Operator Class ëª©ë¡

pgvectorê°€ ì œê³µí•˜ëŠ” ëª¨ë“  operator class:
```sql
-- vector íƒ€ì… (float32, 4 bytes per dimension)
vector_l2_ops       -- <-> (L2 Distance, Euclidean)
vector_cosine_ops   -- <=> (Cosine Distance) â­ ê°€ì¥ ë§ì´ ì‚¬ìš©
vector_ip_ops       -- <#> (Inner Product, ìŒìˆ˜ ë°˜í™˜)
vector_l1_ops       -- <+> (L1 Distance, Manhattan)

-- halfvec íƒ€ì… (float16, 2 bytes per dimension)
halfvec_l2_ops      -- <-> (L2 Distance)
halfvec_cosine_ops  -- <=> (Cosine Distance)
halfvec_ip_ops      -- <#> (Inner Product)

-- bit íƒ€ì… (binary vectors)
bit_hamming_ops     -- <~> (Hamming Distance)
bit_jaccard_ops     -- <%> (Jaccard Distance)
```

**í™•ì¸:**
```sql
-- ì„¤ì¹˜ëœ operator class ëª©ë¡ ì¡°íšŒ
\dAo+ vector_cosine_ops

-- ë˜ëŠ” SQLë¡œ
SELECT 
    opcname AS operator_class,
    amname AS index_method
FROM pg_opclass opc
JOIN pg_am am ON opc.opcmethod = am.oid
WHERE opcname LIKE 'vector%'
ORDER BY opcname;
```

---

### íŒŒë¼ë¯¸í„° íŠœë‹

#### WITH ì ˆ íŒŒë¼ë¯¸í„°
```sql
CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (
    m = 16,                -- ì—°ê²° ìˆ˜ (ê¸°ë³¸ê°’)
    ef_construction = 64   -- êµ¬ì¶• ì‹œ íƒìƒ‰ ìˆ˜ (ê¸°ë³¸ê°’)
);
```

#### m (ì—°ê²° ìˆ˜)

**ì˜ë¯¸:** ê° ë…¸ë“œê°€ ì—°ê²°ë˜ëŠ” ìµœëŒ€ ì´ì›ƒ ìˆ˜
```
m ê°’ì´ í´ìˆ˜ë¡:
- ì¸ë±ìŠ¤ í¬ê¸° ì¦ê°€
- ë¹Œë“œ ì‹œê°„ ì¦ê°€
- ê²€ìƒ‰ ì •í™•ë„ ì¦ê°€
- ê²€ìƒ‰ ì†ë„ ì•½ê°„ ê°ì†Œ
```

**ê¶Œì¥ ì„¤ì •:**

| ë°ì´í„° ê·œëª¨ | m ê°’ | ë¹Œë“œ ì‹œê°„ (10ë§Œ ê±´ ê¸°ì¤€) |
|-----------|------|----------------------|
| < 10,000ê±´ | 8 ~ 16 | ~3ë¶„ |
| 10,000 ~ 100,000ê±´ | 16 | ~15ë¶„ |
| > 100,000ê±´ | 16 ~ 24 | ~30ë¶„ |
| ê³ ì •í™•ë„ í•„ìš” | 32 | ~1ì‹œê°„ |

**ì˜ˆì‹œ:**
```sql
-- ì‘ì€ ë°ì´í„° (ë¹ ë¥¸ ë¹Œë“œ)
CREATE INDEX idx_small 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 8, ef_construction = 64);

-- ì¼ë°˜ì ì¸ ê²½ìš° (ê¶Œì¥)
CREATE INDEX idx_normal 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- ê³ ì •í™•ë„
CREATE INDEX idx_high_accuracy 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 32, ef_construction = 200);
```

#### ef_construction (êµ¬ì¶• ì‹œ íƒìƒ‰ ìˆ˜)

**ì˜ë¯¸:** ì¸ë±ìŠ¤ êµ¬ì¶• ì‹œ íƒìƒ‰í•  í›„ë³´ ìˆ˜
```
ef_construction ê°’ì´ í´ìˆ˜ë¡:
- ë¹Œë“œ ì‹œê°„ ì¦ê°€
- ì¸ë±ìŠ¤ í’ˆì§ˆ ì¦ê°€ (ê²€ìƒ‰ ì •í™•ë„ í–¥ìƒ)
- ì¸ë±ìŠ¤ í¬ê¸°ëŠ” ë³€í™” ì—†ìŒ
```

**ê¶Œì¥ ì„¤ì •:**

| ëª©ì  | ef_construction | ë¹Œë“œ ì‹œê°„ ë°°ìˆ˜ |
|------|-----------------|--------------|
| ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ | 32 | 1x |
| ì¼ë°˜ (ê¸°ë³¸ê°’) | 64 | 2x |
| í”„ë¡œë•ì…˜ | 128 | 4x |
| ìµœê³  í’ˆì§ˆ | 200 | 6x |

**ì˜ˆì‹œ:**
```sql
-- ê°œë°œ/í…ŒìŠ¤íŠ¸ (ë¹ ë¥¸ ë¹Œë“œ)
CREATE INDEX idx_dev 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 32);

-- í”„ë¡œë•ì…˜ (ê· í˜•)
CREATE INDEX idx_prod 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- ê³ í’ˆì§ˆ (ëŠë¦° ë¹Œë“œ, ë†’ì€ ì •í™•ë„)
CREATE INDEX idx_quality 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 24, ef_construction = 200);
```

---

### ê²€ìƒ‰ ì‹œ ì •í™•ë„ ì¡°ì •

ì¸ë±ìŠ¤ ìƒì„± í›„ì—ë„ ê²€ìƒ‰ ì •í™•ë„ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### ef_search íŒŒë¼ë¯¸í„°
```sql
-- ì„¸ì…˜ë³„ ì„¤ì • (ê²€ìƒ‰ ì‹œ íƒìƒ‰ ìˆ˜)
SET hnsw.ef_search = 40;   -- ê¸°ë³¸ê°’ (ê¶Œì¥)
SET hnsw.ef_search = 100;  -- ë†’ì€ ì •í™•ë„
SET hnsw.ef_search = 200;  -- ë§¤ìš° ë†’ì€ ì •í™•ë„

-- ê²€ìƒ‰ ì‹¤í–‰
SELECT 
    chunk_text,
    embedding <=> '[...]'::vector(768) AS distance
FROM paper_chunks
ORDER BY distance
LIMIT 10;

-- ì„¤ì • ì´ˆê¸°í™”
RESET hnsw.ef_search;
```

**ef_search ì˜í–¥:**

| ef_search | ê²€ìƒ‰ ì‹œê°„ | ì •í™•ë„ | ì‚¬ìš© ì‹œê¸° |
|-----------|----------|--------|----------|
| 20 | 5ms | 95% | ë¹ ë¥¸ ê²€ìƒ‰ ìš°ì„  |
| **40** | **10ms** | **99%** | **ì¼ë°˜ (ê¸°ë³¸ê°’, ê¶Œì¥)** â­ |
| 100 | 25ms | 99.5% | ë†’ì€ ì •í™•ë„ í•„ìš” |
| 200 | 50ms | 99.9% | Exact Searchì— ê°€ê¹Œì›€ |

**ì‹¤ì „ ì˜ˆì‹œ:**
```python
# Pythonì—ì„œ ì •í™•ë„ ì¡°ì •
import psycopg2

conn = psycopg2.connect(...)
cur = conn.cursor()

# ë¹ ë¥¸ ê²€ìƒ‰ (ë‚®ì€ ì •í™•ë„)
cur.execute("SET hnsw.ef_search = 20")
cur.execute("""
    SELECT chunk_text, embedding <=> %s AS distance
    FROM paper_chunks
    ORDER BY distance
    LIMIT 10
""", (query_embedding,))
fast_results = cur.fetchall()

# ì •í™•í•œ ê²€ìƒ‰ (ë†’ì€ ì •í™•ë„)
cur.execute("SET hnsw.ef_search = 200")
cur.execute("""
    SELECT chunk_text, embedding <=> %s AS distance
    FROM paper_chunks
    ORDER BY distance
    LIMIT 10
""", (query_embedding,))
accurate_results = cur.fetchall()

# ì´ˆê¸°í™”
cur.execute("RESET hnsw.ef_search")
```

---

### ì¸ë±ìŠ¤ ë¹Œë“œ ì‹œê°„

**ì˜ˆìƒ ë¹Œë“œ ì‹œê°„ (768ì°¨ì› ê¸°ì¤€):**

| ë°ì´í„° ê·œëª¨ | m | ef_construction | ì˜ˆìƒ ì‹œê°„ |
|-----------|---|-----------------|----------|
| 1,000ê±´ | 16 | 64 | ~3ì´ˆ |
| 10,000ê±´ | 16 | 64 | ~30ì´ˆ |
| 50,000ê±´ | 16 | 64 | ~3ë¶„ |
| 100,000ê±´ | 16 | 64 | ~10ë¶„ |
| 100,000ê±´ | 24 | 128 | ~25ë¶„ |
| 500,000ê±´ | 24 | 128 | ~2ì‹œê°„ |

**ì¤‘ìš”:** ëŒ€ëŸ‰ ë°ì´í„°ëŠ” **INSERT ì™„ë£Œ í›„** ì¸ë±ìŠ¤ ìƒì„±!
```sql
-- âŒ ë‚˜ìœ ë°©ë²•: ì¸ë±ìŠ¤ ë¨¼ì €
CREATE INDEX idx_embedding ON paper_chunks 
USING hnsw (embedding vector_cosine_ops);

INSERT INTO paper_chunks ...;  -- ë§¤ìš° ëŠë¦¼!

-- âœ… ì¢‹ì€ ë°©ë²•: ë°ì´í„° ë¨¼ì €
INSERT INTO paper_chunks ...;  -- ë¹ ë¦„

CREATE INDEX idx_embedding ON paper_chunks 
USING hnsw (embedding vector_cosine_ops);  -- í•œ ë²ˆì— ë¹Œë“œ
```

---

### ìš”ì•½

#### Operator Class í•µì‹¬
```
1. operator classëŠ” pgvectorê°€ ì œê³µí•˜ëŠ” ì˜ˆì•½ ì´ë¦„
2. ì¸ë±ìŠ¤ê°€ ì–´ë–¤ ì—°ì‚°ìë¥¼ ìµœì í™”í• ì§€ ì§€ì •
3. ê²€ìƒ‰ ì‹œ ì—°ì‚°ìì™€ ë°˜ë“œì‹œ ì¼ì¹˜í•´ì•¼ ì¸ë±ìŠ¤ ì‚¬ìš©
4. ê°€ì¥ ë§ì´ ì‚¬ìš©: vector_cosine_ops (í…ìŠ¤íŠ¸ ê²€ìƒ‰)
```

#### í…ìŠ¤íŠ¸ ê²€ìƒ‰ ê¸°ë³¸ í…œí”Œë¦¿
```sql
-- 1. ë°ì´í„° ì‚½ì…
INSERT INTO paper_chunks (paper_id, chunk_index, chunk_text, embedding)
VALUES ('paper_001', 0, 'ì²­í¬ ë‚´ìš©', '[0.1, 0.2, ...]'::vector(768));

-- 2. ì¸ë±ìŠ¤ ìƒì„± (ë°ì´í„° ì‚½ì… ì™„ë£Œ í›„!)
CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)  -- Cosine Distance ì „ìš©
WITH (m = 16, ef_construction = 64);       -- ê¸°ë³¸ íŒŒë¼ë¯¸í„°

-- 3. ê²€ìƒ‰ (ë°˜ë“œì‹œ <=> ì‚¬ìš©)
SELECT 
    chunk_text,
    embedding <=> '[...]'::vector(768) AS distance
FROM paper_chunks
WHERE paper_id = 'paper_001'
ORDER BY distance
LIMIT 10;
```

#### ì²´í¬ë¦¬ìŠ¤íŠ¸
```
âœ… operator classê°€ ê²€ìƒ‰ ì—°ì‚°ìì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
   (<=> ì‚¬ìš© â†’ vector_cosine_ops í•„ìˆ˜)
âœ… ë°ì´í„° INSERT í›„ ì¸ë±ìŠ¤ ìƒì„±
âœ… EXPLAIN ANALYZEë¡œ ì¸ë±ìŠ¤ ì‚¬ìš© í™•ì¸
âœ… í•„ìš”ì‹œ ef_searchë¡œ ì •í™•ë„ ì¡°ì •
```

---

---

## 2) IVFFlat ì¸ë±ìŠ¤ (ëŒ€ìš©ëŸ‰)

### ê°œìš”

**IVFFlat (Inverted File with Flat compression)**ì€ ëŒ€ìš©ëŸ‰ ë°ì´í„°ì— ì í•©í•œ ì¸ë±ìŠ¤ ë°©ì‹ì…ë‹ˆë‹¤.

**íŠ¹ì§•:**
- HNSWë³´ë‹¤ ëŠë¦¼ (50ms ~ 200ms)
- ë©”ëª¨ë¦¬ íš¨ìœ¨ì 
- **10ë§Œ ê±´ ì´ìƒ ë°ì´í„°ì— ì í•©**
- í•™ìŠµ ê¸°ë°˜ (í´ëŸ¬ìŠ¤í„°ë§)

---

### ê¸°ë³¸ ìƒì„±

```sql
-- IVFFlat ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_paper_chunks_ivfflat 
ON paper_chunks 
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);
```

---

### íŒŒë¼ë¯¸í„° íŠœë‹

#### lists (í´ëŸ¬ìŠ¤í„° ìˆ˜)

**ì˜ë¯¸:** ë°ì´í„°ë¥¼ ëª‡ ê°œ ê·¸ë£¹ìœ¼ë¡œ ë‚˜ëˆŒ ê²ƒì¸ê°€

**ê¶Œì¥ ê³µì‹:**
```
lists = âˆš(í–‰ ìˆ˜)

ì˜ˆì‹œ:
10,000 í–‰ â†’ lists = 100
100,000 í–‰ â†’ lists = 316
1,000,000 í–‰ â†’ lists = 1,000
```

**ì‹¤ì œ ì„¤ì •:**

| ë°ì´í„° ê·œëª¨ | lists ê¶Œì¥ê°’ | ì´ìœ  |
|-----------|------------|------|
| 10,000ê±´ | 50 ~ 100 | ì‘ì€ í´ëŸ¬ìŠ¤í„° |
| 100,000ê±´ | 200 ~ 400 | ê· í˜• |
| 1,000,000ê±´ | 800 ~ 1,200 | í° í´ëŸ¬ìŠ¤í„° |

```sql
-- ì†Œê·œëª¨ (10ë§Œ ê±´)
CREATE INDEX idx_small_ivfflat 
ON paper_chunks 
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- ì¤‘ê·œëª¨ (100ë§Œ ê±´)
CREATE INDEX idx_medium_ivfflat 
ON paper_chunks 
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 1000);

-- ëŒ€ê·œëª¨ (1,000ë§Œ ê±´)
CREATE INDEX idx_large_ivfflat 
ON paper_chunks 
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 3000);
```

---

### ê²€ìƒ‰ ì‹œ ì •í™•ë„ ì¡°ì •

```sql
-- probes: íƒìƒ‰í•  í´ëŸ¬ìŠ¤í„° ìˆ˜
SET ivfflat.probes = 1;   -- ê¸°ë³¸ê°’ (ë¹ ë¦„)
SET ivfflat.probes = 10;  -- ê· í˜• (ê¶Œì¥) âœ…
SET ivfflat.probes = 20;  -- ë†’ì€ ì •í™•ë„

-- ì¿¼ë¦¬ ì‹¤í–‰
SELECT chunk_text, embedding <=> '[...]'::vector(768) AS distance
FROM paper_chunks
ORDER BY distance
LIMIT 10;

-- ì´ˆê¸°í™”
RESET ivfflat.probes;
```

**ê¶Œì¥:** `probes = lists / 10`

---

### HNSW vs IVFFlat ë¹„êµ

| í•­ëª© | HNSW | IVFFlat |
|------|------|---------|
| **ê²€ìƒ‰ ì†ë„** | ë§¤ìš° ë¹ ë¦„ (10ms) | ë³´í†µ (50ms) |
| **ì •í™•ë„** | ë†’ìŒ (99%+) | ë³´í†µ (95%+) |
| **ë©”ëª¨ë¦¬** | ë§ìŒ | ì ìŒ |
| **ì í•© ê·œëª¨** | < 100,000ê±´ | > 100,000ê±´ |
| **ë¹Œë“œ ì‹œê°„** | ë¹ ë¦„ | ëŠë¦¼ (í•™ìŠµ í•„ìš”) |
| **ê¶Œì¥ ìš©ë„** | ì¼ë°˜ RAG â­ | ëŒ€ê·œëª¨ ì‹œìŠ¤í…œ |

---

## 3) Partial Index (ë¶€ë¶„ ì¸ë±ìŠ¤)

### ê°œìš”

íŠ¹ì • ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” í–‰ë§Œ ì¸ë±ì‹±í•˜ì—¬ ì¸ë±ìŠ¤ í¬ê¸°ì™€ ë¹Œë“œ ì‹œê°„ì„ ì¤„ì…ë‹ˆë‹¤.

### ì‚¬ìš© ì‹œê¸°

```
âœ… íŠ¹ì • ë…¼ë¬¸ë§Œ ìì£¼ ê²€ìƒ‰
âœ… ìµœì‹  ë°ì´í„°ë§Œ ê²€ìƒ‰
âœ… íŠ¹ì • ì¹´í…Œê³ ë¦¬ë§Œ ê²€ìƒ‰
âœ… ì¸ë±ìŠ¤ í¬ê¸° ê°ì†Œ í•„ìš”
```

---

### ì˜ˆì‹œ 1: íŠ¹ì • ë…¼ë¬¸ë§Œ ì¸ë±ì‹±

```sql
-- ë…¼ë¬¸ Aë§Œ ì¸ë±ì‹±
CREATE INDEX idx_paper_a_only 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WHERE paper_id = 'kim_phd_2024';

-- ê²€ìƒ‰ (ìë™ìœ¼ë¡œ ì¸ë±ìŠ¤ ì‚¬ìš©)
SELECT chunk_text, embedding <=> '[...]'::vector(768) AS distance
FROM paper_chunks
WHERE paper_id = 'kim_phd_2024'  -- ì¡°ê±´ ì¼ì¹˜ â†’ ì¸ë±ìŠ¤ ì‚¬ìš©
ORDER BY distance
LIMIT 10;
```

---

### ì˜ˆì‹œ 2: ìµœì‹  ë°ì´í„°ë§Œ ì¸ë±ì‹±

```sql
-- ìµœê·¼ 3ê°œì›” ë°ì´í„°ë§Œ ì¸ë±ì‹±
CREATE INDEX idx_recent_papers 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WHERE created_at >= NOW() - INTERVAL '3 months';

-- ê²€ìƒ‰
SELECT chunk_text, embedding <=> '[...]'::vector(768) AS distance
FROM paper_chunks
WHERE created_at >= NOW() - INTERVAL '3 months'
ORDER BY distance
LIMIT 10;
```

---

### ì˜ˆì‹œ 3: ì–¸ì–´ë³„ ì¸ë±ì‹±

```sql
-- í•œêµ­ì–´ ë…¼ë¬¸ë§Œ ì¸ë±ì‹±
CREATE INDEX idx_korean_papers 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WHERE metadata->>'language' = 'ko';

-- ì˜ì–´ ë…¼ë¬¸ë§Œ ì¸ë±ì‹±
CREATE INDEX idx_english_papers 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WHERE metadata->>'language' = 'en';

-- ê²€ìƒ‰
SELECT chunk_text, embedding <=> '[...]'::vector(768) AS distance
FROM paper_chunks
WHERE metadata->>'language' = 'ko'
ORDER BY distance
LIMIT 10;
```

---

### íš¨ê³¼

| í•­ëª© | ì „ì²´ ì¸ë±ìŠ¤ | Partial Index |
|------|-----------|---------------|
| ì¸ë±ìŠ¤ í¬ê¸° | 100% | 10% ~ 50% |
| ë¹Œë“œ ì‹œê°„ | 10ë¶„ | 1ë¶„ ~ 5ë¶„ |
| ê²€ìƒ‰ ì†ë„ | 10ms | 8ms (ì•½ê°„ ë¹ ë¦„) |
| ë©”ëª¨ë¦¬ ì‚¬ìš© | 2GB | 200MB ~ 1GB |

---

## 4) Partitioning (íŒŒí‹°ì…”ë‹)

### ê°œìš”

í…Œì´ë¸”ì„ ì—¬ëŸ¬ ë¬¼ë¦¬ì  íŒŒí‹°ì…˜ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ê´€ë¦¬í•©ë‹ˆë‹¤.

**ëª©ì :**
- ëŒ€ìš©ëŸ‰ í…Œì´ë¸” ì„±ëŠ¥ í–¥ìƒ
- ì˜¤ë˜ëœ ë°ì´í„° ì‚­ì œ ìš©ì´
- ë°±ì—…/ë³µêµ¬ íš¨ìœ¨í™”

---

### Range Partitioning (ë‚ ì§œ ê¸°ë°˜)

```sql
-- íŒŒí‹°ì…˜ ë¶€ëª¨ í…Œì´ë¸”
CREATE TABLE paper_chunks (
    id BIGSERIAL,
    paper_id TEXT NOT NULL,
    chunk_index INT NOT NULL,
    chunk_text TEXT NOT NULL,
    embedding vector(768) NOT NULL,
    created_at DATE NOT NULL,
    PRIMARY KEY (id, created_at)
) PARTITION BY RANGE (created_at);

-- ì›”ë³„ íŒŒí‹°ì…˜ ìƒì„±
CREATE TABLE paper_chunks_2024_01 PARTITION OF paper_chunks
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE paper_chunks_2024_02 PARTITION OF paper_chunks
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

CREATE TABLE paper_chunks_2024_03 PARTITION OF paper_chunks
    FOR VALUES FROM ('2024-03-01') TO ('2024-04-01');

-- ê° íŒŒí‹°ì…˜ì— ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_chunks_2024_01_embedding 
ON paper_chunks_2024_01 
USING hnsw (embedding vector_cosine_ops);

CREATE INDEX idx_chunks_2024_02_embedding 
ON paper_chunks_2024_02 
USING hnsw (embedding vector_cosine_ops);

CREATE INDEX idx_chunks_2024_03_embedding 
ON paper_chunks_2024_03 
USING hnsw (embedding vector_cosine_ops);
```

---

### List Partitioning (ë…¼ë¬¸ë³„)

```sql
-- ë…¼ë¬¸ë³„ íŒŒí‹°ì…˜
CREATE TABLE paper_chunks (
    id BIGSERIAL,
    paper_id TEXT NOT NULL,
    chunk_index INT NOT NULL,
    chunk_text TEXT NOT NULL,
    embedding vector(768) NOT NULL,
    PRIMARY KEY (id, paper_id)
) PARTITION BY LIST (paper_id);

-- ë…¼ë¬¸ë³„ íŒŒí‹°ì…˜ ìƒì„±
CREATE TABLE paper_chunks_kim PARTITION OF paper_chunks
    FOR VALUES IN ('kim_phd_2024');

CREATE TABLE paper_chunks_lee PARTITION OF paper_chunks
    FOR VALUES IN ('lee_phd_2024');

-- ê° íŒŒí‹°ì…˜ì— ì¸ë±ìŠ¤
CREATE INDEX idx_kim_embedding 
ON paper_chunks_kim 
USING hnsw (embedding vector_cosine_ops);

CREATE INDEX idx_lee_embedding 
ON paper_chunks_lee 
USING hnsw (embedding vector_cosine_ops);
```

---

### ì¥ì 

```
âœ… íŠ¹ì • íŒŒí‹°ì…˜ë§Œ ê²€ìƒ‰ (ë¹ ë¦„)
âœ… ì˜¤ë˜ëœ íŒŒí‹°ì…˜ ì‚­ì œ ìš©ì´
âœ… íŒŒí‹°ì…˜ë³„ ë…ë¦½ì  ì¸ë±ìŠ¤ ê´€ë¦¬
âœ… ë°±ì—…/ë³µêµ¬ ë‹¨ìœ„ ì¶•ì†Œ
```

### ë‹¨ì 

```
âŒ ê´€ë¦¬ ë³µì¡ë„ ì¦ê°€
âŒ íŒŒí‹°ì…˜ ê°„ ì¿¼ë¦¬ ëŠë¦¼
âŒ íŒŒí‹°ì…˜ í‚¤ ë³€ê²½ ë¶ˆê°€
```

### ê¶Œì¥

```
ë°ì´í„° 100ë§Œ ê±´ ì´ìƒ + ì‹œê³„ì—´/ë…¼ë¬¸ë³„ ë¶„ë¦¬ í•„ìš” ì‹œ
â†’ Partitioning ê³ ë ¤
```

---

## 5) ì¸ë±ìŠ¤ ë¹Œë“œ ì„±ëŠ¥ ìµœì í™”

### ëŒ€ëŸ‰ INSERT ì‹œ ì „ëµ

```sql
-- âŒ ë‚˜ìœ ë°©ë²•: ì¸ë±ìŠ¤ ë¨¼ì € ìƒì„±
CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops);

INSERT INTO paper_chunks ...;  -- ë§¤ìš° ëŠë¦¼!

-- âœ… ì¢‹ì€ ë°©ë²•: ë°ì´í„° ë¨¼ì € ì‚½ì…
INSERT INTO paper_chunks ...;  -- ë¹ ë¦„

CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops);  -- í•œ ë²ˆì— ë¹Œë“œ
```

**ì´ìœ :**  
ì¸ë±ìŠ¤ê°€ ìˆìœ¼ë©´ INSERTë§ˆë‹¤ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸ â†’ ëŠë¦¼

---

### ë©”ëª¨ë¦¬ ì„¤ì •

```sql
-- ì¸ë±ìŠ¤ ë¹Œë“œ ì „ ë©”ëª¨ë¦¬ ì¦ê°€
SET maintenance_work_mem = '2GB';  -- ê¸°ë³¸ê°’: 64MB

CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 24, ef_construction = 128);

-- ì›ë˜ëŒ€ë¡œ ë³µêµ¬
RESET maintenance_work_mem;
```

**ê¶Œì¥:**

| ë°ì´í„° ê·œëª¨ | maintenance_work_mem |
|-----------|---------------------|
| < 10,000ê±´ | 256MB |
| 10,000 ~ 100,000ê±´ | 512MB ~ 1GB |
| > 100,000ê±´ | 1GB ~ 4GB |

---

### ë³‘ë ¬ ë¹Œë“œ (PostgreSQL 11+)

```sql
-- ë³‘ë ¬ ì›Œì»¤ ì„¤ì •
SET max_parallel_maintenance_workers = 4;  -- ê¸°ë³¸ê°’: 2

CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops);

-- ì›ë˜ëŒ€ë¡œ ë³µêµ¬
RESET max_parallel_maintenance_workers;
```

**íš¨ê³¼:**  
ë¹Œë“œ ì‹œê°„ 20% ~ 50% ë‹¨ì¶• (CPU ì½”ì–´ ìˆ˜ì— ë”°ë¼ ë‹¤ë¦„)

---

### ì¸ë±ìŠ¤ ë¹Œë“œ ëª¨ë‹ˆí„°ë§

```sql
-- ì§„í–‰ë¥  í™•ì¸ (PostgreSQL 12+)
SELECT 
    phase,
    round(100.0 * blocks_done / nullif(blocks_total, 0), 1) AS "% complete",
    blocks_done,
    blocks_total
FROM pg_stat_progress_create_index;
```

---

## 6) ì¸ë±ìŠ¤ ê´€ë¦¬

### ì¸ë±ìŠ¤ ëª©ë¡ í™•ì¸

```sql
-- í…Œì´ë¸”ì˜ ëª¨ë“  ì¸ë±ìŠ¤ ì¡°íšŒ
SELECT 
    indexname,
    indexdef
FROM pg_indexes
WHERE tablename = 'paper_chunks';
```

---

### ì¸ë±ìŠ¤ í¬ê¸° í™•ì¸

```sql
-- ì¸ë±ìŠ¤ í¬ê¸° ì¡°íšŒ
SELECT 
    indexname,
    pg_size_pretty(pg_relation_size(indexname::regclass)) AS index_size
FROM pg_indexes
WHERE tablename = 'paper_chunks';
```

**ì˜ˆìƒ í¬ê¸°:**

| ë°ì´í„° ê·œëª¨ | HNSW ì¸ë±ìŠ¤ í¬ê¸° (m=16) |
|-----------|----------------------|
| 10,000ê±´ Ã— 768ì°¨ì› | ~200MB |
| 100,000ê±´ Ã— 768ì°¨ì› | ~2GB |
| 1,000,000ê±´ Ã— 768ì°¨ì› | ~20GB |

---

### ì¸ë±ìŠ¤ ì¬êµ¬ì¶•

```sql
-- ëŒ€ëŸ‰ INSERT/UPDATE/DELETE í›„ ì„±ëŠ¥ ì €í•˜ ì‹œ
REINDEX INDEX idx_paper_chunks_embedding;

-- í…Œì´ë¸” ì „ì²´ ì¸ë±ìŠ¤ ì¬êµ¬ì¶•
REINDEX TABLE paper_chunks;
```

---

### ì¸ë±ìŠ¤ ì‚­ì œ

```sql
-- ì¸ë±ìŠ¤ ì‚­ì œ (ê²€ìƒ‰ ëŠë ¤ì§)
DROP INDEX idx_paper_chunks_embedding;

-- IF EXISTS ì‚¬ìš© (ì•ˆì „)
DROP INDEX IF EXISTS idx_paper_chunks_embedding;
```

---

### ì¸ë±ìŠ¤ ì‚¬ìš© ì—¬ë¶€ í™•ì¸

```sql
-- ì¿¼ë¦¬ ì‹¤í–‰ ê³„íš í™•ì¸
EXPLAIN ANALYZE
SELECT chunk_text, embedding <=> '[...]'::vector(768) AS distance
FROM paper_chunks
ORDER BY distance
LIMIT 10;

-- ì¸ë±ìŠ¤ ì‚¬ìš©: "Index Scan using idx_paper_chunks_embedding"
-- ì¸ë±ìŠ¤ ë¯¸ì‚¬ìš©: "Seq Scan on paper_chunks"
```

---

## 7) ì‹¤ì „ ê¶Œì¥ì‚¬í•­

### ë…¼ë¬¸ RAG ì‹œìŠ¤í…œ

```sql
-- ë…¼ë¬¸ ìˆ˜ < 10ê°œ (ì²­í¬ < 100ê°œ):
â†’ ì¸ë±ìŠ¤ ë¶ˆí•„ìš”

-- ë…¼ë¬¸ ìˆ˜ 10 ~ 100ê°œ (ì²­í¬ 100 ~ 1,000ê°œ):
â†’ ì¸ë±ìŠ¤ ë¶ˆí•„ìš” (ë˜ëŠ” ê°„ë‹¨í•œ HNSW)

-- ë…¼ë¬¸ ìˆ˜ 100 ~ 1,000ê°œ (ì²­í¬ 1,000 ~ 10,000ê°œ):
â†’ HNSW ì¸ë±ìŠ¤ ìƒì„± âœ…
CREATE INDEX ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- ë…¼ë¬¸ ìˆ˜ > 1,000ê°œ (ì²­í¬ > 10,000ê±´):
â†’ HNSW ì¸ë±ìŠ¤ (íŒŒë¼ë¯¸í„° ì¡°ì •) âœ…
CREATE INDEX ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 24, ef_construction = 128);

-- ë…¼ë¬¸ ìˆ˜ > 10,000ê°œ (ì²­í¬ > 100,000ê±´):
â†’ IVFFlat ë˜ëŠ” Partitioning ê³ ë ¤
```

---

### ì¼ë°˜ ì›ì¹™

| ë°ì´í„° ê·œëª¨ | ì¸ë±ìŠ¤ ì „ëµ |
|-----------|-----------|
| < 1,000ê±´ | ì¸ë±ìŠ¤ ë¶ˆí•„ìš” |
| 1,000 ~ 10,000ê±´ | HNSW (ê¸°ë³¸ ì„¤ì •) |
| 10,000 ~ 100,000ê±´ | HNSW (íŒŒë¼ë¯¸í„° ì¡°ì •) |
| 100,000 ~ 1,000,000ê±´ | HNSW ë˜ëŠ” IVFFlat |
| > 1,000,000ê±´ | IVFFlat + Partitioning |

---

### ì²´í¬ë¦¬ìŠ¤íŠ¸

```
âœ… ë°ì´í„° INSERT ì™„ë£Œ í›„ ì¸ë±ìŠ¤ ìƒì„±
âœ… ê²€ìƒ‰ ì‹œ ì‚¬ìš©í•  ê±°ë¦¬ í•¨ìˆ˜ì— ë§ëŠ” ops ì„ íƒ
âœ… maintenance_work_mem ì¶©ë¶„íˆ í• ë‹¹
âœ… EXPLAIN ANALYZEë¡œ ì¸ë±ìŠ¤ ì‚¬ìš© í™•ì¸
âœ… ì •ê¸°ì ìœ¼ë¡œ ì¸ë±ìŠ¤ í¬ê¸° ëª¨ë‹ˆí„°ë§
âœ… ì„±ëŠ¥ ì €í•˜ ì‹œ REINDEX ì‹¤í–‰
```

---

## 8) ìš”ì•½

| ìƒí™© | ì¸ë±ìŠ¤ ì „ëµ | ì„¤ì • |
|------|-----------|------|
| **ì†Œê·œëª¨ RAG** | ì¸ë±ìŠ¤ ë¶ˆí•„ìš” | - |
| **ì¼ë°˜ RAG** | HNSW | m=16, ef_construction=64 |
| **ê³ ì •í™•ë„ RAG** | HNSW | m=24, ef_construction=128 |
| **ëŒ€ìš©ëŸ‰ ì‹œìŠ¤í…œ** | IVFFlat | lists=âˆš(í–‰ ìˆ˜) |
| **íŠ¹ì • ì¡°ê±´ë§Œ** | Partial Index | WHERE ì ˆ ì¶”ê°€ |
| **ì‹œê³„ì—´ ë°ì´í„°** | Partitioning | RANGE íŒŒí‹°ì…˜ |

**í…ìŠ¤íŠ¸ ê²€ìƒ‰ ê¸°ë³¸ í…œí”Œë¦¿:**

```sql
-- ë°ì´í„° INSERT
INSERT INTO paper_chunks ...;

-- HNSW ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- ê²€ìƒ‰
SELECT chunk_text, embedding <=> %s AS distance
FROM paper_chunks
WHERE paper_id = %s
ORDER BY distance
LIMIT 10;
```

---