# ğŸ“˜ 06. ë²¡í„° ì¿¼ë¦¬ (Querying Vectors)

pgvectorì—ì„œ ë²¡í„° ë°ì´í„°ë¥¼ ê²€ìƒ‰í•˜ëŠ” ë‹¤ì–‘í•œ ë°©ë²•ì„ ë‹¤ë£¹ë‹ˆë‹¤.  
ê±°ë¦¬ ê¸°ë°˜ ê²€ìƒ‰, í•„í„°ë§, ì„±ëŠ¥ ìµœì í™” ë“± ì‹¤ì „ì—ì„œ í•„ìš”í•œ ì¿¼ë¦¬ íŒ¨í„´ì„ í•™ìŠµí•©ë‹ˆë‹¤.

> ğŸ¯ **ì´ ë¬¸ì„œì˜ ëª©í‘œ:**  
> ë…¼ë¬¸ PDFì—ì„œ ì§ˆë¬¸ì— ê°€ì¥ ê´€ë ¨ëœ ì²­í¬ë¥¼ ì •í™•í•˜ê³  ë¹ ë¥´ê²Œ ì°¾ëŠ” ë°©ë²• í•™ìŠµ

---

## 1) ê±°ë¦¬ ê¸°ë°˜ ê²€ìƒ‰

ë²¡í„° ê°„ ê±°ë¦¬ë¥¼ ê³„ì‚°í•˜ì—¬ ìœ ì‚¬í•œ ë°ì´í„°ë¥¼ ì°¾ëŠ” ê°€ì¥ ê¸°ë³¸ì ì¸ ê²€ìƒ‰ ë°©ë²•ì…ë‹ˆë‹¤.

### ê¸°ë³¸ êµ¬ì¡°
```sql
SELECT 
    ì»¬ëŸ¼ë“¤,
    embedding <ê±°ë¦¬ì—°ì‚°ì> 'ì¿¼ë¦¬ë²¡í„°' AS distance
FROM í…Œì´ë¸”
ORDER BY distance
LIMIT N;
```

> ğŸ’¡ **ì°¸ê³ :** `embedding`ì€ ë²¡í„° íƒ€ì… ì»¬ëŸ¼ ì´ë¦„ì…ë‹ˆë‹¤. (ì˜ˆ: user_vector, image_embedding ë“±)

---

### ê±°ë¦¬ ì—°ì‚°ì ì „ì²´ ëª©ë¡

pgvectorëŠ” 6ê°€ì§€ ê±°ë¦¬ í•¨ìˆ˜ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

| ì—°ì‚°ì | ê±°ë¦¬ í•¨ìˆ˜ | ëŒ€ìƒ íƒ€ì… | ì£¼ìš” ìš©ë„ |
|--------|----------|----------|----------|
| `<->` | L2 Distance (Euclidean) | vector, halfvec | ì´ë¯¸ì§€ ê²€ìƒ‰, ê°ì²´ ì¸ì‹ |
| `<=>` | Cosine Distance | vector, halfvec | **í…ìŠ¤íŠ¸ ê²€ìƒ‰, RAG** â­ |
| `<#>` | Inner Product (ìŒìˆ˜) | vector, halfvec | ì¶”ì²œ ì‹œìŠ¤í…œ |
| `<+>` | L1 Distance (Manhattan) | vector, halfvec | ê³ ì°¨ì› í¬ì†Œ ë²¡í„° |
| `<~>` | Hamming Distance | bit | ì´ì§„ ë²¡í„° ê²€ìƒ‰ |
| `<%>` | Jaccard Distance | bit | ì§‘í•© ìœ ì‚¬ë„ |

**ì´ ë¬¸ì„œì—ì„œëŠ”:**
- í…ìŠ¤íŠ¸ ê²€ìƒ‰ì— ê°€ì¥ ë§ì´ ì‚¬ìš©ë˜ëŠ” **â‘  ~ â‘¢ë²ˆ**ì„ ìƒì„¸íˆ ë‹¤ë£¹ë‹ˆë‹¤.
- â‘£ ~ â‘¥ë²ˆì€ ê°„ë‹¨íˆ ì†Œê°œí•©ë‹ˆë‹¤.

---

### â‘  L2 Distance (Euclidean Distance) - `<->`

**ê°œë…:**  
ë‘ ì  ì‚¬ì´ì˜ ì§ì„  ê±°ë¦¬ë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤. 3ì°¨ì› ê³µê°„ì—ì„œ ë‘ ì  ì‚¬ì´ì˜ ì‹¤ì œ ê±°ë¦¬ì™€ ê°™ì€ ê°œë…ì…ë‹ˆë‹¤.

**ìˆ˜ì‹:**
```
ê±°ë¦¬ = âˆš((xâ‚-xâ‚‚)Â² + (yâ‚-yâ‚‚)Â² + (zâ‚-zâ‚‚)Â²)

ì˜ˆì‹œ (3ì°¨ì›):
A = [1, 2, 3]
B = [4, 5, 6]
L2 = âˆš((1-4)Â² + (2-5)Â² + (3-6)Â²) = âˆš(9+9+9) = âˆš27 â‰ˆ 5.196
```

**íŠ¹ì§•:**
- **ì ˆëŒ€ì  ê±°ë¦¬** ì¸¡ì • (ë²¡í„°ì˜ í¬ê¸° ê³ ë ¤)
- ê°’ì´ **ì‘ì„ìˆ˜ë¡** ìœ ì‚¬í•¨ (0 = ì™„ì „íˆ ë™ì¼)
- ì´ë¯¸ì§€ ê²€ìƒ‰, ê°ì²´ ì¸ì‹ì— ì í•©

**ì˜ˆì‹œ:**
```sql
-- L2 Distance ê²€ìƒ‰
SELECT 
    chunk_text,
    embedding <-> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS l2_distance
FROM paper_chunks
WHERE paper_id = 'kim_phd_2024'
ORDER BY l2_distance
LIMIT 5;
```

**ì–¸ì œ ì‚¬ìš©?**
```
âœ… ì´ë¯¸ì§€ ê²€ìƒ‰ (í”½ì…€ ê°„ ê±°ë¦¬)
âœ… ê°ì²´ ìœ„ì¹˜ ì¶”ì 
âœ… íŒ¨í„´ ë§¤ì¹­
âŒ í…ìŠ¤íŠ¸ ê²€ìƒ‰ (í¬ê¸° ì°¨ì´ì— ë¯¼ê°)
```

**ì‹œê°ì  ì„¤ëª…:**
```
ë²¡í„° A: [3, 4]
ë²¡í„° B: [6, 8]

     |
  10 |
   9 |
   8 |        B (6,8)
   7 |       /
   6 |      /
   5 |     /
   4 |    A (3,4)
   3 |   /
   2 |  /
   1 | /
   0 |____________
     0 1 2 3 4 5 6 7

L2 ê±°ë¦¬ = ì§ì„  ê±°ë¦¬ = 5.0
```

---

### â‘¡ Cosine Distance - `<=>` âœ… í…ìŠ¤íŠ¸ ê²€ìƒ‰ ê¶Œì¥

**ê°œë…:**  
ë‘ ë²¡í„° ê°„ì˜ **ê°ë„ ì°¨ì´**ë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤. ë²¡í„°ì˜ í¬ê¸°(ê¸¸ì´)ëŠ” ë¬´ì‹œí•˜ê³  **ë°©í–¥ë§Œ** ë¹„êµí•©ë‹ˆë‹¤.

**Cosine Distance ìˆ˜ì‹:**
```
Cosine Similarity = (AÂ·B) / (|A| Ã— |B|)
Cosine Distance = 1 - Cosine Similarity

â— A Â· B = ë‚´ì (Dot Product)
A Â· B = Aâ‚Bâ‚ + Aâ‚‚Bâ‚‚ + Aâ‚ƒBâ‚ƒ + ...  
â†’ ë‘ ë²¡í„°ë¥¼ ê° ì¢Œí‘œë³„ë¡œ ê³±í•œ ë’¤ ëª¨ë‘ ë”í•œ ê°’  
â†’ ë²¡í„°ê°€ ê°™ì€ ë°©í–¥ì„ í–¥í• ìˆ˜ë¡ ì»¤ì§  
â†’ ë‘ ë²¡í„°ì˜ ë°©í–¥ ìœ ì‚¬ë„ë¥¼ ì˜ë¯¸í•¨

â— |A| Ã— |B| = ë²¡í„° í¬ê¸° (Norm, ê¸¸ì´)
|A| = âˆš(Aâ‚Â² + Aâ‚‚Â² + Aâ‚ƒÂ² + ...)  
|B| = âˆš(Bâ‚Â² + Bâ‚‚Â² + Bâ‚ƒÂ² + ...)  
â†’ ê°ê° ë²¡í„°ì˜ ê¸¸ì´(í¬ê¸°)  
â†’ |A| Ã— |B| ëŠ” ë²¡í„°ì˜ í¬ê¸° ì°¨ì´ë¥¼ ì œê±°í•´  
   ìˆœìˆ˜í•˜ê²Œ ë°©í–¥ë§Œ ë¹„êµí•  ìˆ˜ ìˆê²Œ ë§Œë“œëŠ” ì •ê·œí™” ì‘ì—…

â— ì™œ Cosine Distance = 1 - Cosine Similarity ì¸ê°€?
â†’  ìœ ì‚¬ë„ì™€ ê±°ë¦¬ ê°œë…ì˜ ë°©í–¥ì´ ë°˜ëŒ€ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
- **Similarity**: ê°’ì´ **í´ìˆ˜ë¡** ìœ ì‚¬  
- **Distance**: ê°’ì´ **ì‘ì„ìˆ˜ë¡** ìœ ì‚¬  

â— pgvectorê°€ <=> (cosine distance) ë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ 
â†’ pgvector ì¸ë±ìŠ¤(HNSW, IVF)ëŠ” ëª¨ë‘ â€œê±°ë¦¬ ìµœì†Œí™”â€ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•œë‹¤.
  ê·¸ë˜ì„œ cosine similarity ëŒ€ì‹ 
  cosine distanceë¡œ ë³€í™˜í•œ í˜•íƒœë¥¼ ì‚¬ìš©í•´ì•¼ ANN ì¸ë±ìŠ¤ì— ë§ìŒ
â†’ ê±°ë¦¬(distance)ëŠ” ìŒìˆ˜ì´ë©´ ì•ˆ ëœë‹¤.
  ì›ë˜ cosine similarityëŠ” ìŒìˆ˜ê°€ ë‚˜ì˜¬ ìˆ˜ ìˆìŒ:
  ì™„ì „ ë°˜ëŒ€ ë°©í–¥ â†’ -1
  ì´ê±¸ distanceë¡œ ì“°ë©´ ë¬¸ì œê°€ ìƒê¹€.

ë”°ë¼ì„œ ê±°ë¦¬ ê°œë…ìœ¼ë¡œ ë³€í™˜í•˜ë ¤ë©´ ê°’ì„ ë°˜ëŒ€ë¡œ ë’¤ì§‘ì–´ì•¼ í•˜ë©°,  

Cosine Distance ê°’ ë²”ìœ„:
- 0: ì™„ì „íˆ ê°™ì€ ë°©í–¥ (ê°€ì¥ ìœ ì‚¬)
- 1: ì§ê° (ê´€ë ¨ ì—†ìŒ)
- 2: ë°˜ëŒ€ ë°©í–¥ (ì •ë°˜ëŒ€)
```

**ì˜ˆì‹œ ê³„ì‚°:**
```
A = [1, 2, 3]
B = [2, 4, 6]  (Aì˜ 2ë°°)

Cosine Similarity = (1Ã—2 + 2Ã—4 + 3Ã—6) / (âˆš14 Ã— âˆš56)
                  = (2 + 8 + 18) / (3.74 Ã— 7.48)
                  = 28 / 28 = 1.0

Cosine Distance = 1 - 1.0 = 0  (ì™„ì „íˆ ê°™ì€ ë°©í–¥!)

â†’ í¬ê¸°ëŠ” ë‹¤ë¥´ì§€ë§Œ(Bê°€ 2ë°°) ë°©í–¥ì´ ê°™ì•„ì„œ ê±°ë¦¬ 0
```

**íŠ¹ì§•:**
- **ë°©í–¥ë§Œ ë¹„êµ** (í¬ê¸° ë¬´ì‹œ)
- ê°’ì´ **ì‘ì„ìˆ˜ë¡** ìœ ì‚¬í•¨ (0 = ê°™ì€ ë°©í–¥)
- **í…ìŠ¤íŠ¸ ê²€ìƒ‰ì— ìµœì ** (ë¬¸ì„œ ê¸¸ì´ ë¬´ê´€)

**ì˜ˆì‹œ:**
```sql
-- Cosine Distance ê²€ìƒ‰ (í…ìŠ¤íŠ¸ ê²€ìƒ‰ ê¶Œì¥)
SELECT 
    chunk_text,
    metadata->>'page_number' AS page,
    embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS cosine_distance
FROM paper_chunks
WHERE paper_id = 'kim_phd_2024'
ORDER BY cosine_distance
LIMIT 5;
```

**ì™œ í…ìŠ¤íŠ¸ ê²€ìƒ‰ì— ì¢‹ì€ê°€?**
```
ì§ˆë¬¸: "ìˆ˜ì˜¨ì´ ì–´ë¥˜ ì„±ì¥ì— ì˜í–¥ì„ ì¤€ë‹¤" (ì§§ì€ ë¬¸ì¥)
ë¬¸ì„œ: "ë³¸ ì—°êµ¬ëŠ” ìˆ˜ì˜¨ì´ ì–´ë¥˜ ì„±ì¥ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ë‹¤ì–‘í•œ ì‹¤í—˜ì„ í†µí•´ ë¶„ì„í•˜ì˜€ë‹¤" (ê¸´ ë¬¸ì¥)

L2 Distance: ë¬¸ì„œê°€ ê¸¸ì–´ì„œ ê±°ë¦¬ê°€ ë©€ë‹¤ê³  íŒë‹¨ âŒ
Cosine Distance: ì˜ë¯¸ ë°©í–¥ì´ ê°™ì•„ì„œ ìœ ì‚¬í•˜ë‹¤ê³  íŒë‹¨ âœ…
```

**ì–¸ì œ ì‚¬ìš©?**
```
âœ… í…ìŠ¤íŠ¸ ê²€ìƒ‰ (ë¬¸ì„œ, ë…¼ë¬¸, RAG) â­ ê°€ì¥ ë§ì´ ì‚¬ìš©
âœ… ì˜ë¯¸ ìœ ì‚¬ë„ ë¹„êµ
âœ… ì¶”ì²œ ì‹œìŠ¤í…œ (ì½˜í…ì¸  ê¸°ë°˜)
âœ… ë¬¸ì„œ ë¶„ë¥˜
```

**ì‹œê°ì  ì„¤ëª…:**
```
     |
  10 |        B (2,10) - ê¸´ ë¬¸ì¥
   9 |       /
   8 |      /
   7 |     /
   6 |    /
   5 |   /  ê°ë„ = ì‘ìŒ (ìœ ì‚¬!)
   4 |  /
   3 | / A (1,5) - ì§§ì€ ë¬¸ì¥
   2 |/
   1 /
   0|____________

ê°™ì€ ë°©í–¥(ê°ë„ ì‘ìŒ) = ìœ ì‚¬í•¨
ê¸¸ì´(í¬ê¸°) ì°¨ì´ëŠ” ë¬´ì‹œ
```

---

### â‘¢ Inner Product (ë‚´ì ) - `<#>`

**ê°œë…:**  
ë‘ ë²¡í„°ë¥¼ ê³±í•œ ê°’ì˜ í•©ì…ë‹ˆë‹¤. **ë°©í–¥ê³¼ í¬ê¸°ë¥¼ ëª¨ë‘ ê³ ë ¤**í•©ë‹ˆë‹¤.

**ìˆ˜ì‹:**
```
Inner Product = AÂ·B = aâ‚Ã—bâ‚ + aâ‚‚Ã—bâ‚‚ + aâ‚ƒÃ—bâ‚ƒ

ì˜ˆì‹œ:
A = [0.8, 0.3, 0.6]  (ì‚¬ìš©ì ì„ í˜¸ë„: ì•¡ì…˜, ë¡œë§¨ìŠ¤, SF)
B = [0.9, 0.1, 0.2]  (ì˜í™”A: ì•¡ì…˜ ì˜í™”)

ë‚´ì  = 0.8Ã—0.9 + 0.3Ã—0.1 + 0.6Ã—0.2 
    = 0.72 + 0.03 + 0.12 
    = 0.87  (ë†’ì€ ê°’ = ì„ í˜¸)
```

**íŠ¹ì§•:**
- **ë°©í–¥ + í¬ê¸° ëª¨ë‘ ê³ ë ¤**
- ê°’ì´ **í´ìˆ˜ë¡** ìœ ì‚¬í•¨ (ìŒìˆ˜ ê°€ëŠ¥)
- pgvectorëŠ” **ìŒìˆ˜ë¡œ ë°˜í™˜** (`<#>` ì—°ì‚°ì)

**pgvectorì˜ Inner Product:**
```sql
-- Inner Product ê²€ìƒ‰ (ìŒìˆ˜ ë°˜í™˜)
SELECT 
    chunk_text,
    embedding <#> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS inner_product
FROM paper_chunks
WHERE paper_id = 'kim_phd_2024'
ORDER BY inner_product DESC  -- DESC ì£¼ì˜! (ìŒìˆ˜ë¼ì„œ)
LIMIT 5;
```

**ìŒìˆ˜ í™•ì¸ ê°„ë‹¨ ì˜ˆì œ:**
```sql
-- 2ì°¨ì› ë²¡í„° í…ŒìŠ¤íŠ¸ í…Œì´ë¸”
CREATE TABLE vec2_demo (
    id        integer PRIMARY KEY,
    embedding vector(2)
);

-- ì˜ˆì œ ë°ì´í„° ì‚½ì…
INSERT INTO vec2_demo (id, embedding) VALUES
    (1, '[1,0]'),    -- xì¶• ë°©í–¥
    (2, '[0,1]'),    -- yì¶• ë°©í–¥
    (3, '[1,1]'),    -- ëŒ€ê°ì„ 
    (4, '[-1,0]'),   -- xì¶• ë°˜ëŒ€ ë°©í–¥
    (5, '[2,0]');    -- í¬ê¸°ë§Œ 2ë°°ì¸ ê°™ì€ ë°©í–¥

-- Inner Product ê²°ê³¼ í™•ì¸
SELECT
    id,
    embedding,
    embedding <#> '[1,0]'::vector AS inner_product_distance
FROM vec2_demo
ORDER BY inner_product_distance DESC;

-- ì˜ˆìƒ ê²°ê³¼:
-- id=5: [2,0]  â†’ -2.0 (ê°€ì¥ í° ë‚´ì , ê°™ì€ ë°©í–¥ì´ë©´ì„œ í¬ê¸° 2ë°°)
-- id=1: [1,0]  â†’ -1.0 (ì¿¼ë¦¬ì™€ ë™ì¼)
-- id=3: [1,1]  â†’ -1.0 
-- id=2: [0,1]  â†’ 0.0  (ì§ê°)
-- id=4: [-1,0] â†’ 1.0  (ë°˜ëŒ€ ë°©í–¥, ì–‘ìˆ˜)
```

**ì™œ ìŒìˆ˜ì¸ê°€?**
```
pgvectorëŠ” "ì‘ì€ ê°’ = ê°€ê¹Œì›€" í†µì¼ì„±ì„ ìœ„í•´ -(AÂ·B)ë¡œ ë°˜í™˜
ì‹¤ì œ ë‚´ì ì´ 0.87ì´ë©´ -0.87ë¡œ ì €ì¥
â†’ ORDER BY DESC ì‚¬ìš© (ëœ ìŒìˆ˜ = ë” ìœ ì‚¬)
```

**ì‹¤ì œ ì˜ˆì‹œ (ì¶”ì²œ ì‹œìŠ¤í…œ):**
```
ì‚¬ìš©ì ì„ í˜¸ë„: [0.9, 0.2, 0.7]  (ì•¡ì…˜ ì¢‹ì•„í•¨, ë¡œë§¨ìŠ¤ ì‹«ì–´í•¨, SF ì¢‹ì•„í•¨)

ì˜í™”A [0.8, 0.1, 0.3]: ì•¡ì…˜ ì˜í™”
â†’ ë‚´ì  = 0.9Ã—0.8 + 0.2Ã—0.1 + 0.7Ã—0.3 = 0.95 (ë†’ìŒ âœ…)

ì˜í™”B [0.2, 0.9, 0.1]: ë¡œë§¨ìŠ¤ ì˜í™”
â†’ ë‚´ì  = 0.9Ã—0.2 + 0.2Ã—0.9 + 0.7Ã—0.1 = 0.43 (ë‚®ìŒ âŒ)

â†’ ì˜í™”A ì¶”ì²œ!
```

**ì–¸ì œ ì‚¬ìš©?**
```
âœ… ì¶”ì²œ ì‹œìŠ¤í…œ (ì‚¬ìš©ì-ì•„ì´í…œ ë§¤ì¹­)
âœ… í˜‘ì—… í•„í„°ë§
âœ… ì„ í˜¸ë„ ê¸°ë°˜ ë­í‚¹
âŒ ì¼ë°˜ í…ìŠ¤íŠ¸ ê²€ìƒ‰ (Cosineì´ ë” ì¢‹ìŒ)
```

**Cosine vs Inner Product ì°¨ì´:**
```
ë²¡í„° A: [0.5, 0.5]  (ì‚¬ìš©ì ì„ í˜¸)
ë²¡í„° B: [1.0, 1.0]  (ì¸ê¸° ì˜í™”, Aì˜ 2ë°°)

Cosine Distance:
- ë°©í–¥ë§Œ ë´„ â†’ ê°™ì€ ë°©í–¥ â†’ ê±°ë¦¬ 0 (ë§¤ìš° ìœ ì‚¬)

Inner Product:
- ë°©í–¥ + í¬ê¸° ë´„ â†’ Bê°€ ë” "ê°•í•¨" â†’ ë‚´ì  1.0 (Bë¥¼ ë” ì¶”ì²œ)
- ê°™ì€ ë°©í–¥ì¼ ë•Œ ê°’ì´ í¼ â†’ ë°©í–¥ë„ ê³ ë ¤í•¨

â†’ ì¸ê¸°ë„(í¬ê¸°)ë¥¼ ê³ ë ¤í•˜ê³  ì‹¶ìœ¼ë©´ Inner Product
```

---

### â‘£ L1 Distance (Manhattan Distance) - `<+>`

**ê°œë…:**  
ê° ì°¨ì›ì˜ ì°¨ì´ì˜ ì ˆëŒ“ê°’ì„ ëª¨ë‘ ë”í•œ ê±°ë¦¬ì…ë‹ˆë‹¤. ë§¨í•´íŠ¼ ê±°ë¦¬ë¼ê³ ë„ ë¶ˆë¦½ë‹ˆë‹¤.

**ìˆ˜ì‹:**
```
L1 Distance = |xâ‚-xâ‚‚| + |yâ‚-yâ‚‚| + |zâ‚-zâ‚‚|

ì˜ˆì‹œ (2ì°¨ì›):
A = [1, 2]
B = [4, 6]
L1 = |1-4| + |2-6| = 3 + 4 = 7
```

**íŠ¹ì§•:**
- ì°¨ì›ë³„ ì°¨ì´ì˜ í•©
- ê³ ì°¨ì›ì—ì„œ L2ë³´ë‹¤ ê³„ì‚° ë¹ ë¦„
- í¬ì†Œ ë²¡í„°(sparse vector)ì— ì í•©

**ì˜ˆì‹œ:**
```sql
-- L1 Distance ê²€ìƒ‰
SELECT 
    chunk_text,
    embedding <+> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS l1_distance
FROM paper_chunks
ORDER BY l1_distance
LIMIT 5;
```

**ì–¸ì œ ì‚¬ìš©?**
```
âœ… ê³ ì°¨ì› í¬ì†Œ ë²¡í„° - ì°¨ì› ìˆ˜ëŠ” ë§¤ìš° ë†’ì§€ë§Œ, ì‹¤ì œë¡œ 0ì´ ì•„ë‹Œ ê°’(non-zero)ì´ ë§¤ìš° ì ì€ ë²¡í„°ë¥¼ ì˜ë¯¸
âœ… íŠ¹ì • ë„ë©”ì¸ (ë¬¼ë¥˜, ê²½ë¡œ ìµœì í™”)
âŒ ì¼ë°˜ í…ìŠ¤íŠ¸ ê²€ìƒ‰ (L2ë‚˜ Cosine ê¶Œì¥)
```

**ì‹œê°ì  ì„¤ëª…:**
```
Aì—ì„œ Bë¡œ ì´ë™ (ë§¨í•´íŠ¼ ê±°ë¦¬)
     |
   6 |        B (4,6)
   5 |        |
   4 |        |
   3 |        |
   2 |   A----+
   1 |  (1,2)
   0 |____________
     0 1 2 3 4 5

L1 = 3 (ê°€ë¡œ) + 4 (ì„¸ë¡œ) = 7
L2 = âˆš(3Â² + 4Â²) = 5
```

---

### â‘¤ Hamming Distance - `<~>` (binary ì „ìš©)

**ê°œë…:**  
ë‘ ì´ì§„ ë²¡í„°ì—ì„œ **ë‹¤ë¥¸ ë¹„íŠ¸ì˜ ê°œìˆ˜**ë¥¼ ì„¸ëŠ” ê±°ë¦¬ì…ë‹ˆë‹¤.

**ìˆ˜ì‹:**
```
Hamming Distance = ë‹¤ë¥¸ ë¹„íŠ¸ ìˆ˜

ì˜ˆì‹œ:
A = 10110 (binary)
B = 10011 (binary)
       ^^  â†’ 2ê°œ ë‹¤ë¦„
Hamming Distance = 2
```

**íŠ¹ì§•:**
- `bit` íƒ€ì… ì „ìš©
- ë§¤ìš° ë¹ ë¥¸ ê³„ì‚°
- ì¤‘ë³µ íƒì§€, ìœ ì‚¬ ì´ë¯¸ì§€ ê²€ìƒ‰ì— ì‚¬ìš©

**ì˜ˆì‹œ:**
```sql
-- Hamming Distance ê²€ìƒ‰
SELECT 
    content,
    embedding_binary <~> B'10101010...' AS hamming_distance
FROM documents_binary
ORDER BY hamming_distance
LIMIT 10;
```

**ì–¸ì œ ì‚¬ìš©?**
```
âœ… ì¤‘ë³µ ë¬¸ì„œ íƒì§€
âœ… ìœ ì‚¬ ì´ë¯¸ì§€ ë¹ ë¥¸ ê²€ìƒ‰ (perceptual hash)
âœ… Two-Stage ê²€ìƒ‰ (binary â†’ full vector)
```

---

### â‘¥ Jaccard Distance - `<%>` (binary ì „ìš©)

**ê°œë…:**  
ë‘ ì§‘í•© ê°„ì˜ **ì°¨ì§‘í•© / í•©ì§‘í•©** ë¹„ìœ¨ì…ë‹ˆë‹¤. ì§‘í•© ìœ ì‚¬ë„ë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤.

**ìˆ˜ì‹:**
```
Jaccard Similarity = |A âˆ© B| / |A âˆª B|
Jaccard Distance = 1 - Jaccard Similarity

ì˜ˆì‹œ:
A = {1, 2, 3, 4}
B = {3, 4, 5, 6}

êµì§‘í•©: {3, 4} = 2ê°œ
í•©ì§‘í•©: {1, 2, 3, 4, 5, 6} = 6ê°œ

Jaccard Similarity = 2/6 = 0.333
Jaccard Distance = 1 - 0.333 = 0.667
```

**íŠ¹ì§•:**
- `bit` íƒ€ì… ì „ìš©
- ì§‘í•© ë¹„êµì— ìµœì í™”
- íƒœê·¸, í‚¤ì›Œë“œ ìœ ì‚¬ë„ ì¸¡ì •

**ì˜ˆì‹œ:**
```sql
-- Jaccard Distance ê²€ìƒ‰
SELECT 
    tags,
    tags_binary <%> B'11010100...' AS jaccard_distance
FROM articles
ORDER BY jaccard_distance
LIMIT 10;
```

**ì–¸ì œ ì‚¬ìš©?**
```
âœ… íƒœê·¸ ìœ ì‚¬ë„ ë¹„êµ
âœ… ì¹´í…Œê³ ë¦¬ ë§¤ì¹­
âœ… í‚¤ì›Œë“œ ê¸°ë°˜ ë¬¸ì„œ ë¶„ë¥˜
```

---

### ê±°ë¦¬ í•¨ìˆ˜ ì „ì²´ ë¹„êµ

| í•¨ìˆ˜ | ì—°ì‚°ì | ê³ ë ¤ì‚¬í•­ | ê³„ì‚° ë³µì¡ë„ | ì£¼ìš” ìš©ë„ |
|------|--------|----------|------------|----------|
| **L2 Distance** | `<->` | ë°©í–¥ + í¬ê¸° | O(n) | ì´ë¯¸ì§€ ê²€ìƒ‰ |
| **Cosine Distance** | `<=>` | ë°©í–¥ë§Œ | O(n) | í…ìŠ¤íŠ¸ ê²€ìƒ‰ â­ |
| **Inner Product** | `<#>` | ë°©í–¥ + í¬ê¸° | O(n) | ì¶”ì²œ ì‹œìŠ¤í…œ |
| **L1 Distance** | `<+>` | ì°¨ì›ë³„ ì°¨ì´ | O(n) | í¬ì†Œ ë²¡í„° |
| **Hamming Distance** | `<~>` | ë¹„íŠ¸ ì°¨ì´ | O(n/64) | ì¤‘ë³µ íƒì§€ |
| **Jaccard Distance** | `<%>` | ì§‘í•© ìœ ì‚¬ë„ | O(n/64) | íƒœê·¸ ë¹„êµ |

**ë³µì¡ë„:**
- n = ë²¡í„° ì°¨ì›
- binary íƒ€ì…ì€ 64ë°° ë¹ ë¦„ (64ë¹„íŠ¸ ë³‘ë ¬ ì²˜ë¦¬)

---

### ê±°ë¦¬ í•¨ìˆ˜ ì‹¤ì œ ë¹„êµ
```sql
-- vector íƒ€ì…: ìƒìœ„ 4ê°œ í•¨ìˆ˜ ë¹„êµ
SELECT 
    chunk_text,
    embedding <-> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS l2_distance,
    embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS cosine_distance,
    embedding <#> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS inner_product,
    embedding <+> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS l1_distance
FROM paper_chunks
WHERE paper_id = 'kim_phd_2024'
LIMIT 3;
```

**ê²°ê³¼ ì˜ˆì‹œ:**
```
chunk_text          | l2_dist | cos_dist | inner_prod | l1_dist
--------------------|---------|----------|------------|--------
"ìˆ˜ì˜¨ 25ë„ì—ì„œ..."  | 12.5    | 0.15     | -0.85      | 45.2
"ì‹¤í—˜ ë°©ë²•ì€..."    | 15.3    | 0.23     | -0.72      | 52.1
"ê²°ê³¼ ë¶„ì„..."      | 18.7    | 0.31     | -0.65      | 61.3
```

---

### Pythonì—ì„œ ì‚¬ìš© ì˜ˆì‹œ
```python
from sentence_transformers import SentenceTransformer

model = SentenceTransformer("jhgan/ko-sbert-sts")
question = "ìµœì  ìˆ˜ì˜¨ì€ ëª‡ ë„ì¸ê°€ìš”?"
query_embedding = model.encode(question).tolist()

# Cosine Distance (í…ìŠ¤íŠ¸ ê²€ìƒ‰ ê¶Œì¥)
cur.execute("""
    SELECT 
        chunk_text,
        metadata->>'page_number' AS page,
        embedding <=> %s AS distance
    FROM paper_chunks
    WHERE paper_id = %s
    ORDER BY distance
    LIMIT 5
""", (query_embedding, 'kim_phd_2024'))

results = cur.fetchall()
for text, page, dist in results:
    print(f"[í˜ì´ì§€ {page}] ìœ ì‚¬ë„: {1-dist:.2%}")
    print(text[:100])
    print()
```

---

### ì„ íƒ ê°€ì´ë“œ
```
ë…¼ë¬¸ PDF ê²€ìƒ‰ (RAG):
â†’ Cosine Distance (<=>)  âœ…

ì´ë¯¸ì§€ ê²€ìƒ‰:
â†’ L2 Distance (<->)  âœ…

ì¶”ì²œ ì‹œìŠ¤í…œ (ì˜í™”, ìƒí’ˆ):
â†’ Inner Product (<#>)  âœ…

ê³ ì°¨ì› í¬ì†Œ ë²¡í„°:
â†’ L1 Distance (<+>)  âœ…

ì¤‘ë³µ íƒì§€:
â†’ Hamming Distance (<~>)  âœ…

íƒœê·¸/í‚¤ì›Œë“œ ë§¤ì¹­:
â†’ Jaccard Distance (<%>)  âœ…

ì¼ë°˜ì ì¸ í…ìŠ¤íŠ¸ ê²€ìƒ‰:
â†’ Cosine Distance (<=>)  âœ… (90% ì´ìƒ ì‚¬ìš©)
```

---

## 2) Top-K ê²€ìƒ‰ (ìµœê·¼ì ‘ ì´ì›ƒ)

ê°€ì¥ ìœ ì‚¬í•œ Kê°œì˜ ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ëŠ” **K-Nearest Neighbors (KNN)** ê²€ìƒ‰ì…ë‹ˆë‹¤.

### Kê°’ ì„ íƒ ê¸°ì¤€

```
K=1:  ê°€ì¥ ìœ ì‚¬í•œ 1ê°œ (ì •í™•í•œ ë§¤ì¹­)
K=3:  ìƒìœ„ 3ê°œ (ì¼ë°˜ì )
K=5:  ìƒìœ„ 5ê°œ (ê· í˜•)
K=10: ìƒìœ„ 10ê°œ (ë‹¤ì–‘ì„±)
K=20: ì¬ìˆœìœ„(Re-ranking) í›„ë³´êµ°
```

### ê¸°ë³¸ Top-K ê²€ìƒ‰

```sql
-- Top-5 ê²€ìƒ‰
SELECT 
    paper_id,
    chunk_index,
    chunk_text,
    metadata->>'section' AS section,
    embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS distance
FROM paper_chunks
ORDER BY distance
LIMIT 5;
```

### íŠ¹ì • ë…¼ë¬¸ì—ì„œ Top-K ê²€ìƒ‰

```sql
-- íŠ¹ì • ë…¼ë¬¸ì—ì„œë§Œ ê²€ìƒ‰ (ë” ë¹ ë¦„)
SELECT 
    chunk_index,
    chunk_text,
    metadata->>'page_number' AS page,
    embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS distance
FROM paper_chunks
WHERE paper_id = 'kim_phd_2024'
ORDER BY distance
LIMIT 3;
```

### ê±°ë¦¬ ì„ê³„ê°’ ì‚¬ìš©

```sql
-- ê±°ë¦¬ê°€ 0.5 ì´í•˜ì¸ ê²ƒë§Œ (ìœ ì‚¬ë„ 50% ì´ìƒ)
SELECT 
    chunk_text,
    embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS distance
FROM paper_chunks
WHERE paper_id = 'kim_phd_2024'
  AND embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) < 0.5
ORDER BY distance
LIMIT 10;
```

---

## 3) í•„í„°ë§ + ë²¡í„° ê²€ìƒ‰ (í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰)

ë©”íƒ€ë°ì´í„° ì¡°ê±´ê³¼ ë²¡í„° ìœ ì‚¬ë„ë¥¼ ê²°í•©í•œ ê²€ìƒ‰ì…ë‹ˆë‹¤.

### ê¸°ë³¸ í•„í„°ë§ ê²€ìƒ‰

```sql
-- íŠ¹ì • ì„¹ì…˜ì—ì„œë§Œ ê²€ìƒ‰
SELECT 
    chunk_text,
    metadata->>'section' AS section,
    embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS distance
FROM paper_chunks
WHERE metadata->>'section' = 'ì—°êµ¬ ë°©ë²•ë¡ '
ORDER BY distance
LIMIT 5;
```

### ë³µí•© ì¡°ê±´ í•„í„°ë§

```sql
-- ì—¬ëŸ¬ ì¡°ê±´ ê²°í•©
SELECT 
    paper_id,
    chunk_text,
    metadata->>'page_number' AS page,
    metadata->>'section' AS section,
    embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS distance
FROM paper_chunks
WHERE 
    metadata->>'language' = 'ko'
    AND (metadata->>'page_number')::int BETWEEN 3 AND 7
    AND metadata->>'section' IN ('ì—°êµ¬ë°©ë²•', 'ì‹¤í—˜ê²°ê³¼')
ORDER BY distance
LIMIT 10;
```
---

## 4) Exact vs Approximate ê²€ìƒ‰

ì •í™•ë„ì™€ ì†ë„ì˜ íŠ¸ë ˆì´ë“œì˜¤í”„ë¥¼ ì´í•´í•˜ê³  ìƒí™©ì— ë§ê²Œ ì„ íƒí•©ë‹ˆë‹¤.

### ì¸ë±ìŠ¤ì˜ ì—­í• 

ë²¡í„° ê²€ìƒ‰ì—ì„œ **ì¸ë±ìŠ¤ëŠ” ê²€ìƒ‰ ì†ë„ë¥¼ ë†’ì´ëŠ” ëŒ€ì‹  ì •í™•ë„ë¥¼ ì•½ê°„ í¬ìƒ**í•©ë‹ˆë‹¤.
```
ì¸ë±ìŠ¤ ì—†ìŒ (Exact Search):
- PostgreSQLì´ í…Œì´ë¸”ì˜ ëª¨ë“  í–‰ì„ ìˆœì°¨ì ìœ¼ë¡œ ì½ìŒ (Sequential Scan)
- ëª¨ë“  ë²¡í„°ì™€ ê±°ë¦¬ë¥¼ ì •í™•íˆ ê³„ì‚°
- 100% ì •í™•í•˜ì§€ë§Œ ëŠë¦¼

ì¸ë±ìŠ¤ ìˆìŒ (Approximate Search):
- HNSW/IVFFlat ì¸ë±ìŠ¤ê°€ "ë¹„ìŠ·í•œ í›„ë³´"ë¥¼ ë¹ ë¥´ê²Œ ì°¾ìŒ
- ì „ì²´ë¥¼ ë³´ì§€ ì•Šê³  ì¼ë¶€ë§Œ ê²€ì‚¬
- 99%+ ì •í™•í•˜ì§€ë§Œ ë§¤ìš° ë¹ ë¦„
```

**í•µì‹¬:** ì¸ë±ìŠ¤ê°€ ìˆìœ¼ë©´ PostgreSQLì´ ìë™ìœ¼ë¡œ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. Exact Searchë¥¼ ê°•ì œí•˜ë ¤ë©´ ì¸ë±ìŠ¤ë¥¼ ì œê±°í•´ì•¼ í•©ë‹ˆë‹¤.

---

### Exact Search (ì •í™• ê²€ìƒ‰)

**íŠ¹ì§•:**
- ëª¨ë“  ë²¡í„°ì™€ ê±°ë¦¬ ê³„ì‚° (Sequential Scan)
- 100% ì •í™•í•œ ê²°ê³¼ ë³´ì¥
- ëŠë¦¼ (ë°ì´í„°ê°€ ë§ì„ìˆ˜ë¡)

**ì–¸ì œ ì‚¬ìš©?**
```
âœ… ë°ì´í„°ê°€ ì ì„ ë•Œ (1,000ê±´ ë¯¸ë§Œ)
âœ… ì •í™•ë„ê°€ ì ˆëŒ€ì ìœ¼ë¡œ ì¤‘ìš”í•  ë•Œ
âœ… ë²¤ì¹˜ë§ˆí¬ í…ŒìŠ¤íŠ¸ (ì¸ë±ìŠ¤ ì„±ëŠ¥ ë¹„êµ)
âŒ ëŒ€ìš©ëŸ‰ ë°ì´í„° (ë„ˆë¬´ ëŠë¦¼)
```

**ì˜ˆì‹œ:**
```sql
-- Step 1: ì¸ë±ìŠ¤ ì œê±° (Exact Search ê°•ì œ)
DROP INDEX IF EXISTS idx_paper_chunks_embedding;

-- ì´ì œ PostgreSQLì€ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ
-- â†’ Sequential Scanìœ¼ë¡œ ëª¨ë“  í–‰ ê²€ì‚¬

-- Step 2: Exact Search ì‹¤í–‰
SELECT 
    chunk_text,
    embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS distance
FROM paper_chunks
ORDER BY distance
LIMIT 10;

-- Step 3: ì‹¤í–‰ ê³„íš í™•ì¸
EXPLAIN ANALYZE
SELECT 
    chunk_text,
    embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS distance
FROM paper_chunks
ORDER BY distance
LIMIT 10;

-- ê²°ê³¼:
-- Seq Scan on paper_chunks (ì‹¤ì œ ì‹œê°„: xxxxxms)
-- â†’ ëª¨ë“  í–‰ì„ ìˆœì°¨ì ìœ¼ë¡œ ì½ìŒ
```

---

### Approximate Search (ê·¼ì‚¬ ê²€ìƒ‰)

**íŠ¹ì§•:**
- ì¸ë±ìŠ¤ ì‚¬ìš© (HNSW, IVFFlat)
- 99%+ ì •í™•ë„ (ê±°ì˜ ì •í™•)
- ë§¤ìš° ë¹ ë¦„ (10ë°° ~ 100ë°°)

**ì–¸ì œ ì‚¬ìš©?**
```
âœ… ë°ì´í„°ê°€ ë§ì„ ë•Œ (1,000ê±´ ì´ìƒ) â­
âœ… ì‹¤ì‹œê°„ ê²€ìƒ‰ì´ í•„ìš”í•  ë•Œ
âœ… 99% ì •í™•ë„ë¡œ ì¶©ë¶„í•  ë•Œ
âœ… ì¼ë°˜ì ì¸ RAG ì‹œìŠ¤í…œ (ê¶Œì¥)
```

**ì˜ˆì‹œ:**
```sql
-- Step 1: HNSW ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops);

-- ì´ì œ PostgreSQLì´ ìë™ìœ¼ë¡œ ì¸ë±ìŠ¤ ì‚¬ìš©
-- â†’ Index Scanìœ¼ë¡œ ë¹ ë¥¸ ê²€ìƒ‰

-- Step 2: Approximate Search ì‹¤í–‰
SELECT 
    chunk_text,
    embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS distance
FROM paper_chunks
ORDER BY distance
LIMIT 10;

-- Step 3: ì‹¤í–‰ ê³„íš í™•ì¸
EXPLAIN ANALYZE
SELECT 
    chunk_text,
    embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS distance
FROM paper_chunks
ORDER BY distance
LIMIT 10;

-- ê²°ê³¼:
-- Index Scan using idx_paper_chunks_embedding (ì‹¤ì œ ì‹œê°„: xxms)
-- â†’ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•´ ë¹ ë¥´ê²Œ ê²€ìƒ‰
```

---

### ì„±ëŠ¥ ë¹„êµ(ì˜ˆì‹œ)

| ë°©ë²• | ë°ì´í„° ê·œëª¨ | ê²€ìƒ‰ ì‹œê°„ | ì •í™•ë„ | ì‹¤í–‰ ë°©ì‹ |
|------|-----------|----------|--------|----------|
| **Exact** | 1,000ê±´ | 50ms | 100% | Sequential Scan |
| **Exact** | 10,000ê±´ | 500ms | 100% | Sequential Scan |
| **Exact** | 100,000ê±´ | 5ì´ˆ | 100% | Sequential Scan |
| **Approximate (HNSW)** | 1,000ê±´ | 5ms | 99%+ | Index Scan |
| **Approximate (HNSW)** | 10,000ê±´ | 10ms | 99%+ | Index Scan |
| **Approximate (HNSW)** | 100,000ê±´ | 50ms | 99%+ | Index Scan |

**ì†ë„ ì°¨ì´:**
```
1,000ê±´: 10ë°° ì°¨ì´ (50ms â†’ 5ms)
10,000ê±´: 50ë°° ì°¨ì´ (500ms â†’ 10ms)
100,000ê±´: 100ë°° ì°¨ì´ (5ì´ˆ â†’ 50ms)

â†’ ë°ì´í„°ê°€ ë§ì„ìˆ˜ë¡ ì¸ë±ìŠ¤ íš¨ê³¼ê°€ í¼!
```

---

### ì •í™•ë„ ì¡°ì • (HNSW)

ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë©´ì„œë„ ì •í™•ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```sql
-- ì •í™•ë„ ë‚®ìŒ (ë¹ ë¦„)
SET hnsw.ef_search = 20;  

-- ê¸°ë³¸ê°’ (ê· í˜•)
SET hnsw.ef_search = 40;  -- ê¸°ë³¸ê°’ (ê¶Œì¥)

-- ì •í™•ë„ ë†’ìŒ (ëŠë¦¼)
SET hnsw.ef_search = 100;

-- ë§¤ìš° ë†’ì€ ì •í™•ë„ (ë” ëŠë¦¼)
SET hnsw.ef_search = 200;

-- ê²€ìƒ‰ ì‹¤í–‰
SELECT 
    chunk_text,
    embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS distance
FROM paper_chunks
ORDER BY distance
LIMIT 10;

-- ì„¤ì • ì´ˆê¸°í™”
SET hnsw.ef_search = 40;
```

**ef_search ê°’ì— ë”°ë¥¸ ë³€í™”:**

| ef_search | ê²€ìƒ‰ ì‹œê°„ | ì •í™•ë„ | ì‚¬ìš© ì‹œê¸° |
|-----------|----------|--------|----------|
| 20 | 5ms | 95% | ë¹ ë¥¸ ê²€ìƒ‰ ìš°ì„  |
| 40 | 10ms | 99% | **ì¼ë°˜ì  (ê¶Œì¥)** â­ |
| 100 | 25ms | 99.5% | ë†’ì€ ì •í™•ë„ í•„ìš” |
| 200 | 50ms | 99.9% | Exactì— ê°€ê¹Œì›€ |

---

### Exact vs Approximate ì‹¤ì œ ë¹„êµ
```sql
-- í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¤€ë¹„ (10,000ê°œ ì²­í¬)
INSERT INTO paper_chunks (paper_id, chunk_index, chunk_text, embedding)
SELECT 
    'test_paper',
    i,
    'í…ŒìŠ¤íŠ¸ ì²­í¬ ' || i,
    ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768)
FROM generate_series(0, 9999) i;

-- Case 1: Exact Search (ì¸ë±ìŠ¤ ì—†ìŒ)
DROP INDEX IF EXISTS idx_paper_chunks_embedding;

EXPLAIN ANALYZE
SELECT chunk_text, embedding <=> '[0.1, 0.2, ...]'::vector(768) AS distance
FROM paper_chunks
ORDER BY distance
LIMIT 10;

-- ê²°ê³¼: Seq Scan, ì‹¤ì œ ì‹œê°„: 523ms

-- Case 2: Approximate Search (ì¸ë±ìŠ¤ ìˆìŒ)
CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks 
USING hnsw (embedding vector_cosine_ops);

EXPLAIN ANALYZE
SELECT chunk_text, embedding <=> '[0.1, 0.2, ...]'::vector(768) AS distance
FROM paper_chunks
ORDER BY distance
LIMIT 10;

-- ê²°ê³¼: Index Scan, ì‹¤ì œ ì‹œê°„: 12ms

-- ì†ë„ ì°¨ì´: 43ë°°!
```

---

### ì¸ë±ìŠ¤ ìƒì„± ì‹œì 
```sql
-- âŒ ë‚˜ìœ ë°©ë²•: ë°ì´í„° ì‚½ì… ì „ ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks USING hnsw (embedding vector_cosine_ops);

INSERT INTO paper_chunks ...  -- ë§¤ìš° ëŠë¦¼!

-- âœ… ì¢‹ì€ ë°©ë²•: ë°ì´í„° ì‚½ì… í›„ ì¸ë±ìŠ¤ ìƒì„±
INSERT INTO paper_chunks ...  -- ë¹ ë¦„

CREATE INDEX idx_paper_chunks_embedding 
ON paper_chunks USING hnsw (embedding vector_cosine_ops);
```

**ì´ìœ :**
- ì¸ë±ìŠ¤ê°€ ìˆìœ¼ë©´ INSERTë§ˆë‹¤ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸ í•„ìš”
- ëŒ€ëŸ‰ INSERT ì‹œ ë§¤ìš° ëŠë ¤ì§
- ë°ì´í„° ì‚½ì… í›„ í•œ ë²ˆì— ì¸ë±ìŠ¤ ìƒì„±ì´ í›¨ì”¬ ë¹ ë¦„

---

### ì„ íƒ ê°€ì´ë“œ
```
ë°ì´í„° 1,000ê±´ ë¯¸ë§Œ:
â†’ Exact Search (ì¸ë±ìŠ¤ ë¶ˆí•„ìš”)
â†’ ì¸ë±ìŠ¤ ìƒì„± ì˜¤ë²„í—¤ë“œê°€ ë” í¼

ë°ì´í„° 1,000~10,000ê±´:
â†’ Approximate Search (HNSW) âœ…
â†’ ì†ë„ 10~50ë°° í–¥ìƒ

ë°ì´í„° 10,000ê±´ ì´ìƒ:
â†’ Approximate Search (HNSW í•„ìˆ˜) âœ…
â†’ ì†ë„ 50~100ë°° í–¥ìƒ

ì •í™•ë„ê°€ ìƒëª…ì¸ ê²½ìš°:
â†’ Exact Search + ìºì‹±
â†’ ë˜ëŠ” HNSW + ef_search=200
```

---

### ì‹¤ì „ ê¶Œì¥ì‚¬í•­

**ë…¼ë¬¸ RAG ì‹œìŠ¤í…œ (ë‹¹ì‹ ì˜ ê²½ìš°):**
```sql
-- ë…¼ë¬¸ 1ê°œ (ì²­í¬ 10ê°œ):
â†’ ì¸ë±ìŠ¤ ë¶ˆí•„ìš” (Exact Search)

-- ë…¼ë¬¸ 10ê°œ (ì²­í¬ 100ê°œ):
â†’ ì¸ë±ìŠ¤ ë¶ˆí•„ìš” (Exact Search)

-- ë…¼ë¬¸ 100ê°œ (ì²­í¬ 1,000ê°œ):
â†’ HNSW ì¸ë±ìŠ¤ ìƒì„± âœ…

-- ë…¼ë¬¸ 1,000ê°œ ì´ìƒ:
â†’ HNSW ì¸ë±ìŠ¤ í•„ìˆ˜ âœ…
```

**ì¼ë°˜ ì›ì¹™:**
```
1. ê°œë°œ/í…ŒìŠ¤íŠ¸: Exact Search (ì •í™•ë„ í™•ì¸)
2. í”„ë¡œë•ì…˜: Approximate Search (HNSW)
3. ì„±ëŠ¥ ë¬¸ì œ ì‹œ: ef_search ì¡°ì •
```

---

## 5) Re-ranking (ì¬ìˆœìœ„)

**Coarse-to-Fine** ì „ëµ: ë¹ ë¥¸ ê²€ìƒ‰ â†’ ì •ë°€ ì¬ì •ë ¬

### ì „ëµ 1: ë§ì´ ê°€ì ¸ì™€ì„œ ì¬ì •ë ¬

```sql
-- Step 1: í›„ë³´ 20ê°œ ë¹ ë¥´ê²Œ ì¶”ì¶œ
WITH candidates AS (
    SELECT 
        id,
        chunk_text,
        embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS distance
    FROM paper_chunks
    WHERE paper_id = 'kim_phd_2024'
    ORDER BY distance
    LIMIT 20  -- ë§ì´ ê°€ì ¸ì˜´
)
-- Step 2: ìƒìœ„ 5ê°œë§Œ ì„ íƒ (ì¶”ê°€ ë¡œì§ ê°€ëŠ¥)
SELECT 
    chunk_text,
    distance
FROM candidates
ORDER BY distance
LIMIT 5;
```

### ì „ëµ 2: Binary + Full Vector (Two-Stage)

**ëª©ì :**  
ëŒ€ìš©ëŸ‰ ë°ì´í„°(100ë§Œ+ ë²¡í„°)ì—ì„œ **2ë‹¨ê³„ í•„í„°ë§**ìœ¼ë¡œ ê²€ìƒ‰ ì†ë„ë¥¼ ê·¹ëŒ€í™”í•©ë‹ˆë‹¤.

**ì‘ë™ ì›ë¦¬:**
```
ì›ë³¸ ë°ì´í„°: 100ë§Œ ê°œ ë²¡í„°

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ë‹¨ê³„: Binaryë¡œ í›„ë³´ ì¢íˆê¸° (ì´ˆê³ ì†)    â”‚
â”‚                                         â”‚
â”‚ embedding_binary (768bit, 96 bytes)    â”‚
â”‚ â†’ 0/1ë¡œ ë‹¨ìˆœí™”ëœ ë²¡í„°                   â”‚
â”‚ â†’ Hamming Distance (ë¹„íŠ¸ ë¹„êµ)          â”‚
â”‚ â†’ ë§¤ìš° ë¹ ë¦„ (64ë¹„íŠ¸ ë³‘ë ¬ ì²˜ë¦¬)          â”‚
â”‚                                         â”‚
â”‚ 100ë§Œ ê°œ â†’ 1,000ê°œë¡œ ì¶•ì†Œ (0.1%)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ë‹¨ê³„: Full Vectorë¡œ ì •ë°€ ì¬ì •ë ¬        â”‚
â”‚                                         â”‚
â”‚ embedding (768 floats, 3KB)            â”‚
â”‚ â†’ ì›ë³¸ ì •ë°€ ë²¡í„°                        â”‚
â”‚ â†’ Cosine Distance (ì •í™•í•œ ê³„ì‚°)         â”‚
â”‚ â†’ 1,000ê°œë§Œ ê³„ì‚°í•˜ë¯€ë¡œ ë¹ ë¦„            â”‚
â”‚                                         â”‚
â”‚ 1,000ê°œ â†’ ìƒìœ„ 10ê°œ ì„ íƒ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ê²°ê³¼: 100ë§Œ ê°œì—ì„œ ì •í™•í•œ ìƒìœ„ 10ê°œ ì¶”ì¶œ
```

**Binary ë²¡í„°ë€?**
```python
# ì›ë³¸ ë²¡í„° (float, 3KB)
full_vector = [0.8, -0.3, 0.5, -0.1, ...]  # 768ê°œ float

# Binary ë²¡í„° (0/1, 96 bytes)
binary_vector = [1, 0, 1, 0, ...]  # 768ê°œ bit
                 â†‘  â†‘  â†‘  â†‘
        ì–‘ìˆ˜ë©´ 1, ìŒìˆ˜ë©´ 0 (ë‹¨ìˆœí™”)

# ì†ë„: Binaryê°€ 32ë°° ë¹ ë¦„ (float32 â†’ bit)
```

**ì˜ˆì‹œ:**
```sql
-- 1ë‹¨ê³„: Binaryë¡œ ë¹ ë¥´ê²Œ 1,000ê°œ ì¶”ì¶œ (0.05ì´ˆ)
WITH candidates AS (
    SELECT id
    FROM paper_chunks
    ORDER BY embedding_binary  B'10101010...'  -- ë¹„íŠ¸ ë¹„êµë§Œ
    LIMIT 1000  -- 100ë§Œ ê°œ â†’ 1,000ê°œ
)
-- 2ë‹¨ê³„: Full Vectorë¡œ ì •ë°€ ì¬ì •ë ¬ (0.01ì´ˆ)
SELECT 
    p.chunk_text,
    p.embedding <=> '[0.1, 0.2, ...]'::vector(768) AS distance
FROM paper_chunks p
JOIN candidates c ON p.id = c.id  -- 1,000ê°œë§Œ
ORDER BY distance
LIMIT 10;

-- ì´ ì‹œê°„: 0.06ì´ˆ (vs ì§ì ‘ ê²€ìƒ‰ 0.2ì´ˆ)
```

**ì™œ ë¹ ë¥¸ê°€?**

| ë‹¨ê³„ | ì²˜ë¦¬ëŸ‰ | ë°©ë²• | ì‹œê°„ |
|------|--------|------|------|
| 1ë‹¨ê³„ | 100ë§Œ ê°œ | Binary (ê°„ë‹¨) | 0.05ì´ˆ |
| 2ë‹¨ê³„ | 1,000ê°œ | Full Vector (ì •ë°€) | 0.01ì´ˆ |
| **í•©ê³„** | - | - | **0.06ì´ˆ** |
| ì§ì ‘ ê²€ìƒ‰ | 100ë§Œ ê°œ | Full Vector | 0.20ì´ˆ |

**í•µì‹¬:**
- BinaryëŠ” "ëŒ€ì¶© ë¹„ìŠ·í•œ ê²ƒ" ë¹ ë¥´ê²Œ ì°¾ê¸° (99.9% ì œê±°)
- Full VectorëŠ” "ì •í™•íˆ ê°€ì¥ ë¹„ìŠ·í•œ ê²ƒ" ì°¾ê¸° (1,000ê°œë§Œ)

**ì–¸ì œ ì‚¬ìš©?**
```
âœ… 100ë§Œ ê°œ ì´ìƒ ëŒ€ìš©ëŸ‰
âœ… ì‹¤ì‹œê°„ ì†ë„ê°€ ì¤‘ìš”
âŒ 10ë§Œ ê°œ ì´í•˜ (HNSWë¡œ ì¶©ë¶„)
```

**íŠ¸ë ˆì´ë“œì˜¤í”„:**
- ì†ë„: 3ë°° ë¹ ë¦„ âœ…
- ì •í™•ë„: 1% ê°ì†Œ (98%) âš ï¸
- ì €ì¥: Binary ì»¬ëŸ¼ ì¶”ê°€ (96 bytes/í–‰)


### ì „ëµ 3: ë©”íƒ€ë°ì´í„° ìŠ¤ì½”ì–´ ê²°í•©

```sql
-- ë²¡í„° ìœ ì‚¬ë„(70%) + ì¸ê¸°ë„(30%) ê²°í•©
SELECT 
    chunk_text,
    metadata->>'view_count' AS views,
    -- í•˜ì´ë¸Œë¦¬ë“œ ìŠ¤ì½”ì–´ ê³„ì‚°
    (0.7 * (1 - (embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768)))) +
    (0.3 * LEAST((metadata->>'view_count')::float / 1000, 1.0)) AS hybrid_score
FROM paper_chunks
WHERE paper_id = 'kim_phd_2024'
ORDER BY hybrid_score DESC
LIMIT 10;
```

### ì „ëµ 4: ì¸ì ‘ ì²­í¬ í¬í•¨

```sql
-- ìœ ì‚¬í•œ ì²­í¬ ì°¾ê³  ì•ë’¤ ì²­í¬ë„ í•¨ê»˜ ë°˜í™˜
WITH top_chunks AS (
    SELECT 
        paper_id,
        chunk_index,
        embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS distance
    FROM paper_chunks
    WHERE paper_id = 'kim_phd_2024'
    ORDER BY distance
    LIMIT 3
)
SELECT 
    p.chunk_index,
    p.chunk_text,
    p.metadata->>'section' AS section,
    t.distance
FROM paper_chunks p
JOIN top_chunks t ON p.paper_id = t.paper_id
WHERE p.chunk_index BETWEEN t.chunk_index - 1 AND t.chunk_index + 1
ORDER BY t.distance, p.chunk_index;
```

### Python Re-ranking ì˜ˆì‹œ

```python
def search_and_rerank(question, paper_id, top_k=5, candidate_k=20):
    """í›„ë³´ ì¶”ì¶œ â†’ ì¬ì •ë ¬"""
    query_embedding = model.encode(question).tolist()
    
    # Step 1: í›„ë³´ 20ê°œ ì¶”ì¶œ
    cur.execute("""
        SELECT 
            id,
            chunk_text,
            metadata,
            embedding <=> %s AS distance
        FROM paper_chunks
        WHERE paper_id = %s
        ORDER BY distance
        LIMIT %s
    """, (query_embedding, paper_id, candidate_k))
    
    candidates = cur.fetchall()
    
    # Step 2: Pythonì—ì„œ ì¬ì •ë ¬ (ì¶”ê°€ ë¡œì§)
    reranked = []
    for id, text, metadata, distance in candidates:
        # ì¬ì •ë ¬ ìŠ¤ì½”ì–´ ê³„ì‚°
        vector_score = 1 - distance
        keyword_score = calculate_keyword_score(text, question)  # ì‚¬ìš©ì ì •ì˜
        
        final_score = 0.7 * vector_score + 0.3 * keyword_score
        reranked.append((text, metadata, final_score))
    
    # Step 3: ìƒìœ„ Kê°œ ë°˜í™˜
    reranked.sort(key=lambda x: x[2], reverse=True)
    return reranked[:top_k]
```

---

## 6) ê³ ê¸‰ ì¿¼ë¦¬ íŒ¨í„´

### ë‹¤ì¤‘ ë…¼ë¬¸ í†µí•© ê²€ìƒ‰

```sql
-- ì—¬ëŸ¬ ë…¼ë¬¸ì—ì„œ ê²€ìƒ‰ + ë…¼ë¬¸ë³„ ìƒìœ„ 2ê°œì”©
WITH ranked AS (
    SELECT 
        paper_id,
        chunk_text,
        metadata->>'paper_title' AS title,
        embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS distance,
        ROW_NUMBER() OVER (PARTITION BY paper_id ORDER BY embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768)) AS rn
    FROM paper_chunks
)
SELECT 
    paper_id,
    title,
    chunk_text,
    distance
FROM ranked
WHERE rn <= 2  -- ë…¼ë¬¸ë³„ ìƒìœ„ 2ê°œ
ORDER BY distance
LIMIT 10;
```

### ì œì™¸ ê²€ìƒ‰ (NOT)

```sql
-- íŠ¹ì • ë…¼ë¬¸ ì œì™¸
SELECT 
    paper_id,
    chunk_text,
    embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS distance
FROM paper_chunks
WHERE paper_id NOT IN ('old_paper_2020', 'deprecated_paper')
ORDER BY distance
LIMIT 10;
```

### OR ì¡°ê±´ ê²€ìƒ‰

```sql
-- ì—¬ëŸ¬ ì„¹ì…˜ ì¤‘ í•˜ë‚˜
SELECT 
    chunk_text,
    metadata->>'section' AS section,
    embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768) AS distance
FROM paper_chunks
WHERE metadata->>'section' IN ('ì„œë¡ ', 'ê²°ë¡ ', 'ìš”ì•½')
ORDER BY distance
LIMIT 10;
```

---

## 7) ì„±ëŠ¥ ìµœì í™” íŒ

### LIMIT í•„ìˆ˜ ì‚¬ìš©

```sql
-- âŒ ë§¤ìš° ëŠë¦¼ (ì „ì²´ ìŠ¤ìº” í›„ ì •ë ¬)
SELECT * FROM paper_chunks
ORDER BY embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768);

-- âœ… ë¹ ë¦„ (ìƒìœ„ Kê°œë§Œ ê³„ì‚°)
SELECT * FROM paper_chunks
ORDER BY embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768)
LIMIT 10;
```

### WHERE ì¡°ê±´ ë¨¼ì €

```sql
-- âœ… ì¢‹ì€ ìˆœì„œ: WHERE â†’ ORDER BY
SELECT * FROM paper_chunks
WHERE paper_id = 'kim_phd_2024'  -- ë²”ìœ„ ì¢í˜
ORDER BY embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768)
LIMIT 10;

-- âŒ ë‚˜ìœ ìˆœì„œ: ORDER BY â†’ WHERE (ëŠë¦¼)
SELECT * FROM (
    SELECT * FROM paper_chunks
    ORDER BY embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768)
    LIMIT 100
) sub
WHERE paper_id = 'kim_phd_2024';
```

### ì¸ë±ìŠ¤ í™œìš© í™•ì¸

```sql
-- ì‹¤í–‰ ê³„íš í™•ì¸
EXPLAIN ANALYZE
SELECT * FROM paper_chunks
WHERE paper_id = 'kim_phd_2024'
ORDER BY embedding <=> ARRAY(SELECT random()::float FROM generate_series(1, 768))::vector(768)
LIMIT 10;

-- "Index Scan using idx_paper_chunks_embedding" í™•ì¸
-- Seq Scanì´ë©´ ì¸ë±ìŠ¤ ë¯¸ì‚¬ìš© â†’ ëŠë¦¼
```

---

# ğŸ¯ ìš”ì•½

**ë²¡í„° ê²€ìƒ‰ í•µì‹¬:**

1. **ê±°ë¦¬ ê¸°ë°˜ ê²€ìƒ‰**: `<=>` Cosine Distanceê°€ í…ìŠ¤íŠ¸ ê²€ìƒ‰ì— ìµœì 
2. **Top-K ê²€ìƒ‰**: LIMITìœ¼ë¡œ ìƒìœ„ Kê°œë§Œ ê°€ì ¸ì˜¤ê¸° (í•„ìˆ˜!)
3. **í•„í„°ë§**: WHERE ì¡°ê±´ìœ¼ë¡œ ë²”ìœ„ ì¢íŒ í›„ ë²¡í„° ê²€ìƒ‰
4. **Exact vs Approximate**: 1,000ê±´ ì´ìƒì´ë©´ ì¸ë±ìŠ¤(HNSW) í•„ìˆ˜
5. **Re-ranking**: í›„ë³´ ë§ì´ ì¶”ì¶œ â†’ ì •ë°€ ì¬ì •ë ¬

**ì„±ëŠ¥ ìµœì í™”:**
- LIMIT í•„ìˆ˜
- WHERE ì¡°ê±´ ë¨¼ì €
- HNSW ì¸ë±ìŠ¤ ìƒì„±
- hnsw.ef_search ì¡°ì •

**ì‹¤ì „ íŒ¨í„´:**
```sql
SELECT chunk_text, embedding <=> %s AS distance
FROM paper_chunks
WHERE paper_id = %s  -- í•„í„°ë§
ORDER BY distance
LIMIT 5;  -- Top-K
```

---