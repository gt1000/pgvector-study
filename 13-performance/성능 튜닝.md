# ğŸ“˜ 13. ì„±ëŠ¥ íŠœë‹ (Performance)

pgvectorì˜ ì„±ëŠ¥ì€ **PostgreSQL ì„¤ì •, ì¸ë±ìŠ¤ íŒŒë¼ë¯¸í„°, ì¿¼ë¦¬ ìµœì í™”**ì— í¬ê²Œ ì˜í–¥ì„ ë°›ìŠµë‹ˆë‹¤.  
ì´ ì¥ì—ì„œëŠ” ì‹¤ì „ì—ì„œ ê²€ì¦ëœ ì„±ëŠ¥ íŠœë‹ ê¸°ë²•ê³¼ ëª¨ë‹ˆí„°ë§ ë°©ë²•ì„ ë‹¤ë£¹ë‹ˆë‹¤.

> ğŸ” **í•µì‹¬ ê°œë…:**  
> - **PostgreSQL ë©”ëª¨ë¦¬ ì„¤ì •**: shared_buffers, work_mem ë“±ìœ¼ë¡œ ê²€ìƒ‰ ì†ë„ 2~5ë°° í–¥ìƒ  
> - **HNSW íŒŒë¼ë¯¸í„°**: m, ef_construction, ef_search ì¡°ì •ìœ¼ë¡œ ì†ë„/ì •í™•ë„ ê· í˜•  
> - **ì¿¼ë¦¬ ë¶„ì„**: EXPLAIN ANALYZEë¡œ ë³‘ëª© ì§€ì  ì‹ë³„ ë° í•´ê²°

---

## 1) PostgreSQL íŒŒë¼ë¯¸í„° íŠœë‹

### í•µì‹¬ ë©”ëª¨ë¦¬ íŒŒë¼ë¯¸í„°

PostgreSQLì˜ ë©”ëª¨ë¦¬ ì„¤ì •ì€ ë²¡í„° ê²€ìƒ‰ ì„±ëŠ¥ì— ì§ì ‘ì ì¸ ì˜í–¥ì„ ë¯¸ì¹©ë‹ˆë‹¤.

| íŒŒë¼ë¯¸í„° | ê¸°ë³¸ê°’ | ê¶Œì¥ê°’ (16GB RAM) | ì„¤ëª… |
|----------|--------|------------------|------|
| `shared_buffers` | 128MB | **4GB** | DB ìºì‹œ ë©”ëª¨ë¦¬ (RAMì˜ 25%) |
| `effective_cache_size` | 4GB | **12GB** | OS + DB ìºì‹œ ì´í•© (RAMì˜ 75%) |
| `maintenance_work_mem` | 64MB | **1GB** | ì¸ë±ìŠ¤ ìƒì„±/VACUUM ë©”ëª¨ë¦¬ |
| `work_mem` | 4MB | **64MB** | ì •ë ¬/í•´ì‹œ ì‘ì—… ë©”ëª¨ë¦¬ |
| `max_parallel_workers_per_gather` | 2 | **4** | ë³‘ë ¬ ì¿¼ë¦¬ ì›Œì»¤ ìˆ˜ |

### ì‹œìŠ¤í…œ ë©”ëª¨ë¦¬ë³„ ê¶Œì¥ ì„¤ì •

#### 16GB RAM ì‹œìŠ¤í…œ

```sql
-- postgresql.conf ë˜ëŠ” ALTER SYSTEM
ALTER SYSTEM SET shared_buffers = '4GB';
ALTER SYSTEM SET effective_cache_size = '12GB';
ALTER SYSTEM SET maintenance_work_mem = '1GB';
ALTER SYSTEM SET work_mem = '64MB';
ALTER SYSTEM SET max_parallel_workers_per_gather = 4;

-- ì ìš©
SELECT pg_reload_conf();
-- ë˜ëŠ” ì¬ì‹œì‘
-- sudo systemctl restart postgresql
```

#### 32GB RAM ì‹œìŠ¤í…œ

```sql
ALTER SYSTEM SET shared_buffers = '8GB';
ALTER SYSTEM SET effective_cache_size = '24GB';
ALTER SYSTEM SET maintenance_work_mem = '2GB';
ALTER SYSTEM SET work_mem = '128MB';
ALTER SYSTEM SET max_parallel_workers_per_gather = 6;
```

#### 64GB RAM ì‹œìŠ¤í…œ

```sql
ALTER SYSTEM SET shared_buffers = '16GB';
ALTER SYSTEM SET effective_cache_size = '48GB';
ALTER SYSTEM SET maintenance_work_mem = '4GB';
ALTER SYSTEM SET work_mem = '256MB';
ALTER SYSTEM SET max_parallel_workers_per_gather = 8;
```

### WAL (Write-Ahead Logging) ìµœì í™”

ì¸ë±ìŠ¤ ë¹Œë“œ ì†ë„ë¥¼ í–¥ìƒì‹œí‚¤ê¸° ìœ„í•œ WAL ì„¤ì •ì…ë‹ˆë‹¤.

```sql
-- WAL íŒŒë¼ë¯¸í„° (ì“°ê¸° ì„±ëŠ¥ í–¥ìƒ)
ALTER SYSTEM SET wal_buffers = '16MB';
ALTER SYSTEM SET max_wal_size = '4GB';
ALTER SYSTEM SET min_wal_size = '1GB';
ALTER SYSTEM SET checkpoint_completion_target = 0.9;

-- ë™ì‹œ ì—°ê²° ì„¤ì •
ALTER SYSTEM SET max_connections = 200;
ALTER SYSTEM SET max_worker_processes = 8;
```

### Docker Compose ì„¤ì • ì˜ˆì‹œ

```yaml
services:
  postgres:
    image: pgvector/pgvector:pg16
    command:
      - postgres
      - -c shared_buffers=4GB
      - -c effective_cache_size=12GB
      - -c maintenance_work_mem=1GB
      - -c work_mem=64MB
      - -c wal_buffers=16MB
      - -c max_wal_size=4GB
      - -c max_parallel_workers_per_gather=4
    environment:
      POSTGRES_PASSWORD: postgres
    volumes:
      - pgdata:/var/lib/postgresql/data
```

---

## 2) ì¸ë±ìŠ¤ ìµœì í™”

### HNSW íŒŒë¼ë¯¸í„°

HNSW ì¸ë±ìŠ¤ì˜ ì„±ëŠ¥ì€ 3ê°€ì§€ íŒŒë¼ë¯¸í„°ë¡œ ì¡°ì •ë©ë‹ˆë‹¤.

| íŒŒë¼ë¯¸í„° | ê¸°ë³¸ê°’ | ë²”ìœ„ | ì˜í–¥ |
|----------|--------|------|------|
| `m` | 16 | 4~64 | ê·¸ë˜í”„ ì—°ê²° ìˆ˜ (ë†’ì„ìˆ˜ë¡ ì •í™•, ë©”ëª¨ë¦¬ ì¦ê°€) |
| `ef_construction` | 64 | 4~1000 | ì¸ë±ìŠ¤ ë¹Œë“œ í’ˆì§ˆ (ë†’ì„ìˆ˜ë¡ ì •í™•, ëŠë¦¼) |
| `ef_search` | 40 | 1~1000 | ê²€ìƒ‰ ë²”ìœ„ (ë†’ì„ìˆ˜ë¡ ì •í™•, ëŠë¦¼) |

### íŒŒë¼ë¯¸í„°ë³„ ìƒì„¸ ê°€ì´ë“œ

#### m (ê·¸ë˜í”„ ì—°ê²°ë„)

```sql
-- ì‘ì€ m (ë¹ ë¥¸ ë¹Œë“œ, ì ì€ ë©”ëª¨ë¦¬)
CREATE INDEX idx_embedding_m8 ON embeddings
USING hnsw (embedding vector_cosine_ops)
WITH (m = 8, ef_construction = 64);

-- ì¤‘ê°„ m (ê· í˜•) - ê¸°ë³¸ê°’ ì¶”ì²œ â­
CREATE INDEX idx_embedding_m16 ON embeddings
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- í° m (ê³ ì •ë°€, ëŠë¦° ë¹Œë“œ)
CREATE INDEX idx_embedding_m32 ON embeddings
USING hnsw (embedding vector_cosine_ops)
WITH (m = 32, ef_construction = 128);
```

**ì„ íƒ ê°€ì´ë“œ:**
- m = 8: ë¹ ë¥¸ í”„ë¡œí† íƒ€ì…, ë©”ëª¨ë¦¬ ì œì•½
- m = 16: **ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ìµœì ** (ê¸°ë³¸ê°’)
- m = 32: ìµœê³  ì •í™•ë„ í•„ìš”, ë©”ëª¨ë¦¬ ì—¬ìœ 

#### ef_construction (ë¹Œë“œ í’ˆì§ˆ)

```sql
-- ë¹ ë¥¸ ë¹Œë“œ (ì •í™•ë„ ë‹¤ì†Œ í¬ìƒ)
CREATE INDEX idx_fast_build ON embeddings
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 32);

-- ê· í˜• ë¹Œë“œ (ê¶Œì¥)
CREATE INDEX idx_balanced_build ON embeddings
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- ê³ í’ˆì§ˆ ë¹Œë“œ (ëŠë¦¬ì§€ë§Œ ì •í™•)
CREATE INDEX idx_quality_build ON embeddings
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 200);
```

**ì„ íƒ ê°€ì´ë“œ:**
- ef_construction = 32: ê°œë°œ/í…ŒìŠ¤íŠ¸ í™˜ê²½
- ef_construction = 64: **í”„ë¡œë•ì…˜ ê¸°ë³¸ê°’** â­
- ef_construction = 200: ìµœê³  í’ˆì§ˆ ì¸ë±ìŠ¤

#### ef_search (ê²€ìƒ‰ ë²”ìœ„)

ê²€ìƒ‰ ì‹œì ì— ë™ì ìœ¼ë¡œ ì„¤ì • ê°€ëŠ¥í•œ íŒŒë¼ë¯¸í„°ì…ë‹ˆë‹¤.

```sql
-- ë¹ ë¥¸ ê²€ìƒ‰ (Recall 90%)
SET hnsw.ef_search = 40;

-- ê· í˜• ê²€ìƒ‰ (Recall 95%)
SET hnsw.ef_search = 100;

-- ì •ë°€ ê²€ìƒ‰ (Recall 99%)
SET hnsw.ef_search = 200;

-- ê²€ìƒ‰ ì‹¤í–‰
SELECT id, content
FROM embeddings
ORDER BY embedding <=> '[...]'::vector(768)
LIMIT 10;
```

**ì„ íƒ ê°€ì´ë“œ:**
- ef_search = 40: ë¹ ë¥¸ ì‘ë‹µ (0.01ì´ˆ)
- ef_search = 100: **í”„ë¡œë•ì…˜ ê¸°ë³¸ê°’** (0.02ì´ˆ) â­
- ef_search = 200: ê³ ì •ë°€ (0.04ì´ˆ)

### ì‹¤ì „ íŒŒë¼ë¯¸í„° ì¡°í•©

#### ì‹œë‚˜ë¦¬ì˜¤ 1: ë¹ ë¥¸ í”„ë¡œí† íƒ€ì…

```sql
-- ë¹ ë¥¸ ì¸ë±ìŠ¤ ë¹Œë“œ + ë¹ ë¥¸ ê²€ìƒ‰
CREATE INDEX idx_prototype ON embeddings
USING hnsw (embedding vector_cosine_ops)
WITH (m = 8, ef_construction = 32);

SET hnsw.ef_search = 40;
```

#### ì‹œë‚˜ë¦¬ì˜¤ 2: í”„ë¡œë•ì…˜ ê· í˜• (ê¶Œì¥) â­

```sql
-- ê· í˜•ì¡íŒ í’ˆì§ˆ + ì„±ëŠ¥
CREATE INDEX idx_production ON embeddings
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

SET hnsw.ef_search = 100;
```

#### ì‹œë‚˜ë¦¬ì˜¤ 3: ìµœê³  í’ˆì§ˆ

```sql
-- ìµœê³  ì •í™•ë„, ì†ë„ í¬ìƒ
CREATE INDEX idx_quality ON embeddings
USING hnsw (embedding vector_cosine_ops)
WITH (m = 32, ef_construction = 200);

SET hnsw.ef_search = 200;
```

### IVFFlat íŒŒë¼ë¯¸í„°

HNSWê°€ ë©”ëª¨ë¦¬ë¥¼ ë„ˆë¬´ ë§ì´ ì‚¬ìš©í•˜ëŠ” ê²½ìš° IVFFlatì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

```sql
-- lists (í´ëŸ¬ìŠ¤í„° ìˆ˜)
-- ë°ì´í„° í–‰ ìˆ˜ì˜ sqrt ì •ë„ ê¶Œì¥

-- 10ë§Œ í–‰: lists = 316 (sqrt(100,000))
CREATE INDEX idx_ivf_100k ON embeddings
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 316);

-- 100ë§Œ í–‰: lists = 1000
CREATE INDEX idx_ivf_1m ON embeddings
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 1000);

-- probes (ê²€ìƒ‰í•  í´ëŸ¬ìŠ¤í„° ìˆ˜)
SET ivfflat.probes = 10;  -- listsì˜ 1~10%
```

---

## 3) ê²€ìƒ‰ ìµœì í™”

### ef_search ë™ì  ì¡°ì •

ìš”ì²­ë³„ë¡œ ì •í™•ë„ì™€ ì†ë„ë¥¼ ì¡°ì ˆí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```python
import psycopg2

def adaptive_search(query_vec, priority='balanced'):
    """
    ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ef_search ì¡°ì •
    
    priority:
        - 'fast': ë¹ ë¥¸ ì‘ë‹µ (Recall 90%)
        - 'balanced': ê· í˜• (Recall 95%)
        - 'accurate': ì •í™•ë„ ìš°ì„  (Recall 99%)
    """
    ef_search_map = {
        'fast': 40,
        'balanced': 100,
        'accurate': 200
    }
    
    conn = psycopg2.connect(...)
    cur = conn.cursor()
    
    # ef_search ì„¤ì •
    cur.execute(f"SET hnsw.ef_search = {ef_search_map[priority]}")
    
    # ê²€ìƒ‰ ì‹¤í–‰
    cur.execute("""
        SELECT id, content, embedding <=> %s::vector(768) AS distance
        FROM embeddings
        ORDER BY distance
        LIMIT 10
    """, (query_vec,))
    
    results = cur.fetchall()
    cur.close()
    conn.close()
    
    return results

# ì‚¬ìš©
# ì¼ë°˜ ê²€ìƒ‰ (ë¹ ë¦„)
results = adaptive_search(query_vec, priority='fast')

# ì¤‘ìš”í•œ ê²€ìƒ‰ (ì •í™•í•¨)
results = adaptive_search(query_vec, priority='accurate')
```

### ë³‘ë ¬ ê²€ìƒ‰

PostgreSQLì˜ ë³‘ë ¬ ì¿¼ë¦¬ ê¸°ëŠ¥ì„ í™œìš©í•©ë‹ˆë‹¤.

```sql
-- ë³‘ë ¬ ì›Œì»¤ í™œì„±í™”
SET max_parallel_workers_per_gather = 4;

-- ë³‘ë ¬ ê²€ìƒ‰ ì‹¤í–‰
EXPLAIN (ANALYZE, BUFFERS)
SELECT id, content
FROM embeddings
ORDER BY embedding <=> '[...]'::vector(768)
LIMIT 10;

-- ì¶œë ¥ ì˜ˆì‹œ:
-- Gather Merge  (actual time=15.2..18.5 rows=10)
--   Workers Planned: 4
--   Workers Launched: 4
--   -> Parallel Index Scan using idx_embedding...
```

### í•„í„°ë§ ìµœì í™”

ë²¡í„° ê²€ìƒ‰ì— í•„í„°ë¥¼ ì¶”ê°€í•  ë•ŒëŠ” ì¸ë±ìŠ¤ ìˆœì„œê°€ ì¤‘ìš”í•©ë‹ˆë‹¤.

```sql
-- âŒ ë¹„íš¨ìœ¨ì : ë²¡í„° ê²€ìƒ‰ í›„ í•„í„°ë§
SELECT id, content
FROM embeddings
WHERE category = 'AI'  -- ë²¡í„° ê²€ìƒ‰ í›„ í•„í„°ë§
ORDER BY embedding <=> '[...]'::vector(768)
LIMIT 10;

-- âœ… íš¨ìœ¨ì : í•„í„° ì¸ë±ìŠ¤ + ë²¡í„° ê²€ìƒ‰
CREATE INDEX idx_category ON embeddings (category);

-- Partial Index í™œìš©
CREATE INDEX idx_ai_embedding ON embeddings
USING hnsw (embedding vector_cosine_ops)
WHERE category = 'AI';

-- ê²€ìƒ‰
SELECT id, content
FROM embeddings
WHERE category = 'AI'
ORDER BY embedding <=> '[...]'::vector(768)
LIMIT 10;
```

---

## 4) EXPLAIN ANALYZE ë¶„ì„

### ê¸°ë³¸ ì‚¬ìš©ë²•

```sql
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT id, content, embedding <=> '[...]'::vector(768) AS distance
FROM embeddings
ORDER BY distance
LIMIT 10;
```

### ì¶œë ¥ í•´ì„

#### ì¢‹ì€ ì˜ˆ (ì¸ë±ìŠ¤ ìŠ¤ìº”)

```
Index Scan using idx_embedding_hnsw on embeddings
  (cost=0.00..123.45 rows=10 width=805)
  (actual time=0.234..0.567 rows=10 loops=1)
  Order By: (embedding <=> '[...]'::vector(768))
  Buffers: shared hit=45
Planning Time: 0.123 ms
Execution Time: 0.789 ms
```

**ë¶„ì„:**
- âœ… `Index Scan`: HNSW ì¸ë±ìŠ¤ ì‚¬ìš©
- âœ… `actual time`: 0.567msë¡œ ë¹ ë¦„
- âœ… `Buffers shared hit`: ìºì‹œì—ì„œ ì½ìŒ (ë””ìŠ¤í¬ I/O ì—†ìŒ)

#### ë‚˜ìœ ì˜ˆ (ìˆœì°¨ ìŠ¤ìº”)

```
Seq Scan on embeddings
  (cost=0.00..50000.00 rows=10 width=805)
  (actual time=250.123..4567.890 rows=10 loops=1)
  Filter: ...
  Rows Removed by Filter: 999990
  Buffers: shared hit=10000 read=5000
Planning Time: 2.345 ms
Execution Time: 4570.234 ms
```

**ë¶„ì„:**
- âŒ `Seq Scan`: ì¸ë±ìŠ¤ ë¯¸ì‚¬ìš© (ì „ì²´ ìŠ¤ìº”)
- âŒ `actual time`: 4.5ì´ˆë¡œ ë§¤ìš° ëŠë¦¼
- âŒ `Rows Removed`: 100ë§Œ í–‰ ì¤‘ 10ê°œë§Œ ì‚¬ìš©
- âŒ `Buffers read`: ë””ìŠ¤í¬ì—ì„œ ì½ìŒ (ëŠë¦¼)

### ì¸ë±ìŠ¤ê°€ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ê²½ìš°

#### ì›ì¸ 1: ë°ì´í„° ë„ˆë¬´ ì ìŒ

```sql
-- 1000í–‰ ë¯¸ë§Œì´ë©´ ì¸ë±ìŠ¤ë³´ë‹¤ ìˆœì°¨ ìŠ¤ìº”ì´ ë¹ ë¥¼ ìˆ˜ ìˆìŒ
-- í•´ê²°: ë” ë§ì€ ë°ì´í„° ì‚½ì… ë˜ëŠ” ê°•ì œ ì¸ë±ìŠ¤ ìŠ¤ìº”

SET enable_seqscan = off;  -- í…ŒìŠ¤íŠ¸ìš©, í”„ë¡œë•ì…˜ì—ì„œëŠ” ì‚¬ìš© ê¸ˆì§€
```

#### ì›ì¸ 2: í†µê³„ ì •ë³´ ì˜¤ë˜ë¨

```sql
-- í†µê³„ ì—…ë°ì´íŠ¸
ANALYZE embeddings;

-- ë˜ëŠ” VACUUMê³¼ í•¨ê»˜
VACUUM ANALYZE embeddings;
```

#### ì›ì¸ 3: ì¸ë±ìŠ¤ ì†ìƒ

```sql
-- ì¸ë±ìŠ¤ ì¬ìƒì„±
REINDEX INDEX idx_embedding_hnsw;

-- ë˜ëŠ” DROP í›„ ì¬ìƒì„±
DROP INDEX idx_embedding_hnsw;
CREATE INDEX idx_embedding_hnsw ON embeddings
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);
```

---

## 5) pg_stat_statements ì‚¬ìš©

### í™•ì¥ ì„¤ì¹˜

```sql
-- pg_stat_statements í™œì„±í™”
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- postgresql.conf ì„¤ì •
-- shared_preload_libraries = 'pg_stat_statements'
-- ì¬ì‹œì‘ í•„ìš”
```

### ëŠë¦° ì¿¼ë¦¬ ë¶„ì„

```sql
-- ê°€ì¥ ëŠë¦° ì¿¼ë¦¬ Top 10
SELECT 
    query,
    calls,
    total_exec_time / 1000 AS total_time_sec,
    mean_exec_time / 1000 AS avg_time_sec,
    max_exec_time / 1000 AS max_time_sec
FROM pg_stat_statements
WHERE query LIKE '%<=>%'  -- ë²¡í„° ê²€ìƒ‰ ì¿¼ë¦¬ë§Œ
ORDER BY mean_exec_time DESC
LIMIT 10;

-- ì¶œë ¥ ì˜ˆì‹œ:
-- query                                    | calls | total_time_sec | avg_time_sec | max_time_sec
-- ----------------------------------------|-------|----------------|--------------|-------------
-- SELECT * FROM embeddings ORDER BY ...   | 1234  | 456.789        | 0.370        | 2.345
-- SELECT id FROM embeddings WHERE ...     | 5678  | 234.567        | 0.041        | 0.987
```

### ìºì‹œ íˆíŠ¸ìœ¨ í™•ì¸

```sql
SELECT 
    query,
    calls,
    shared_blks_hit,
    shared_blks_read,
    shared_blks_hit::float / 
        NULLIF(shared_blks_hit + shared_blks_read, 0) AS cache_hit_ratio
FROM pg_stat_statements
WHERE query LIKE '%<=>%'
ORDER BY calls DESC
LIMIT 10;

-- cache_hit_ratioê°€ 0.95 ì´ìƒì´ë©´ ì¢‹ìŒ (95% ìºì‹œ íˆíŠ¸)
-- 0.8 ë¯¸ë§Œì´ë©´ shared_buffers ì¦ê°€ ê³ ë ¤
```

### í†µê³„ ì´ˆê¸°í™”

```sql
-- í†µê³„ ë¦¬ì…‹ (ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì „)
SELECT pg_stat_statements_reset();
```

---

## 6) ëª¨ë‹ˆí„°ë§ ë° ë²¤ì¹˜ë§ˆí‚¹
### ì¸ë±ìŠ¤ í¬ê¸° ëª¨ë‹ˆí„°ë§

```sql
-- ì¸ë±ìŠ¤ í¬ê¸° í™•ì¸
SELECT
    schemaname,
    relname,
    indexrelname,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size,
    idx_scan AS index_scans,
    idx_tup_read AS tuples_read,
    idx_tup_fetch AS tuples_fetched
FROM pg_stat_user_indexes
WHERE relname = 'embeddings'
ORDER BY pg_relation_size(indexrelid) DESC;

-- ì¶œë ¥ ì˜ˆì‹œ:
-- indexrelname        | index_size | index_scans | tuples_read
-- --------------------|------------|-------------|-------------
-- idx_embedding_hnsw  | 2.3 GB     | 123456      | 1234560
-- idx_category        | 128 MB     | 98765       | 987650
```

### í…Œì´ë¸” í†µê³„

```sql
-- í…Œì´ë¸” í†µê³„ í™•ì¸
SELECT 
    relname AS table_name,
    n_tup_ins AS inserts,
    n_tup_upd AS updates,
    n_tup_del AS deletes,
    n_live_tup AS live_tuples,
    n_dead_tup AS dead_tuples,
    last_vacuum,
    last_autovacuum,
    last_analyze
FROM pg_stat_user_tables
WHERE relname = 'embeddings';

-- dead_tuplesê°€ ë§ìœ¼ë©´ VACUUM í•„ìš”
-- last_analyzeê°€ ì˜¤ë˜ë˜ë©´ ANALYZE í•„ìš”
```

---

## 7) ì‹¤ì „ ìµœì í™” ì‚¬ë¡€

### ì‚¬ë¡€ 1: ê²€ìƒ‰ ì†ë„ 10ë°° í–¥ìƒ

**ë¬¸ì œ:**
- 100ë§Œ ê°œ ë²¡í„° ê²€ìƒ‰ ì‹œ ì‘ë‹µ ì‹œê°„ 500ms
- ëª©í‘œ: 50ms ì´í•˜

**í•´ê²°:**

```sql
-- 1) PostgreSQL íŒŒë¼ë¯¸í„° ì¡°ì •
ALTER SYSTEM SET shared_buffers = '8GB';  -- ê¸°ì¡´ 2GB
ALTER SYSTEM SET effective_cache_size = '24GB';

-- 2) HNSW ì¸ë±ìŠ¤ ì¬ìƒì„±
DROP INDEX idx_embedding_old;
CREATE INDEX idx_embedding_new ON embeddings
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 128);  -- ê¸°ì¡´ ef_construction=64

-- 3) ef_search ì¡°ì •
SET hnsw.ef_search = 80;  -- ê¸°ì¡´ 200

-- 4) í†µê³„ ì—…ë°ì´íŠ¸
VACUUM ANALYZE embeddings;
```

**ê²°ê³¼:**
- ê²€ìƒ‰ ì‹œê°„: 500ms â†’ 45ms (11ë°° í–¥ìƒ)
- Recall@10: 95% â†’ 96% (ì •í™•ë„ ìœ ì§€)

### ì‚¬ë¡€ 2: ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ 50% ì ˆê°

**ë¬¸ì œ:**
- 500ë§Œ ê°œ ë²¡í„°, ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ 60GB
- ì„œë²„ RAM 32GBë¡œ ì œì•½

**í•´ê²°:**

```sql
-- 1) HNSW â†’ IVFFlat ë³€ê²½
DROP INDEX idx_hnsw;
CREATE INDEX idx_ivfflat ON embeddings
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 2236);  -- sqrt(5,000,000)

SET ivfflat.probes = 20;

-- 2) ì„œë¸Œë²¡í„° í™œìš©
CREATE INDEX idx_sub384 ON embeddings
USING hnsw ((embedding[1:384]) vector_cosine_ops)
WITH (m = 16, ef_construction = 64);
```

**ê²°ê³¼:**
- ë©”ëª¨ë¦¬: 60GB â†’ 28GB (53% ì ˆê°)
- ê²€ìƒ‰ ì‹œê°„: 35ms â†’ 55ms (1.6ë°° ëŠë ¤ì§)
- íŠ¸ë ˆì´ë“œì˜¤í”„ ìˆ˜ìš© ê°€ëŠ¥

---

## 8) ì„±ëŠ¥ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì¸ë±ìŠ¤ ë¹Œë“œ ì „

- [ ] shared_buffers â‰¥ RAMì˜ 25%
- [ ] maintenance_work_mem â‰¥ 1GB
- [ ] max_wal_size â‰¥ 4GB
- [ ] ë°ì´í„° ì‚½ì… ì™„ë£Œ
- [ ] ANALYZE ì‹¤í–‰

### ì¸ë±ìŠ¤ ë¹Œë“œ ì‹œ

- [ ] m = 16 (ë˜ëŠ” 8, 32)
- [ ] ef_construction = 64 (ë˜ëŠ” 128)
- [ ] ì¶©ë¶„í•œ ë””ìŠ¤í¬ ê³µê°„ (í…Œì´ë¸” í¬ê¸°ì˜ 30% ì´ìƒ)

### ê²€ìƒ‰ ìµœì í™”

- [ ] ef_search = 100 (ë˜ëŠ” 40, 200)
- [ ] EXPLAIN ANALYZEë¡œ ì¸ë±ìŠ¤ ì‚¬ìš© í™•ì¸
- [ ] ìºì‹œ íˆíŠ¸ìœ¨ > 95%
- [ ] ì‘ë‹µ ì‹œê°„ P95 < 100ms

### ì •ê¸° ìœ ì§€ë³´ìˆ˜

- [ ] ì£¼ 1íšŒ VACUUM ANALYZE
- [ ] ì›” 1íšŒ pg_stat_statements ë¶„ì„
- [ ] ë¶„ê¸° 1íšŒ ì¸ë±ìŠ¤ ì¬ìƒì„± ê²€í† 

---

## 9) ìš”ì•½

### í•µì‹¬ í¬ì¸íŠ¸

1. **PostgreSQL ë©”ëª¨ë¦¬ ì„¤ì •**  
   shared_buffers = RAMì˜ 25%, effective_cache_size = RAMì˜ 75%

2. **HNSW íŒŒë¼ë¯¸í„°**
    - m = 16 (ëŒ€ë¶€ë¶„ì˜ ê²½ìš°)
    - ef_construction = 64 (ê· í˜•), 128 (ê³ í’ˆì§ˆ)
    - ef_search = 100 (ê· í˜•), 40 (ë¹ ë¦„), 200 (ì •í™•)

3. **ì¸ë±ìŠ¤ ì„ íƒ**
    - HNSW: ë¹ ë¥¸ ê²€ìƒ‰, ë†’ì€ ì •í™•ë„, ë§ì€ ë©”ëª¨ë¦¬
    - IVFFlat: ì ì€ ë©”ëª¨ë¦¬, ëŠë¦° ê²€ìƒ‰

4. **ëª¨ë‹ˆí„°ë§ ë„êµ¬**
    - EXPLAIN ANALYZE: ì¿¼ë¦¬ ë¶„ì„
    - pg_stat_statements: ì„±ëŠ¥ í†µê³„
    - pg_stat_user_indexes: ì¸ë±ìŠ¤ ì‚¬ìš©ëŸ‰

5. **ìµœì í™” ìˆœì„œ**
    1. PostgreSQL íŒŒë¼ë¯¸í„° ì¡°ì •
    2. ì¸ë±ìŠ¤ íŒŒë¼ë¯¸í„° íŠœë‹
    3. ì¿¼ë¦¬ ìµœì í™”
    4. ì •ê¸° VACUUM/ANALYZE

---