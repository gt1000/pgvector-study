# 01. 설치 (Installation)

Docker를 이용한 설치 방법  
(PostgreSQL 18 + PostGIS 18-3.6 + pgvector 자동 컴파일 설치)
---

## 1) Docker Compose를 이용한 신규 설치

### ① 사전 고려사항

⚠️ **기본 설정 사용 금지**
- 기본 사용자(`postgres`), 기본 DB(`postgres`) 사용하지 않음. 해킹 사례 있음
- Connection Pooling 효율성을 위해 단일 DB 사용
- 스키마 분리로 데이터 격리
- `public`: 업무용 스키마
- `gis`: PostGIS 전용 스키마
- `vector`: pgvector 전용 스키마

⚠️ **PostgreSQL 18부터 데이터 경로 변경됨**
- 기존: `/var/lib/postgresql/data`
- PostgreSQL 18+: **`/var/lib/postgresql`**

### ② 디렉토리 구조

```text
01-installation/
├── docker-compose.yml
├── Dockerfile
├── init-sql.sh
└── database/
    ├── ddl
    |   └── policy.sql
    └── schema/
        └── schema.sql
```

### ③ docker-compose.yml

**파일:** [docker-compose.yml](./docker-compose.yml)  
PostgreSQL 18부터 VOLUME 경로가 `/var/lib/postgresql` 로 바뀌었음을 반영한다.

```yaml
version: '3.8'

services:
  postgres:
    build: .   # Dockerfile에서 PostGIS + pgvector 자동 빌드
    container_name: pgvector
    restart: always

    environment:
      POSTGRES_USER: study_postgres
      POSTGRES_PASSWORD: study_postgres
      POSTGRES_DB: study
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=C --lc-ctype=C"

    ports:
      - "35432:5432"

    volumes:
      # PostgreSQL 18+: 반드시 /var/lib/postgresql 로 마운트
      - D:\data\pgdata:/var/lib/postgresql
      - ./init-sql.sh:/docker-entrypoint-initdb.d/init-sql.sh:ro
      - ./database:/database:ro

    # PostgreSQL 성능 최적화 설정
    command: >
      postgres
      -c shared_buffers=4GB
      -c effective_cache_size=12GB
      -c maintenance_work_mem=1GB
      -c work_mem=64MB
      -c wal_buffers=16MB
      -c max_wal_size=4GB
      -c min_wal_size=1GB
```

**성능 설정 가이드 (시스템 메모리별):**  
 - 내 pc 의 경우 메모리 64G 이지만, 16G 설정을 해서 테스트 함

| 메모리 | shared_buffers | effective_cache_size | maintenance_work_mem | work_mem |
|--------|----------------|---------------------|---------------------|----------|
| 16GB | 4GB | 12GB | 1GB | 64MB |
| 32GB | 8GB | 24GB | 2GB | 128MB |
| 64GB | 16GB | 48GB | 4GB | 256MB |

**주요 설정 설명:**
- `shared_buffers`: 메모리의 1/8 (기본보다 보수적)
- `effective_cache_size`: 메모리의 약 1/2 ~ 3/4
- `maintenance_work_mem`: 인덱스 생성/VACUUM 작업용
- `work_mem`: 쿼리 정렬/해시 작업용
- `wal_buffers`: WAL 버퍼 (16MB 적정)
- `max_wal_size`: WAL 파일 최대 크기 (2GB)

### ④ Dockerfile

**파일:** [Dockerfile](./Dockerfile)

Docker 이미지 빌드 시 자동으로 pgvector를 컴파일하여 설치한다.

```dockerfile
FROM postgis/postgis:18-3.6

# 필요한 패키지 설치
RUN apt-get update && \
    apt-get install -y build-essential git postgresql-server-dev-18 && \
    rm -rf /var/lib/apt/lists/*

# pgvector 다운로드 및 설치
RUN git clone --branch v0.8.1 https://github.com/pgvector/pgvector.git /tmp/pgvector && \
    cd /tmp/pgvector && \
    make && make install && \
    rm -rf /tmp/pgvector

# 빌드 후 불필요한 패키지 제거
RUN apt-get remove -y build-essential git postgresql-server-dev-18 && apt-get autoremove -y
```

---

### ⑤ 초기화 스크립트

**파일:** [init-sql.sh](./init-sql.sh)  
컨테이너 최초 실행 시 스키마 및 DDL 자동 적용.

```bash
#!/bin/bash
set -e

echo "========================================="
echo "Database Initialization Started"
echo "========================================="

# 1. 스키마 생성
echo ""
echo ">>> Step 1: Creating schemas"
for file in /database/schema/*.sql; do
  if [ -f "$file" ]; then
    echo "Executing: $file"
    psql -U study_postgres -d study -a -f "$file"
  fi
done

# 2. DDL 실행
echo ""
echo ">>> Step 2: Executing DDL files"
for file in /database/ddl/*.sql; do
  if [ -f "$file" ]; then
    echo "Executing: $file"
    psql -U study_postgres -d study -a -f "$file"
  fi
done

echo ""
echo "========================================="
echo "Database Initialization Completed"
echo "========================================="
```

---

### 스키마 및 확장 자동 생성

**파일:** [database/schema/schema.sql](./database/schema/schema.sql)

```sql
-- ========================================
-- 스키마 생성 및 권한 설정
-- ========================================

-- PostGIS 스키마
CREATE SCHEMA IF NOT EXISTS gis;

-- pgvector 스키마  
CREATE SCHEMA IF NOT EXISTS vector;
-- pgvector extension 자동 생성
CREATE EXTENSION IF NOT EXISTS vector SCHEMA vector;
       
-- ========================================
-- 권한 설정
-- ========================================

-- gis 스키마 권한
GRANT ALL PRIVILEGES ON SCHEMA gis TO study_postgres;
ALTER DEFAULT PRIVILEGES IN SCHEMA gis GRANT ALL PRIVILEGES ON TABLES TO study_postgres;
ALTER DEFAULT PRIVILEGES IN SCHEMA gis GRANT ALL PRIVILEGES ON SEQUENCES TO study_postgres;
ALTER DEFAULT PRIVILEGES IN SCHEMA gis GRANT ALL PRIVILEGES ON FUNCTIONS TO study_postgres;

-- vector 스키마 권한
GRANT ALL PRIVILEGES ON SCHEMA vector TO study_postgres;
ALTER DEFAULT PRIVILEGES IN SCHEMA vector GRANT ALL PRIVILEGES ON TABLES TO study_postgres;
ALTER DEFAULT PRIVILEGES IN SCHEMA vector GRANT ALL PRIVILEGES ON SEQUENCES TO study_postgres;
ALTER DEFAULT PRIVILEGES IN SCHEMA vector GRANT ALL PRIVILEGES ON FUNCTIONS TO study_postgres;

-- ========================================
-- search_path 설정 (선택사항)
-- ========================================
-- ALTER DATABASE study SET search_path TO public, gis, vector;

COMMIT;
```

위처럼 `schema.sql` 안에 `CREATE EXTENSION IF NOT EXISTS vector SCHEMA vector;` 를 포함하면,  
컨테이너 최초 초기화 시점에 **pgvector extension이 자동으로 설치**된다.

### ⑥ 실행

#### a. 데이터 디렉토리 생성 (Windows)

```bash
mkdir D:\data\pgdata
```

> PostgreSQL 18+는 `/var/lib/postgresql` 경로를 사용하므로,  
> docker-compose에서 해당 경로에 볼륨을 마운트해야 한다.

#### b. init-sql.sh 실행 권한 (Linux/Mac)

```bash
chmod +x init-sql.sh
```

#### c. 컨테이너 빌드 + 실행

```bash
docker-compose up -d --build
```

#### d. 로그 확인

```bash
docker-compose logs -f postgres
```

### ⑦ 확인

#### a. pgadmin 툴을 사용하여 postgresql 에 접속

```sql
-- 벡터 타입 사용 테스트
CREATE TABLE vector.test_vectors (
  id   bigserial PRIMARY KEY,
  emb  vector(3)
);

INSERT INTO vector.test_vectors (emb)
VALUES ('[1, 0, 0]'),
       ('[0, 1, 0]'),
       ('[0, 0, 1]');

SELECT * FROM vector.test_vectors;
```

---