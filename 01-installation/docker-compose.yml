version: '3.8'

services:
  postgres:
    build: .  # Dockerfile에서 PostGIS + pgvector 빌드
    container_name: pgvector
    restart: always

    environment:
      POSTGRES_USER: study_postgres
      POSTGRES_PASSWORD: study_postgres
      POSTGRES_DB: study

      # 정렬/ctype은 C 로케일 유지 + UTF8 인코딩
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=C --lc-ctype=C"

      # 컨테이너 내부 시간/로케일 설정
      TZ: Asia/Seoul
      LANG: ko_KR.UTF-8
      LC_ALL: ko_KR.UTF-8

    ports:
      - "35432:5432"

    volumes:
      # PostgreSQL 18+: /var/lib/postgresql 전체를 마운트
      - D:\data\pgdata:/var/lib/postgresql
      - ./init-sql.sh:/docker-entrypoint-initdb.d/init-sql.sh:ro
      - ./database:/database:ro

    # PostgreSQL 성능 최적화 예시(메모리 32G 기준)
    command: >
      postgres
      -c shared_buffers=8GB
      -c effective_cache_size=24GB
      -c maintenance_work_mem=2GB
      -c work_mem=128MB
      -c wal_buffers=32MB
      -c max_wal_size=8GB
      -c min_wal_size=1GB
