# 01. 설치 (Installation)

Docker를 이용한 설치 방법  
(기존 PostgreSQL + PostGIS 환경에 pgvector 추가)
---

## 2) 기존 PostgreSQL + PostGIS 환경에 pgvector 추가

### ① 사전 고려사항

⚠️ **기존 환경 확인**
- 이미 PostgreSQL + PostGIS가 docker-compose로 실행 중
- 기존 데이터베이스와 데이터 보존 필요
- pgvector만 추가로 설치

⚠️ **주의사항**
- 기존 데이터 백업 권장
- PostGIS 스키마는 `public` 또는 `gis`에 유지
- pgvector는 `vector` 스키마로 분리


### ② Dockerfile 생성

**파일:** [Dockerfile](./Dockerfile)

기존 PostGIS 이미지에 pgvector를 추가로 설치합니다.

```dockerfile
# 기존 환경과 동일한 PostgreSQL + PostGIS 버전 사용
FROM postgis/postgis:18-3.6

# 필요한 패키지 설치
RUN apt-get update && \
    apt-get install -y build-essential git postgresql-server-dev-18 && \
    rm -rf /var/lib/apt/lists/*

# pgvector 다운로드 및 설치
RUN git clone --branch v0.8.1 https://github.com/pgvector/pgvector.git /tmp/pgvector && \
    cd /tmp/pgvector && \
    make && make install && \
    rm -rf /tmp/pgvector

# 빌드 후 불필요한 패키지 제거
RUN apt-get remove -y build-essential git postgresql-server-dev-18 && apt-get autoremove -y
```

**⚠️ 중요:** `FROM` 줄의 이미지 태그를 **기존 환경과 동일하게** 수정하세요.

### ③ docker-compose.yml 수정

신규 설치에서 누락 부분만 추가?


### ④ 디렉토리 구조

신규 설치와 동일

### ⑤ pgvector 추가 스크립트
schema.sql 에서 pgvector 부분만 참조

**⚠️ 주의:**
- `[사용자명]`, `[DB명]`을 실제 값으로 변경하세요.
- 기존 PostGIS가 `gis` 스키마가 아닌 `public`에 있다면 search_path 수정

### ⑥ pgvector 추가 설치 실행

#### a. 기존 컨테이너 중지

```bash
# 데이터는 volume에 보존됨
docker-compose down
```

#### b. 새 이미지 빌드

```bash
docker-compose build
```

#### c. 컨테이너 재시작

```bash
docker-compose up -d
```

#### d. 로그 확인

```bash
docker-compose logs -f postgres
```

**⚠️ 주의:**  
`/docker-entrypoint-initdb.d`는 **DB가 비어있을 때만 실행**됩니다.  
기존 DB가 있으면 자동 실행되지 않으므로 **수동 실행**이 필요합니다.

### ⑦ pgvector extension 수동 설치 (기존 DB인 경우)

기존 데이터베이스가 있는 경우, 초기화 스크립트가 실행되지 않으므로 수동으로 extension을 설치해야 합니다.

```bash
# DB 접속
docker-compose exec postgres psql -U [사용자명] -d [DB명]
```

PostgreSQL 셸에서 실행:

```sql
-- pgvector 스키마 생성
CREATE SCHEMA IF NOT EXISTS vector;

-- pgvector extension 설치
CREATE EXTENSION IF NOT EXISTS vector SCHEMA vector;

-- 권한 부여 (사용자명 수정)
GRANT ALL PRIVILEGES ON SCHEMA vector TO [사용자명];
ALTER DEFAULT PRIVILEGES IN SCHEMA vector GRANT ALL PRIVILEGES ON TABLES TO [사용자명];
ALTER DEFAULT PRIVILEGES IN SCHEMA vector GRANT ALL PRIVILEGES ON SEQUENCES TO [사용자명];
ALTER DEFAULT PRIVILEGES IN SCHEMA vector GRANT ALL PRIVILEGES ON FUNCTIONS TO [사용자명];

-- search_path 업데이트 (DB명 수정)
ALTER DATABASE [DB명] SET search_path TO public, gis, vector;

-- 확인
\dx
\dn

-- 종료
\q
```

### ⑧ 설치 확인

#### a. 테스트 테이블 생성

```sql
-- vector 스키마에 테스트 테이블 생성
CREATE TABLE vector.test_embeddings (
    id BIGSERIAL PRIMARY KEY,
    content TEXT,
    embedding vector(1536)
);

-- 데이터 삽입
INSERT INTO vector.test_embeddings (content, embedding)
VALUES ('test', array_fill(0.1, ARRAY[1536])::vector);

-- 조회
SELECT id, content FROM vector.test_embeddings;

-- PostGIS 기능도 정상 작동 확인
SELECT PostGIS_Version();
```

**해결:** Dockerfile 빌드가 제대로 되지 않은 경우
```bash
docker-compose build --no-cache
docker-compose up -d
```

**해결:**
1. 기존 docker-compose.yml의 volumes 설정 확인
2. PostgreSQL 18은 `/var/lib/postgresql` 사용
3. 이전 버전은 `/var/lib/postgresql/data` 사용

**해결:** 권한 오류

```sql
-- 권한 재설정
GRANT ALL PRIVILEGES ON SCHEMA vector TO [사용자명];
GRANT ALL ON ALL TABLES IN SCHEMA vector TO [사용자명];
ALTER DEFAULT PRIVILEGES IN SCHEMA vector GRANT ALL ON TABLES TO [사용자명];
```

---

## 주의사항 요약

1. ✅ **백업 필수**: 작업 전 데이터베이스 백업
2. ✅ **버전 확인**: Dockerfile의 이미지 태그를 기존과 동일하게
3. ✅ **볼륨 경로**: 기존 데이터 경로 정확히 유지
4. ✅ **수동 설치**: 기존 DB에는 extension 수동 설치 필요
5. ✅ **사용자명/DB명**: SQL 스크립트의 변수 치환

---